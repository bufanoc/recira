/* Copyright (c) 2008, 2009, 2010 Nicira, Inc. */

if(!dojo._hasResource["nox.ext.apps.commonui.coreui.ItemInspector"]){dojo._hasResource["nox.ext.apps.commonui.coreui.ItemInspector"]=true;dojo.provide("nox.ext.apps.commonui.coreui.ItemInspector");dojo.require("dijit._Widget");dojo.require("dijit._Templated");dojo.require("dojox.dtl._Templated");dojo.require("nox.ext.apps.commonui.coreui.base");dojo.declare("nox.ext.apps.commonui.coreui.ItemInspector",[dijit._Widget,dojox.dtl._Templated],{templateString:"<!--{% load dojox.dtl.contrib.dijit %}-->\n<table class=\"item-inspector\" dojoAttachPoint=\"table\">\n<!--{% for m in model %}-->\n<!--{% if m.separator %}-->\n\t<tr>\n\t\t<td class=\"item-inspector-separator item-inspector-label {{ m.name }}\" colspan=\"2\">{% if m.header %}{{ m.header }}{% endif %}</td>\n\t</tr>\n<!--{% else %}-->\n\t<tr>\n\t\t<td class=\"item-inspector-label\">{{ m.header }}:</td>\n\t\t<td class=\"{{ m.name }} item-inspector-value{% if m.editable or m.editAttr or m.editorProps %} item-inspector-editable{% endif %}{% if m.dialogEditor %} item-inspector-editable-dialog{% endif %}\"><span class=\"item-inspector-value-wrapper\">?</span><!--{% if m.editable or m.editAttr or m.editorProps %}--><img src=\"{{ editIconPath }}\"class=\"item-inspector-edit-icon\" style=\"visibility: hidden;\" /><!--{% endif %}--></td>\n\t</tr>\n<!--{% endif %}-->\n<!--{% endfor %}-->\n</table>\n",editIconPath:dojo.moduleUrl("nox.ext.apps.commonui.coreui","images/editIndicator.png"),widgetsInTemplate:false,item:null,model:null,ignoreNullValues:false,constructor:function(){this._initialized=false;this._editValue=null;this._editRow=null;this._editor=null;},_get_value:function(_1){if(_1.get!=null){var _2=_1.get(this.item);}else{if(_1.attr!=null&&_1.attr!=""){_2=this.item.getValue(_1.attr);}else{_2=null;}}if(typeof (_2)=="function"){_2=_2.call(this.item);}if(_2==null){_2=document.createTextNode((this.ignoreNullValues)?"":"?");}else{if(typeof (_2)=="string"){_2=document.createTextNode(_2);}else{if(typeof (_2)=="number"){_2=document.createTextNode(String(_2));}}}return _2;},_get_edit_value:function(_3){if(_3.getEdit!=null){var _4=_3.getEdit(this.item);}else{if(_3.editAttr!=null&&_3.editAttr!=""){_4=this.item.getValue(_3.editAttr);}else{if(_3.get!=null){_4=_3.get(this.item);}else{if(_3.attr!=null&&_3.attr!=""){_4=this.item.getValue(_3.attr);}else{_4=null;}}}}if(typeof (_4)=="function"){_4=_4.call(this.item);}return _4;},_set_value:function(_5,v){if(_5.editSet!=null){_5.editSet(this.item,v);}else{if(_5.editAttr!=null&&_5.editAttr!=""){this.item.setValue(_5.editAttr,v);}else{if(_5.attr!=null&&_5.attr!=""){this.item.setValue(_5.attr,v);}}}},_get_row_value:function(i){return this.table.rows[i].cells[1].childNodes[0];},_set_row_value:function(i,v){this.table.rows[i].cells[1].replaceChild(v,this._get_row_value(i));},_update_row:function(i){var m=this.model[i];if(!m){return;}if(m.separator==null||m.separator!=true){if(this._initialized&&m.noupdate==true){return;}var _c=document.createElement("span");dojo.addClass(_c,"item-inspector-value-wrapper");_c.appendChild(this._get_value(m));var _d=this._get_row_value(i);if(!nox.ext.apps.commonui.coreui.base.equivDomTrees(_d,_c)){this._set_row_value(i,_c);if(this.changeAnimFn!=null){this.changeAnimFn(_c.parentNode).play();}}}},update:function(){for(var i=0;i<this.model.length;i++){if(this._editRow!=i){this._update_row(i);}}},_destroy_editor:function(){if(this._editRow==null){return;}this.table.rows[this._editRow].cells[1].tabIndex=0;this._editRow=null;this._editValue=null;var e=this._editor;this._editor=null;},_edit_cancel:function(_10){if(this._editRow==null){return;}this._set_row_value(this._editRow,this._editValue);this._update_row(this._editRow);if(!_10){this._destroy_editor();}},_edit_change:function(_11){if(this._editRow==null){return;}if(this._editor.isValid==undefined||(this._editor.isValid&&this._editor.isValid())){this._set_row_value(this._editRow,this._editValue);this._set_value(this.model[this._editRow],this._editor.getValue());this._update_row(this._editRow);if(!_11){this._destroy_editor();}}else{this._edit_cancel(_11);}},_edit_keypress:function(_12){switch(_12.keyCode){case dojo.keys.ESCAPE:this._edit_cancel();break;case dojo.keys.ENTER:this._edit_change();break;}},_edit_common:function(_13){var _14=_13.target;while(_14&&_14.tagName&&_14.tagName.toLowerCase()!="td"&&!dojo.hasClass(_14,"item-inspector-value")){_14=_14.parentNode;}_14.tabIndex=-1;var i=_14.parentNode.rowIndex;if(this._editRow!=null&&i!=this._editRow){this._edit_cancel();}this._editRow=i;this._editValue=this._get_row_value(i);return i;},_edit_start:function(_16){var i=this._edit_common(_16);this._editor=new this.model[i].editor(this.model[i].editorProps);var val=this._get_edit_value(this.model[i])||"";this._editor.setDisplayedValue(val);dojo.connect(this._editor,"onBlur",this,"_edit_cancel");dojo.connect(this._editor.domNode,"onkeypress",this,"_edit_keypress");this._set_row_value(i,this._editor.domNode);this._editor.focus();},_edit_dialog_start:function(_19){var i=this._edit_common(_19);var _1b=this.model[i].editor;if(_1b){this._editor=new _1b(this.model[i].editorProps);}else{this._editor=new dijit.Dialog(this.model[i].editorProps);}this._editor.show();dojo.connect(this._editor,"onCancel",dojo.hitch(this,"_edit_cancel",true));dojo.connect(this._editor,"onExecute",dojo.hitch(this,"_edit_apply",true));dojo.connect(this._editor._fadeOut,"onEnd",this,"_destroy_editor");},postCreate:function(){this.inherited(arguments);dojo.query("td.item-inspector-editable",this.table).forEach(function(_1c){if(!dojo.hasClass(_1c,"item-inspector-editable-dialog")){var _1d,_1e=false;this.connect(_1c,"onmousedown",(function(){return function(e){clearTimeout(_1d);if(_1e){dojo.stopEvent(e);this._edit_start(e);}_1e=true;_1d=setTimeout(function(){_1e=false;},500);};})());this.connect(_1c,"onfocus",function(e){if(!_1e){this._edit_start(e);}});this.connect(_1c,"onkeypress",function(e){if(e.keyCode==dojo.keys.ENTER&&this._editRow!=null){this._edit_start(e);}});var _22=dojo.query("img.item-inspector-edit-icon",_1c)[0];this.connect(_22,"onclick","_edit_start");}else{var _22=dojo.query("img.item-inspector-edit-icon",_1c)[0];this.connect(_22,"onclick","_edit_dialog_start");}},this);this.update();this._initialized=true;}});}