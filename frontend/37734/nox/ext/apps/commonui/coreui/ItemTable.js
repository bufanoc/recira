/* Copyright (c) 2008, 2009, 2010 Nicira, Inc. */

if(!dojo._hasResource["nox.ext.apps.commonui.coreui.ItemTable"]){dojo._hasResource["nox.ext.apps.commonui.coreui.ItemTable"]=true;dojo.provide("nox.ext.apps.commonui.coreui.ItemTable");dojo.require("dijit._Widget");dojo.require("dijit._Templated");dojo.require("dijit.Menu");dojo.require("nox.ext.apps.commonui.coreui.base");dojo.require("nox.ext.apps.commonui.coreui._ItemSort");dojo.declare("nox.ext.apps.commonui.coreui.ItemTable",[dijit._Widget,dijit._Templated,nox.ext.apps.commonui.coreui._ItemSort],{templateString:"<table class=\"item-table\"><thead><tr dojoAttachPoint=\"headerrow\" class=\"headerRow\"></tr></thead><tbody dojoAttachPoint=\"itemrows\" class=\"itemRows\"></tbody></table>\n",widgetsInTemplate:false,store:null,model:null,ignoreNull:false,changeAnimFn:null,contextMenu:null,displayValidity:false,editAllowed:null,constructor:function(_1){this.id_base=dijit.getUniqueId("ItemTable");this._editCell=null;this._editInfo=null;this._editItem=null;this._editor=null;this._editValue=null;this._mouse2down=false;this._menus={};},_get_item_id:function(_2){return this.id_base+"-"+this.store.getIdentity(_2);},_get_cell_id:function(_3,_4){return this._get_item_id(_3)+"-"+_4;},_get_item_dom_node:function(_5){return dojo.byId(this._get_item_id(_5));},_get_dom_node_item:function(_6){return this.store.fetchItemByIdentity(_6.id.substr(this.id_base.length+1));},_get_num_item_dom_nodes:function(){return this.itemrows.rows.length;},_get_item_dom_node_idx:function(_7){return this.itemrows.rows[_7];},_get_store:function(){return this.store;},_item_column_value:function(_8,_9){if(_9.get!=null){var _a=_9.get(_8);}else{if(_9.attr!=null&&_9.attr!=""){_a=this.store.getValue(_8,_9.attr,null);}else{_a=null;}}return _a;},_value_domtree:function(_b){if(_b==null){_b=document.createTextNode((this.ignoreNull)?"":"-");}else{if(typeof (_b)=="string"||typeof (_b)=="number"){_b=document.createTextNode(_b.toString());}}var s=document.createElement("span");dojo.addClass(s,"item-table-value-wrapper");s.appendChild(_b);return s;},_get_edit_value:function(){if(this._editInfo.getEdit!=null){var _d=this._editInfo.getEdit(this._editItem);}else{if(this._editInfo.editAttr!=null&&this._editInfo.editAttr!=""){_d=this.store.getValue(this._editItem,this._editInfo.editAttr);}else{if(this._editInfo.get!=null){_d=this._editInfo.get(this._editItem);}else{if(this._editInfo.attr!=null&&this._editInfo.attr!=""){_d=this.store.getValue(this._editItem,this._editInfo.attr);}else{_d=null;}}}}if(typeof (_d)=="function"){_d=_d.call(this._editItem);}return _d;},_set_value:function(_e,_f,_10){if(_e.editSet!=null){_e.editSet(_f,_10);}else{if(_e.editAttr!=null&&_e.editAttr!=""){this.store.setValue(_f,_e.editAttr,_10);}else{if(_e.attr!=null&&_e.attr!=""){this.store.setValue(_f,_e.attr,_10);}}}},_destroy_editor:function(){if(this._editCell==null){return;}this._editCell.tabIndex=0;this._editInfo=null;this._editCell=null;this._editItem=null;this._editValue=null;this._editor=null;},_edit_cancel:function(){if(this._editCell==null){return;}this._editCell.replaceChild(this._editValue,this._editCell.childNodes[0]);this._destroy_editor();},_edit_change:function(){if(this._editCell==null){return;}if(typeof (this._editor.isValid)=="function"&&!this._editor.isValid()){return;}this._editCell.replaceChild(this._editValue,this._editCell.childNodes[0]);var _11=this._editInfo;var _12=this._editItem;var v=this._editor.getValue();this._destroy_editor();this._set_value(_11,_12,v);},_edit_keypress:function(_14){switch(_14.keyCode){case dojo.keys.ESCAPE:this._edit_cancel();break;case dojo.keys.ENTER:this._edit_change();break;}},_edit_start:function(_15){if(this._mouse2down){this._mouse2down=false;return;}if(this._editCell!=null){if(_15.currentTarget!=this._editCell){this._edit_cancel();}else{return;}}this._editCell=_15.currentTarget;this._editInfo=this.model[this._editCell.cellIndex];this._editItem=this._get_dom_node_item(this._editCell.parentNode);if(this._editInfo.editAllowed!=null){if(!this._editInfo.editAllowed.call(this,this._editItem)){this._editCell=null;this._editInfo=null;this._editItem=null;return;}}this._editCell.tabIndex=-1;this._editValue=this._editCell.childNodes[0];this._editor=new this._editInfo.editor(this._editInfo.editorProps);this._editor.setValue(this._get_edit_value());this._editor.focus();dojo.connect(this._editor,"onChange",this,"_edit_change");dojo.connect(this._editor,"onBlur",this,"_edit_cancel");dojo.connect(this._editor.domNode,"onkeypress",this,"_edit_keypress");this._editCell.replaceChild(this._editor.domNode,this._editCell.childNodes[0]);},_create_contextmenu:function(_16){var m=new dijit.Menu;if(_16!=null){var _18=this.store.getIdentity(_16);if(this._menus[_18]!=null){this._menus[_18].destroy();}this._menus[_18]=m;}dojo.forEach(this.contextMenu,function(_19){if(_16==null&&_19.includeOnHeader!=true){return;}var _1a=new dijit.MenuItem({label:_19.label});dojo.connect(_1a,"onClick",this,function(evt){_19.handler.call(this,_16);});m.addChild(_1a);},this);return m;},_display_validity:function(_1c,row){if(this.displayValidity==true){if(this.store.isValid(_1c)){dojo.removeClass(row,"item-table-invalid");}else{dojo.addClass(row,"item-table-invalid");}}},_onNewItem:function(_1e,_1f){var i=this.itemrows.rows.length;var n=this._node_to_insert_before(_1e);if(n!=null){i=n.sectionRowIndex;}var r=this.itemrows.insertRow(i);this._display_validity(_1e,r);r.id=this._get_item_id(_1e);if(this.contextMenu!=null){var m=this._create_contextmenu(_1e);m.bindDomNode(r);}dojo.addClass(r,"item-table-item-row");for(i=this.model.length;i>0;i--){var c=r.insertCell(0);var m=this.model[i-1];c.id=this._get_cell_id(_1e,m.name);dojo.addClass(c,m.name);var v=this._item_column_value(_1e,m);if(m.editor!=null){dojo.connect(c,"onclick",this,"_edit_start");dojo.connect(c,"onfocus",this,"_edit_start");dojo.connect(c,"onmousedown",this,function(e){if(e.button==2){this._mouse2down=true;}});}c.appendChild(this._value_domtree(v));if(((this.store.isDirty==null)||(!this.store.isDirty(_1e)))&&this.changeAnimFn!=null){this.changeAnimFn(c).play();}}},_onItemChange:function(_27,_28,_29,_2a){var r=this._get_item_dom_node(_27);if(r==null){return;}this._display_validity(_27,r);for(var i=0;i<this.model.length;i++){var m=this.model[i];var c=r.childNodes[i];if(this._editCell!=null&&c==this._editCell){continue;}var v=this._item_column_value(_27,m);var t=this._value_domtree(v);if(!nox.ext.apps.commonui.coreui.base.equivDomTrees(t,c.childNodes[0])){c.replaceChild(t,c.childNodes[0]);if(this.changeAnimFn!=null){this.changeAnimFn(c).play();}}}},_onDeleteItem:function(_31){var r=this._get_item_dom_node(_31);var _33=this.store.getIdentity(_31);if(this._menus[_33]!=null){var m=this._menus[_33];m.unBindDomNode(r);m.destroy();delete this._menus[_33];}r.parentNode.removeChild(r);},postCreate:function(){dojo.connect(this.store,"onNew",this,"_onNewItem");dojo.connect(this.store,"onSet",this,"_onItemChange");dojo.connect(this.store,"onDelete",this,"_onDeleteItem");if(this.header!=false){var m=this._create_contextmenu(null);m.bindDomNode(this.headerrow);for(var i=this.model.length;i>0;i--){var _37=this.headerrow.insertCell(0);_37.appendChild(document.createTextNode(this.model[i-1].header));}}this.store.fetch({query:{},onItem:dojo.hitch(this,"_onNewItem")});}});}