/* Copyright (c) 2008, 2009, 2010 Nicira, Inc. */

if(!dojo._hasResource["nox.ext.apps.commonui.coreui.NetworkStatusIndicator"]){dojo._hasResource["nox.ext.apps.commonui.coreui.NetworkStatusIndicator"]=true;dojo.provide("nox.ext.apps.commonui.coreui.NetworkStatusIndicator");dojo.require("dijit.layout.BorderContainer");dojo.require("dijit._Templated");dojo.require("dijit.layout.ContentPane");dojo.require("dijit.form.CheckBox");dojo.require("dojox.grid.DataGrid");dojo.require("dojo.data.ItemFileWriteStore");dojo.require("dojo.cookie");dojo.require("dijit.Dialog");dojo.declare("nox.ext.apps.commonui.coreui.NetworkStatusTooltip",dijit.TooltipDialog,{templateString:"<div waiRole=\"presentation\">\n\t<div class=\"dijitTooltipContainer\" waiRole=\"presentation\">\n\t\t<div dojoAttachPoint=\"titleBar\" class=\"dijitDialogTitleBar\">\n\t\t\t<span dojoAttachPoint=\"titleNode\" class=\"dijitDialogTitle\" id=\"${id}_title\">${title}</span>\n\t\t\t<span dojoAttachPoint=\"closeButtonNode\" class=\"dijitDialogCloseIcon\" dojoAttachEvent=\"onclick: _closeMe\" title=\"${buttonCancel}\">\n\t\t\t\t<span dojoAttachPoint=\"closeText\" class=\"closeText\" title=\"${buttonCancel}\">x</span>\n\t\t\t</span>\n\t\t</div>\n\t\t<div class =\"dijitTooltipContents dijitTooltipFocusNode\" dojoAttachPoint=\"containerNode\" tabindex=\"-1\" waiRole=\"dialog\"></div>\n\t</div>\n\t<div class=\"dijitTooltipConnector\" waiRole=\"presentation\"></div>\n</div>\n",title:"Network Status Changed",autofocus:false,open:false,buttonCancel:"Cancel",_fadeOutTimeout:null,postCreate:function(){this.inherited(arguments);dojo.addClass(this.domNode,"networkStatusTooltip");this._fadeOut=dojo.fadeOut({node:this.domNode,duration:dijit.defaultDuration,onEnd:dojo.hitch(this,"_closeMe")});this._fadeIn=dojo.fadeIn({node:this.domNode,duration:dijit.defaultDuration});},onOpen:function(){this.inherited(arguments);this.open=true;},onClose:function(){this.open=false;this.attr("content","");},addMessage:function(_1){var _2="<div class=\"message "+_1["status"]+"\">"+"<span>"+_1.item_ui_monitor_link_text+"<span> "+_1.message+"</span></span><br />"+"<span class=\"dateTime\">"+_1.dateTime+"</span>"+"</div>";if(this.open){clearTimeout(this._fadeOutTimeout);if(this._fadeOut.status()=="playing"){this._fadeOut.stop();this._fadeIn.play();}var _3=this.attr("content");this.attr("content",_2+_3);}else{this.attr("content",_2);}dijit.popup.open({parent:this.parentWidget,popup:this,around:this.aroundNode,orient:{"TL":"BL"}});var _4=this;this._fadeOutTimeout=setTimeout(function(){_4._fadeOut.play();},5000);},_closeMe:function(){clearTimeout(this._fadeOutTimeout);if(this._fadeOut.status()=="playing"){this._fadeOut.stop();}dijit.popup.close(this);dojo.style(this.domNode,"opacity",1);delete this._fadeOutTimeout;}});dojo.declare("nox.ext.apps.commonui.coreui.NetworkStatusIndicator",[dijit.layout.BorderContainer,dijit._Templated],{templateString:"<div dojoAttachPoint=\"containerNode\">\n\t<div dojoType=\"dijit.layout.ContentPane\" dojoAttachPoint=\"statusContainer\" region=\"top\" id=\"networkStatusType\">\n\t\t<table cellspacing=\"0\" class=\"networkStatusTitleBar\">\n\t\t\t<tr>\n\t\t\t\t<td class=\"collapseToggleContainer\" dojoAttachPoint=\"toggleContainer\" align=\"center\" dojoAttachEvent=\"onclick: onToggle\"><div class=\"collapseToggle\"></div></td>\n\t\t\t\t<td class=\"statusContainer\">Network Status: <span class=\"networkStatusTitle\" dojoAttachPoint=\"statusTextNode\">Good</span></td>\n\t\t\t</tr>\n\t\t</table>\n\t</div>\n\t<div dojoType=\"dijit.layout.ContentPane\" region=\"bottom\" id=\"statusMessageToggle\">\n\t\t<input dojoType=\"dijit.form.CheckBox\" dojoAttachPoint=\"notificationCheck\" dojoAttachEvent=\"onChange: onNotificationsToggle\" value=\"showAleft\" checked=\"true\" />\n\t\t<span>Show notification on status change</span>\n\t</div>\n</div>\n",widgetsInTemplate:true,splitter:true,minSize:28,maxSize:350,store:null,tooltip:null,"status":"normal",status_map:{normal:["Good","Normal"],minor:["Minor Issue","Minor"],major:["Serious Issue","Major"]},state:{defaultSize:150,expanded:true,showNotifications:true},constructor:function(){var _5={item_name:"Switch 0001",item_ui_monitor_link_text:"<a href=''>Switch 0001</a>",message:"cannot be reached. Error 40102","status":"major",solution:"Brief solution text",solution_link_text:"<a href=''>Action link here</a>",dateTime:null};var _6=[];for(var i=0;i<50;i++){var st="normal";var m=i%3;if(m==0){st="normal";}else{if(m==1){st="minor";}else{if(m==2){st="major";}}}_6.push(dojo.mixin(dojo.clone(_5),{"status":st}));_6[i].dateTime=(new Date()).toString();}this.store=new dojo.data.ItemFileWriteStore({data:{items:_6}});if(dojo.cookie.isSupported()){var _a=dojo.cookie("NOX_Network_Status_Indicator");if(_a){dojo.mixin(this.state,dojo.fromJson(_a));}}this._saveState();},postCreate:function(){this.inherited(arguments);var _b=this.messages=new dojox.grid.DataGrid({store:this.store,query:{},region:"center",selectionMode:"none",getSortProps:function(){return [{attribute:"dateTime",descending:true}];},structure:[{name:"message",width:"auto",get:function(_c,_d){if(!_d){return null;}var _e=_d.item_ui_monitor_link_text;var _f=_d.message;var _10=_d.dateTime;return "<div class=\"message "+_d["status"]+"\">"+"<span>"+_e+"<span> "+_f+"</span></span><br />"+"<span class=\"dateTime\">"+_10+"</span>"+"</div>";}}]});this.addChild(_b);_b.startup();var _11=this.gridTooltip=new dijit._MasterTooltip();dojo.addClass(this.gridTooltip.domNode,"networkStatusGridTooltip");var _12=[];var _13=[];var _14=this;var _15=[];var _16=function(_17){dojo.forEach(_15[_17],dojo.disconnect);_15[_17]=[];};var _18=function(_19,_1a,e){clearTimeout(_13[_19]);_13[_19]=null;};var _1c=function(_1d,_1e,e){_13[_1d]=setTimeout(function(){_11.hide(_1e);_13[_1d]=null;_16(_1d);},500);};var _20=function(e){if(_13[e.rowIndex]){clearTimeout(_13[e.rowIndex]);_13[e.rowIndex]=null;return;}var idx=e.rowIndex;var _23=_b.getItem(idx);var _24=_23.solution+"<br />"+_23.solution_link_text;_12[idx]=setTimeout(function(){_11.show(_24,e.cellNode,["above"]);if(!_15[idx]||!_15[idx].length){_15[idx]=[];_15[idx].push(dojo.connect(_11.domNode,"onmouseenter",dojo.partial(_18,idx,e.cellNode)));_15[idx].push(dojo.connect(_11.domNode,"onmouseleave",dojo.partial(_1c,idx,e.cellNode)));}},500);};var _25=function(e){clearTimeout(_12[e.rowIndex]);_13[e.rowIndex]=setTimeout(function(){_11.hide(e.cellNode);_13[e.rowIndex]=null;_16(e.rowIndex);},500);};this.connect(_b,"onCellMouseOver",_20);this.connect(_b,"onCellMouseOut",_25);this.connect(this.store,"onNew","onNewStatus");this.store.fetch({query:{},count:1,sort:[{attribute:"dateTime",descending:true}],onComplete:dojo.hitch(this,function(_27){var _28=_27[0];this.attr("status",_28["status"]);})});var _29=this.minSize;if(this.state.expanded){_29=this.state.defaultSize;}dojo.style(this.domNode,{height:_29+"px"});this._setExpandedClass();this.notificationCheck.attr("checked",this.state.showNotifications);},_saveState:function(){if(dojo.cookie.isSupported()){var _2a=dojo.toJson(this.state);if(dojo.cookie("NOX_Network_Status_Indicator")!=_2a){dojo.cookie("NOX_Network_Status_Indicator",dojo.toJson(this.state),{expires:365,path:"/"});}}},_setExpandedClass:function(){dojo.addClass(this.domNode,this.state.expanded?"open":"closed");dojo.removeClass(this.domNode,this.state.expanded?"closed":"open");},resize:function(){this.inherited(arguments);var _2b=dojo.marginBox(this.domNode).h;if(_2b>30){this.state.expanded=true;this.state.defaultSize=_2b;}else{this.state.expanded=false;}this._setExpandedClass();this._saveState();},onToggle:function(){if(this.state.expanded){this.state.defaultSize=dojo.marginBox(this.domNode).h;this.resize({h:this.minSize});}else{this.resize({h:this.state.defaultSize});}this.state.expanded=!this.state.expanded;this._setExpandedClass();this.getParent().resize();},onNotificationsToggle:function(){this.state.showNotifications=this.notificationCheck.attr("checked");this._saveState();},_setStatusAttr:function(st){if(!this.status_map[st]){var st="normal";}var _2d=this.status_map[st];var _2e=this.status_map[this["status"]];dojo.removeClass(this.statusContainer.domNode,"networkStatus"+_2e[1]);dojo.addClass(this.statusContainer.domNode,"networkStatus"+_2d[1]);this.statusTextNode.innerHTML=_2d[0];this["status"]=st;return st;},onNewStatus:function(_2f){this.attr("status",_2f["status"]);if(this.state.showNotifications&&!this.state.expanded&&_2f["status"]!="normal"){if(!this.tooltip){this.tooltip=new nox.ext.apps.commonui.coreui.NetworkStatusTooltip({title:"Network Status Changed",autofocus:false,parentWidget:this,aroundNode:this.toggleContainer});dijit.popup.prepare(this.tooltip.domNode);}this.tooltip.addMessage(_2f);}this.messages.render();}});}