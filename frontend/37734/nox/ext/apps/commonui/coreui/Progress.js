/* Copyright (c) 2008, 2009, 2010 Nicira, Inc. */

if(!dojo._hasResource["nox.ext.apps.commonui.coreui.Progress"]){dojo._hasResource["nox.ext.apps.commonui.coreui.Progress"]=true;dojo.provide("nox.ext.apps.commonui.coreui.Progress");dojo.require("dijit._Widget");dojo.require("dijit._Templated");dojo.require("dijit.Tooltip");dojo.require("dijit.ProgressBar");dojo.require("nox.ext.apps.commonui.coreui.UpdateMgr");dojo.require("nox.ext.apps.commonui.coreui.UpdateErrorHandler");dojo.require("dojo.i18n");dojo.requireLocalization("nox.ext.apps.commonui.coreui","Progress",null,"ROOT");dojo.declare("nox.ext.apps.commonui.coreui._Tooltip",dijit._MasterTooltip,{disabled:true,templateString:null,widgetsInTemplate:true,position:["below"],events:["onMouseOver","onMouseOut","onFocus","onBlur","onHover","onUnHover"],constructor:function(){this._tooltip_connects=[];},postMixInProperties:function(){var _1=dojo.i18n.getLocalization("nox.ext.apps.commonui.coreui","Progress");dojo.mixin(this,_1);this.inherited(arguments);},postCreate:function(){this.inherited(arguments);if(this.srcNodeRef){this.srcNodeRef.style.display="none";}this._connectNodes=[];if(!this.disabled){this._enable();}},show:function(_2,_3){if(this.aroundNode&&this.aroundNode===_2){return;}if(this.fadeOut.status()=="playing"){this._onDeck=arguments;return;}this.domNode.style.top=(this.domNode.offsetTop+1)+"px";var _4={};var _5=this.isLeftToRight();dojo.forEach((_3&&_3.length)?_3:dijit.Tooltip.defaultPosition,function(_6){switch(_6){case "after":_4[_5?"BR":"BL"]=_5?"BL":"BR";break;case "before":_4[_5?"BL":"BR"]=_5?"BR":"BL";break;case "below":_4[_5?"BL":"BR"]=_5?"TL":"TR";_4[_5?"BR":"BL"]=_5?"TR":"TL";break;case "above":default:_4[_5?"TL":"TR"]=_5?"BL":"BR";_4[_5?"TR":"TL"]=_5?"BR":"BL";break;}});var _7=dijit.placeOnScreenAroundElement(this.domNode,_2,_4,dojo.hitch(this,"orient"));dojo.style(this.domNode,"opacity",0);this.fadeIn.play();this.isShowingNow=true;this.aroundNode=_2;},disable:function(){if(this.disabled){return;}this.hide(this.aroundNode);dojo.forEach(this._tooltip_connects,function(_8){this.disconnect(_8);},this);this.disabled=true;},enable:function(){if(!this.disabled){return;}this._enable();},_enable:function(){dojo.forEach(this.connectId,function(id){var _a=dojo.byId(id);if(_a){this._connectNodes.push(_a);dojo.forEach(this.events,function(_b){this._tooltip_connects.push(this.connect(_a,_b.toLowerCase(),"_"+_b));},this);if(dojo.isIE){_a.style.zoom=1;}}},this);this.disabled=false;},_onMouseOver:function(e){this._onHover(e);},_onMouseOut:function(e){if(dojo.isDescendant(e.relatedTarget,e.target)){return;}this._onUnHover(e);},_onFocus:function(e){this._focus=true;this._onHover(e);this.inherited(arguments);},_onBlur:function(e){this._focus=false;this._onUnHover(e);this.inherited(arguments);},_onHover:function(e){if(!this._showTimer&&e){var _11=e.target;this._showTimer=setTimeout(dojo.hitch(this,function(){this.open(_11);}),this.showDelay);}},_onUnHover:function(e){if(this._focus){return;}if(this._showTimer){clearTimeout(this._showTimer);delete this._showTimer;}this.close();},open:function(_13){_13=_13||this._connectNodes[0];if(!_13){return;}if(this._showTimer){clearTimeout(this._showTimer);delete this._showTimer;}this.show(_13,this.position);this._connectNode=_13;},close:function(){this.hide(this._connectNode);delete this._connectNode;if(this._showTimer){clearTimeout(this._showTimer);delete this._showTimer;}},uninitialize:function(){this.close();},destroy:function(){this._tooltip_connects=null;}});dojo.declare("nox.ext.apps.commonui.coreui.ProgressTooltip",nox.ext.apps.commonui.coreui._Tooltip,{templateString:"<div class=\"dijitTooltip dijitTooltipLeft\" id=\"noxProgressTooltip\">\n\t<div class=\"dijitTooltipContainer dijitTooltipContents\" dojoAttachPoint=\"containerNode\" waiRole='alert'>\n\t\t<div class=\"loading\">\n\t\t\t<table cellspacing=\"0\" cellpadding=\"0\">\n\t\t\t\t<tr>\n\t\t\t\t\t<td><span class=\"progressMessage\">${loadingMessage}</span></td>\n\t\t\t\t\t<td><div class=\"progressBar\" style=\"width: 100px;\" dojoType=\"dijit.ProgressBar\" dojoAttachPoint=\"progress\"></div></td>\n\t\t\t\t</tr>\n\t\t\t</table>\n\t\t</div>\n\t</div>\n\t<div class=\"dijitTooltipConnector\"></div>\n</div>\n",setPercentage:function(pct){this.progress.update({progress:pct});}});dojo.declare("nox.ext.apps.commonui.coreui.ErrorTooltip",nox.ext.apps.commonui.coreui._Tooltip,{templateString:"<div class=\"dijitTooltip dijitTooltipLeft\" id=\"noxErrorTooltip\">\n  <div class=\"dijitTooltipContainer dijitTooltipContents\" \n       style=\"max-width: 300px\" dojoAttachPoint=\"containerNode\" waiRole='alert'>\n\t\t<div class=\"error\">\n\t\t\t<table cellspacing=\"0\" cellpadding=\"0\">\n\t\t\t\t<tr>\n          <td><h3><span class=\"errorHeader\" dojoAttachPoint=\"errorHeaderNode\"></span></h3></td>\n\t\t\t\t</tr>\n\t\t\t\t<tr>\n\t\t\t\t\t<td><span class=\"errorMessage\" dojoAttachPoint=\"errorNode\">${errorMessage}</span></td>\n\t\t\t\t</tr>\n\t\t\t\t<tr>\n          <td align=\"right\">\n          <button dojoType=\"dijit.form.Button\" dojoAttachPoint=\"retryButton\">${retryButtonText}</button>\n          <button dojoType=\"dijit.form.Button\" dojoAttachPoint=\"dismissButton\">${dismissButtonText}</button>\n        </td>\n\t\t\t\t</tr>\n\t\t\t</table>\n\t\t</div>\n\t</div>\n\t<div class=\"dijitTooltipConnector\"></div>\n</div>\n",events:["onMouseOver","onFocus","onHover"],setError:function(_15,_16){if(_15.length>300){_15=_15.substring(0,280)+" [message truncated]";}this.errorNode.innerHTML="";this.errorNode.appendChild(dojo.doc.createTextNode(_15));if(_16.header_msg){this.errorHeaderNode.innerHTML=_16.header_msg;}if(_16.hide_retry){dojo.style(this.retryButton.domNode,{display:"none"});}else{dojo.style(this.retryButton.domNode,{display:"inline"});}if(_16.hide_dismiss){dojo.style(this.dismissButton.domNode,{display:"none"});}else{dojo.style(this.dismissButton.domNode,{display:"inline"});}}});dojo.declare("nox.ext.apps.commonui.coreui.Progress",[dijit._Widget,dijit._Templated],{loadingImage:dojo.moduleUrl("nox.ext.apps.commonui.coreui","images/progress.gif"),templateString:"<div class='noxCoreuiProgress'><img src='${loadingImage.uri}' dojoAttachPoint='loadingNode' style='visibility: hidden;' class='noxCoreuiProgressSpinner'/></div>",constructor:function(){},postCreate:function(){this.inherited(arguments);this.tooltip=new nox.ext.apps.commonui.coreui.ProgressTooltip({connectId:[this.domNode],disabled:true});this.errorTooltip=new nox.ext.apps.commonui.coreui.ErrorTooltip({id:"noxErrorTooltip",connectId:[this.domNode],disabled:true});this.connect(this.errorTooltip.retryButton,"onClick","onRetry");this.connect(this.errorTooltip.dismissButton,"onClick","onDismissError");dojo.setSelectable(this.loadingNode,false);this.connect(this.domNode,"onclick","onRefresh");var u=nox.ext.apps.commonui.coreui.getUpdateMgr();this.connect(u,"onUpdateStart","onStart");if(u._updates_started){this.onStart();}this.connect(u,"onMakeRequest","onActivity");this.connect(u,"onUserFunctionCall","onActivity");this.connect(u,"onCountdownStart","onIdle");this.connect(u,"onResponseProcessingTick","onProcessingTick");this.connect(u,"onUpdateComplete","onComplete");this.connect(nox.ext.apps.commonui.coreui.UpdateErrorHandler,"onError","onError");},onStart:function(){dojo.style(this.domNode,"display","block");},onRefresh:function(){if(this._activity_started){return;}nox.ext.apps.commonui.coreui.getUpdateMgr().updateNow();},onRetry:function(){if(this._activity_started){return;}this._error=false;this.onIdle();nox.ext.apps.commonui.coreui.getUpdateMgr().retry_failed_request();},onIdle:function(){if(!this._error){dojo.style(this.loadingNode,"visibility","hidden");this._activity_started=false;dojo.style(this.domNode,"backgroundPosition","0px 0px");dojo.addClass(this.domNode,"noxCoreuiProgressCanRefresh");this.tooltip.disable();this.errorTooltip.disable();}},onComplete:function(){this.onIdle();dojo.style(this.domNode,"display","none");},onActivity:function(){if(!this._activity_started){this._error=false;this._activity_started=true;this.tooltip.setPercentage(0);dojo.style(this.domNode,"backgroundPosition","-26px 0px");dojo.removeClass(this.domNode,"noxCoreuiProgressCanRefresh");dojo.style(this.loadingNode,"visibility","visible");this.tooltip.enable();this.errorTooltip.disable();}},onError:function(_18,_19){if(_19==null){_19={};}this._error=true;this._activity_started=false;this.resume_on_dismiss=false;dojo.style(this.loadingNode,"visibility","hidden");this.errorTooltip.setError(_18,_19);dojo.style(this.domNode,"backgroundPosition","-52px 0px");dojo.removeClass(this.domNode,"noxCoreuiProgressCanRefresh");this.tooltip.disable();if(_19.validation_error!=null&&_19.validation_error==true){nox.ext.apps.commonui.coreui.getUpdateMgr().suspend();this.resume_on_dismiss=true;}this.errorTooltip.enable();if(_19.auto_show==null||_19.auto_show==true){this.errorTooltip.open(dojo.byId("progress"));}},onDismissError:function(){this._error=false;this.onIdle();if(this.resume_on_dismiss){nox.ext.apps.commonui.coreui.getUpdateMgr().resume();this.resume_on_dismiss=false;}else{nox.ext.apps.commonui.coreui.getUpdateMgr().skip_failed_request();}},onProcessingTick:function(_1a,_1b){this.tooltip.setPercentage(_1b);}});}