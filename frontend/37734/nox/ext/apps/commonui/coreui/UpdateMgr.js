/* Copyright (c) 2008, 2009, 2010 Nicira, Inc. */

if(!dojo._hasResource["nox.ext.apps.commonui.coreui.UpdateMgr"]){dojo._hasResource["nox.ext.apps.commonui.coreui.UpdateMgr"]=true;dojo.provide("nox.ext.apps.commonui.coreui.UpdateMgr");dojo.require("nox.ext.apps.commonui.coreui.UpdateErrorHandler");var corui=nox.ext.apps.commonui.coreui;dojo.declare("nox.ext.apps.commonui.coreui.UpdateMgr",[],{dojo_xhr_functions:{"GET":dojo.xhrGet,"PUT":dojo.rawXhrPut,"POST":dojo.rawXhrPost,"DELETE":dojo.xhrDelete},constructor:function(){this.recurrence_period=10;this._suspended=false;this._period_remaining=null;this._current_timeout=null;this._pending_updates=[];this._current_update=null;this._pending_processing=[];this._recurring_updates=[];this._mousemove_timeout=null;this._retry_pending=false;var o=this;this._countdown_timeout_handler=function(){o._handle_countdown_timeout();};this._processing_timeout_handler=function(){o._handle_processing_timeout();};this._suspend_timeout_handler=function(){o._make_request();o._setup_timeout();};this._mousemove_timeout_handler=function(){o._mousemove_timeout=null;o.resume();};this._suspend_on_mousemove_handler=function(){o.suspend();if(o._mousemove_timeout!=null){clearTimeout(o._mousemove_timeout);}o._mousemove_timeout=setTimeout(o._mousemove_timeout_handler,500);};},_call_user_fn:function(_2){if(typeof (_2.fn)!="function"){throw Error("Call update method must provide function to call in the fn parameter");}if(typeof (_2.purpose)!="string"){throw Error("Call update method must provide string describing reason for call in the purpose parameter");}var _3=_2.data;var _4=_2.scope;if(_4==null){_4=dojo.global;}var _5=_2.fn.call(_4,_3);_2.load.call(this,_5,_2);},_make_request:function(){if(this._current_update!=null||this._pending_updates.length==0){return;}if(this._current_timeout!=null){clearTimeout(this._current_timeout);this._current_timeout=null;}if(this._suspended==true){return;}this._period_remaining=null;this._current_update=this._pending_updates.shift();with(this._current_update){if(request_method!="USERFN"){if(args.url_fn!=null){args.url=args.url_fn();}this.onMakeRequest(request_method,args.url);}else{this.onUserFunctionCall(args.purpose);}this._current_update.request=xhr_fn.call(this,args);}},_handle_countdown_timeout:function(){if(this._current_timeout==null||this._period_remaining==null){return;}this._current_timeout=null;this.onCountdownTick(--this._period_remaining);if(this._period_remaining==0){this._period_remaining=null;for(var i=0;i<this._recurring_updates.length;i++){this._pending_updates.push(this._recurring_updates[i]);}this._make_request();}this._setup_timeout();},_handle_processing_timeout:function(){var _7=100;this._current_timeout=null;if(this._suspended==false){var l=this._pending_processing;this._pending_processing=[];for(var i=0;i<l.length;i++){var c=l[i].work.next_fn(l[i].work.state);if(c!=null){if(c.progress==null||c.progress<0||c.progress>100){throw Error("Long-running processing didn't set progress correctly");l[i].work=c;this._pending_processing.push(l[i]);}else{if(c.progress<100){l[i].work=c;this._pending_processing.push(l[i]);}}_7=Math.min(_7,c.progress);}}if(this._current_update==null&&this._pending_updates.length==0){this.onResponseProcessingTick(this._pending_processing,_7);}}this._setup_timeout();},_setup_timeout:function(){if(this._current_timeout!=null){clearTimeout(this._current_timeout);this._current_timeout=null;this._period_remaining=null;}if(this._pending_processing.length>0){this._current_timeout=setTimeout(this._processing_timeout_handler,1);}else{if(this._current_update!=null){return;}else{if(this._pending_updates.length>0){if(!this._suspended){this._make_request();return;}this._current_timeout=setTimeout(this._suspend_timeout_handler,100);}else{if(this._recurring_updates.length>0){if(this._period_remaining==null){this.onCountdownStart(this.recurrence_period);this._period_remaining=this.recurrence_period;}this._current_timeout=setTimeout(this._countdown_timeout_handler,1000);}else{this.onUpdateComplete();}}}}},_initial_response_processing:function(_b){if(_b.cb_fn!=null){return _b.cb_fn.call(null,_b.response,_b.ioArgs);}return null;},_check_response_processing_start:function(){if(this._pending_processing.length>0){if(this._current_update==null&&this._pending_updates.length==0){this.onResponseProcessingStart(this._pending_processing);}this._handle_processing_timeout();}},_handle_response_callback:function(_c,_d,_e){this._pending_processing.push({update:this._current_update,work:{progress:0,next_fn:this._initial_response_processing,state:{"cb_fn":_e,"response":_c,"ioArgs":_d}}});this._current_update=null;this._make_request();this._check_response_processing_start();},_handle_error_callback:function(_f,_10,_11){if(!_11.call(null,_f,_10)){this._pending_processing.push({update:this._current_update,work:{progress:0,next_fn:function(_12){return null;},state:{}}});this._current_update=null;this._make_request();this._check_response_processing_start();}else{this._retry_pending=true;}},_wrap_callbacks:function(_13){var o=this;var _15=_13.load;_13.load=function(rsp,_17){o._handle_response_callback(rsp,_17,_15);};var _18=_13.error;_13.error=function(rsp,_1a){o._handle_error_callback(rsp,_1a,_18);};return _13;},retry_failed_request:function(){if(!this._retry_pending){return;}this._retry_pending=false;this._pending_updates.unshift(this._current_update);this._current_update=null;this._make_request();this._check_response_processing_start();},skip_failed_request:function(){if(!this._retry_pending){return;}if(this._current_update.args.error!=undefined){this._current_update.args.error.call(null,{status:"user-dismissed-error"},this._current_update.args);}this._retry_pending=false;this._current_update=null;this._setup_timeout();},xhr:function(_1b,_1c){if(this._pending_updates.length==0&&this._pending_processing.length==0&&this._recurring_updates.length==0&&this._current_update==null){this.onUpdateStart();}var _1d=_1b.toUpperCase();if(_1d=="USERFN"){var fn=this._call_user_fn;}else{fn=this.dojo_xhr_functions[_1d];if(_1c.errorHandlers!=null){_1c.error=coreui.UpdateErrorHandler.create(null,_1c.errorHandlers);}if(_1c.error==null){console_log("FIXME: caller didn't install error handler for request: ",_1b," ",_1c);_1c.error=coreui.UpdateErrorHandler.create();}}if(fn==null){throw Error("Unknown update method");}var _1f={"request_method":_1b.toUpperCase(),"xhr_fn":fn,"args":this._wrap_callbacks(_1c),"cancel":dojo.hitch(this,function(){this.cancelUpdate(_1f);})};if(_1c.recur!=null&&_1c.recur==true){this._recurring_updates.push(_1f);}this._pending_updates.push(_1f);this._make_request();return _1f;},xhrGet:function(_20){return this.xhr("GET",_20);},rawXhrPut:function(_21){return this.xhr("PUT",_21);},rawXhrPost:function(_22){return this.xhr("POST",_22);},xhrDelete:function(_23){return this.xhr("DELETE",_23);},userFnCall:function(_24){return this.xhr("USERFN",_24);},cancelUpdate:function(_25){this._pending_updates=dojo.filter(this._pending_updates,function(i){return i!=_25;});this._recurring_updates=dojo.filter(this._recurring_updates,function(i){return i!=_25;});},cancelRecurring:function(){this._recurring_updates=[];},cancelPending:function(){if(this._current_update!=null){this._current_update.request.cancel();this._current_update=null;}this._pending_updates=[];},cancelProcessing:function(){this._pending_processing=[];},cancelAll:function(){this.cancelRecurring();this.cancelPending();this.cancelProcessing();},suspend:function(){if(this._suspended==false){this._suspended=true;this.onSuspend();}},resume:function(){if(this._suspended==true){this._suspended=false;this.onResume();}},suspendDuringMousemoveOn:function(e){dojo.connect(e,"mousemove",this,"_suspend_on_mousemove_handler");},updateNow:function(){if(this._period_remaining==null){if(this._pending_updates.length>0){return;}}if(this._current_timeout!=null){clearTimeout(this._current_timeout);}this._period_remaining=1;this._current_timeout=0;this._handle_countdown_timeout();},onUpdateStart:function(){},onUpdateComplete:function(){},onMakeRequest:function(_29,uri){},onUserFunctionCall:function(_2b){},onResponseProcessingStart:function(_2c){},onResponseProcessingTick:function(_2d,_2e){},onCountdownStart:function(_2f){},onCountdownTick:function(_30){},onSuspend:function(){},onResume:function(){},installDebugLogging:function(){dojo.connect(this,"onUpdateStart",function(){console_log("UpdateMgr: Starting update");});dojo.connect(this,"onUpdateComplete",function(){console_log("UpdateMgr: Update compeleted");});dojo.connect(this,"onMakeRequest",function(_31,uri){console_log("UpdateMgr: Making request: ",_31," ",uri);});dojo.connect(this,"onUserFunctionCall",function(_33){console_log("UpdateMgr: calling user function for ",_33);});dojo.connect(this,"onResponseProcessingStart",function(_34){console_log("UpdateMgr: Starting response processing on:",_34);});dojo.connect(this,"onResponseProcessingTick",function(_35,_36){console_log("UpdateMgr: Continuing response processing on: ",_35);console_log("UpdateMgr: minimum progress of processing jobs is: ",_36);});dojo.connect(this,"onCountdownStart",function(_37){console_log("UpdateMgr: Starting update delay countdown of ",_37," seconds");});dojo.connect(this,"onCountdownTick",function(_38){console_log("UpdateMgr: Counting down delay, ",_38," seconds remaining.");});dojo.connect(this,"onSuspend",function(){console_log("UpdateMgr: updates suspended");});dojo.connect(this,"onResume",function(){console_log("UpdateMgr: updates resumed");});}});(function(){var _39=null;nox.ext.apps.commonui.coreui.getUpdateMgr=function(){if(_39==null){_39=new nox.ext.apps.commonui.coreui.UpdateMgr();}return _39;};})();}