/* Copyright (c) 2008, 2009, 2010 Nicira, Inc. */

if(!dojo._hasResource["nox.ext.apps.commonui.coreui._UpdatingItem"]){dojo._hasResource["nox.ext.apps.commonui.coreui._UpdatingItem"]=true;dojo.provide("nox.ext.apps.commonui.coreui._UpdatingItem");dojo.require("nox.ext.apps.commonui.coreui.base");dojo.require("nox.ext.apps.commonui.coreui.UpdateMgr");dojo.declare("nox.ext.apps.commonui.coreui._UpdatingItem",[],{coreui:nox.ext.apps.commonui.coreui,identityAttributes:[],labelAttributes:[],constructor:function(_1){this.initialized=false;this.initialData={};this.store=null;this.generation=0;this.updateList=[];this.timeout=30000;this.localChanges=[];this.updateTypes={};this.derivedAttributes={};this.updatemgr=this.coreui.getUpdateMgr();dojo.mixin(this,_1);if(this.initialGeneration!=undefined){this.generation=this.initialGeneration;}this._data={};this._derivedData={};this._queuedUpdates=[];this._inProgressUpdates=null;this._pendingUpdateTypes=[];this._queuedSaves=[];this._inProgressSaves=null;this._pendingUpdateTypeSaveCnt=0;this._conflictList=[];this._onLoadCallbacks=[];this._flags=[];this._updateBasicData(this.initialData);this.initialized=true;},update:function(_2){if(this.hasFlag("deleted")){return;}if(_2==undefined){_2={};}_2.errhandler=this.coreui.UpdateErrorHandler.kwCreate(_2);if(_2.conflictHandler==null){_2.conflictHandler=this._defaultConflictHandler;}this._queuedUpdates.push(_2);if(this._inProgressUpdates!=null){return;}this._startUpdate();},_startUpdate:function(){this._inProgressUpdates=this._queuedUpdates;this._queuedUpdates=[];this.generation++;if(this.initialized){this.onUpdateStart(this);}this._conflictList=[];dojo.forEach(this._inProgressUpdates,function(a){if(a.onComplete!=undefined){this._onLoadCallbacks.push({scope:a.scope,onItem:a.onComplete});}if(a.newData!=undefined){this._updateBasicData(a.newData);}},this);this._pendingUpdateTypes=dojo.clone(this.updateList);this._startNextUpdate();},_startNextUpdate:function(){if(this._pendingUpdateTypes.length>0){var ut=this._pendingUpdateTypes.shift();var fn=this.updateTypes[ut].load;if(fn==undefined){throw new Error("Unknown update type: ",ut);}var d=fn.call(this);if(d==null){this._startNextUpdate();}else{d.addCallback(dojo.hitch(this,this._startNextUpdate));}}else{var kw=this._inProgressUpdates[this._inProgressUpdates.length-1];if(this._conflictList.length>0){var d=kw.conflictHandler.call(kw.scope,this._conflictList);if(d instanceof dojo.Deferred){d.addCallback(this._handleResolvedConflicts);}else{this._handleResolvedConflicts(d);}}else{this._finishUpdate();}}},_defaultConflictHandler:function(l){return l;},_updateBasicData:function(_9){var _a=[];for(var a in _9){var _c=dojo.filter(this.localChanges,function(c){return c.attribute==a;});var _e=_c.length;if(_e>0&&_c[_e-1].newValue!=_9[a]){if(_c[0].oldValue!=_9[a]){var _f=_c[_e-1].newValue;this.onConflictDetected(i,a,_f,_9[a]);this._conflictList.push({attribute:a,oldValue:_f,newValue:_9[a]});}}else{var _10=this._updateBasicAttribute(a,_9[a]);if(_10!=null){_a.push(_10);if(this.initialized){this.onChange(this,_10.attribute,_10.oldValue,_10.newValue);}}}}this._handleDerivedChanges(_a);},_updateBasicAttribute:function(_11,_12){var _13=this._data[_11];if(_13==_12){return null;}this._data[_11]=_12;return {"attribute":_11,"oldValue":_13,"newValue":_12};},_handleDerivedChanges:function(_14){for(var a in this.derivedAttributes){var da=this.derivedAttributes[a];if((da.isAvailable==undefined||da.isAvailable.call(this))&&(da.hasChanged==undefined||da.hasChanged.call(this,_14))){var _17=this._derivedData[a];var _18=this._getAttribute(a);if(_17!=_18){this._derivedData[a]=_18;if(this.initialized){this.onChange(this,a,_17,_18);}}}}},_handleResolvedConflicts:function(_19){dojo.forEach(_19,function(c){if(c.resolution==undefined||c.resolution==c.oldValue){}else{if(c.resolution==c.newValue){this.localChanges=dojo.filter(this.localChanges,function(l){return l.attribute!=c.attribute;});this._updateBasicAttribute(c.attribute,c.resolution);this._handleDerivedChanges([{attribute:c.attribute,oldValue:c.oldValue,newValue:c.resolution}]);}else{var _1c=this.setAttribute(c.attribute,c.resolution);if(_1c!=null){this.localChanges.push(_1c);this.onChange(this,_1c.attribute,_1c.oldValue,_1c.newValue);this._handleDerivedChanges([_1c]);}}}this.onConflictResolved(this,c.attribute,c.resolution);},this);this._conflictList=[];this._finishUpdate();},_finishUpdate:function(){this._doLoadCallbacks();this.onUpdateComplete(this);this._inProgressUpdates=null;if(this._queuedUpdates.length>0){this._startUpdate();}},_doLoadCallbacks:function(){dojo.forEach(this._onLoadCallbacks,function(c){c.onItem.call(c.scope==undefined?dojo.global:c.scope,this);},this);this._onLoadCallbacks=[];},basicDataChanged:function(_1e,_1f){return dojo.some(_1f,function(c){dojo.some(_1e,function(a){return a==c.attribute;});});},isLoaded:function(){return (this.initialized&&this._pendingUpdateTypes.length==0&&this._conflictList.length==0&&this._inProgressUpdates!=null);},load:function(_22){this._onLoadCallbacks.push(_22);if(this.isLoaded()){this._doLoadCallbacks();}},_xhrGetMixin:function(_23,url,_25){var d=new dojo.Deferred();this.updatemgr.xhrGet({url:url,load:dojo.hitch(this,function(_27,_28){if(_25!=null){_27=_25.call(this,_27);}this._updateBasicData(_27);d.callback();}),error:dojo.hitch(this,function(err,_2a){var kw=this._inProgressUpdates[this._inProgressUpdates.length-1];var v=kw.errhandler.call(null,err,_2a,this,_23);if(!v){d.callback();}return v;}),timeout:this.timeout,handleAs:"json"});return d;},_storeQueryMixin:function(_2d,_2e,_2f,_30,_31){var d=new dojo.Deferred();var _33=dojo.hitch(this,function(){_2f.fetch({query:_30,onComplete:dojo.hitch(this,function(_34,_35){if(_31!=null){_34=_31.call(this,_34);}var _36={};_36[_2e]=_34;this._updateBasicData(_36);d.callback();})});});_2f.update({onComplete:_33,onError:dojo.hitch(this,function(_37,_38){var kw=this._inProgressUpdates[this._inProgressUpdates.length-1];var v=kw.errhandler.call(null,_37,_38,this,_2d);if(!v){d.callback();}return v;})});return d;},getValue:function(_3b,_3c){v=this._getAttribute(_3b);if(v==undefined){return _3c;}return dojo.isArray(v)?v[0]:v;},getValues:function(_3d){v=this._getAttribute(_3d);if(v==undefined){return [];}return dojo.isArray(v)?v:[v];},_getAttribute:function(_3e){var v=undefined;var da=this.derivedAttributes[_3e];if(da!=null){if(da.get!=null){v=da.get.call(this);this._derivedData[_3e]=v;}else{throw new Error("No get function for derived attribute: "+_3e);}}else{v=this._data[_3e];}return v;},setValue:function(_41,_42){this.setAttribute(_41,dojo.isArray(_42)?_42[0]:_42);},setValues:function(_43,_44){this.setAttribute(_43,dojo.isArray(_44)?_44:[_44]);},unsetAttribute:function(_45){this.setAttribute(_45,undefined);},setAttribute:function(_46,_47){var da=this.derivedAttributes[_46];if(da!=null){if(da.set==null){throw new Error("No set function for derived attribute: "+_46);}else{da.set.call(this,_47);}}else{var _49=this._updateBasicAttribute(_46,_47);if(_49!=null){this.localChanges.push(_49);this.onChange(this,_49.attribute,_49.oldValue,_49.newValue);this._handleDerivedChanges([_49]);}}},revert:function(){var _4a={};dojo.forEach(this.localChanges.reverse(),function(i){_4a[i.attribute]=i.oldValue;},this);for(var a in _4a){var v=_4a[a];if(dojo.isArray(v)&&v.length>0&&v[0]==undefined){this.setAttribute(a,v[0]);}this.setAttribute(a,v);}this.localChanges=[];},acceptLocalChanges:function(){this.localChanges=[];},getAttributes:function(){attrlist=[];for(var a in this._data){attrlist.push(a);}for(a in this.derivedAttributes){if(this.derivedAttributes[a].isAvailable!=undefined){if(this.derivedAttributes[a].isAvailable.call(this)){attrlist.push(a);}}else{attrlist.push(a);}}return attrlist;},hasAttribute:function(_4f){return ((this._data[_4f]!=undefined)||(this.derivedAttributes[a]!=undefined&&this.derivedAttributes[a].isAvailable.call(this)));},containsValue:function(_50,_51){return dojo.some(this.getValues(_50),function(i){return i==_51;});},getIdentity:function(){if(this.identityAttributes.length==0){throw new Error("This item does not support identities");}return dojo.map(this.identityAttributes,"return this._data[item];",this).join(":");},getIdentityAttributes:function(){if(this.identityAttributes.length==0){throw new Error("This item does not support identities");}return this.identityAttributes;},getLabel:function(){if(this.labelAttributes.length==0){throw new Error("This item does not support labels");}return dojo.map(this.labelAttributes,"return this._data[item];",this).join(":");},getLabelAttributes:function(){if(this.labelAttributes.length==0){throw new Error("This item does not support labels");}return this.labelAttributes;},isDirty:function(){return this.localChanges.length!=0;},flags:function(){return this._flags;},hasFlag:function(_53){return dojo.some(this._flags,function(i){return i==_53;});},setFlag:function(_55){if(!this.hasFlag(_55)){this._flags.push(_55);}},unsetFlag:function(_56){this._flags=dojo.filter(this._flags,function(i){return i!=_56;});},isValid:function(){return true;},createOnServer:function(_58){throw new Error("This item does not know how to create itself on the server.");},deleteOnServer:function(_59){throw new Error("This item does not know how to delete itself from the server.");},save:function(_5a){if(_5a==undefined){_5a={};}_5a.errhandler=this.coreui.UpdateErrorHandler.kwCreate(_5a);this._queuedSaves.push(_5a);if(this._inProgressSaves!=null){return;}this._startSave();},_startSave:function(){this._inProgresSaves=this._queuedSaves;this._queuedSaves=[];this._pendingUpdateTypeSaveCnt=this.updateList.length;dojo.forEach(this.updateList,function(ut){try{var fn=this.updateTypes[ut].save;}catch(e){fn=null;}if(fn==null){this._pendingUpdateTypeSaveCnt--;return;}var d=fn.call(this);if(d==null){this._pendingUpdateTypeSaveCnt--;return;}d.addCallback(dojo.hitch(this,"_handleSaveComplete"));},this);if(this._pendingUpdateTypeSaveCnt==0){this._finishSave();}},_handleSaveComplete:function(_5e,err){if(--this._pendingUpdateTypeSaveCnt==0){this._finishSave();}},_finishSave:function(){this.acceptLocalChanges();dojo.forEach(this._inProgressSaves,function(kw){if(kw.onComplete!=undefined){kw.onComplete.call(kw.scope);}},this);this._inProgressSaves=null;},_xhrPutData:function(_61,url,_63){var d=new dojo.Deferred();if(_63!=undefined){data=_63(this);}this.updatemgr.rawXhrPut({url:url,headers:{"content-type":"application/json"},putData:dojo.toJson(this._data),load:dojo.hitch(this,function(_65,_66){d.callback();}),error:dojo.hitch(this,function(err,_68){var kw=this._inProgressSaves[this._inProgressSaves.length-1];var v=kw.errhandler.call(null,err,_68,this,_61);if(!v){d.callback();}return v;}),timeout:this.timeout,handleAs:"json"});return d;},onUpdateStart:function(_6b){},onChange:function(_6c,_6d,_6e,_6f){},onConflictDetected:function(_70,_71,_72,_73){},onConflictResolved:function(_74,_75,_76){},onUpdateComplete:function(_77){},installDebugLogging:function(){dojo.connect(this,"onUpdateStart",this,function(i){console_log("Item: ",i," update started.");});dojo.connect(this,"onChange",this,function(i,a,o,n){console_log("Item: ",i," attribute: ",a," changed from: ",o," to: ",n);});dojo.connect(this,"onConflictDetected",this,function(i,a,l,s){console_log("Item: ",i," conflict detected in attribute: ",a," local value: ",l," server value: ",s);});dojo.connect(this,"onConflictResolved",this,function(i,a,f){console_log("Item: ",i," conflict resolved in attribute: ",a," final value: ",f);});dojo.connect(this,"onUpdateComplete",this,function(i){console_log("Item: ",i," updated completed.");});}});}