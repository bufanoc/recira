/* Copyright (c) 2008, 2009, 2010 Nicira, Inc. */

if(!dojo._hasResource["nox.ext.apps.commonui.coreui._UpdatingStore"]){dojo._hasResource["nox.ext.apps.commonui.coreui._UpdatingStore"]=true;dojo.provide("nox.ext.apps.commonui.coreui._UpdatingStore");dojo.require("nox.ext.apps.commonui.coreui.UpdateMgr");dojo.require("nox.ext.apps.commonui.coreui.UpdateErrorHandler");dojo.require("nox.ext.apps.commonui.coreui._UpdatingItem");dojo.require("dojo.data.util.simpleFetch");dojo.require("dojo.data.util.filter");dojo.declare("nox.ext.apps.commonui.coreui._UpdatingStore",[],{coreui:nox.ext.apps.commonui.coreui,url:null,timeout:30000,autoUpdate:null,_handling_server_response:false,constructor:function(_1){this.itemConstructor=nox.ext.apps.commonui.coreui._UpdatingItem;this.itemParameters={};if(_1==null){_1={};}dojo.mixin(this,_1);this.updatemgr=this.coreui.getUpdateMgr();this._internals_init();if(this.autoUpdate!=null){this._updateItemsFromServer(this.autoUpdate);}else{this.initialized=true;}},_internals_init:function(){this.generation=0;this._items=[];this._oldItems=null;this._localItems=0;this.initialized=false;this._pendingFetches=[];this._queuedUpdates=[];this._inProgressUpdates=null;this._pendingItemUpdates=0;this._queuedSaves=[];this._queueAllSaves=false;this._inProgressSaves=null;this._pendingItemSaves=0;this._update=null;this._byId={};this._changingIdentity=false;},destroy:function(){if(this._update!=null){this._update.cancel();}dojo.forEach(this._items,function(i){this._deleteItem(i);},this);this._internals_init();},update_url:function(_3){this.destroy();this.url=_3;this.initialized=true;if(this.autoUpdate!=null){this._updateItemsFromServer(this.autoUpdate);}else{this.initialized=true;}},update:function(_4){if(this.autoUpdate!=null&&this.initialized){this.updatemgr.updateNow();}else{this._updateItemsFromServer(_4);}},_updateItemsFromServer:function(_5){if(_5==undefined){_5={};}_5.errhandler=this.coreui.UpdateErrorHandler.kwCreate(_5);this._queuedUpdates.push(_5);if(this._inProgressUpdates!=null){return;}this._startUpdate();},_startUpdate:function(){this._inProgressUpdates=this._queuedUpdates;this._queuedUpdates=[];this._update=this.updatemgr.xhrGet({url:this.url,load:dojo.hitch(this,"_handleServerResponse"),error:this._inProgressUpdates.slice(-1)[0].errhandler,timeout:this.timeout,handleAs:"json",recur:this.autoUpdate!=null});},_handleServerResponse:function(_6,_7){var _8=this._items;this._items=[];this._handlingServerResponse=true;var _9=this._unpackData(_6);this._pendingItemUpdates=_9.length;dojo.forEach(_9,function(d){var i=this._findOrCreateItem(d);i.update({newData:d,scope:this,onComplete:this._updateCompleteHandler,onError:this._inProgressUpdates.slice(-1)[0].errhandler});},this);this.generation++;this._removeDeletedItems(_8);this._handlingServerResponse=false;if(_9.length==0){this._finishUpdate();}this._handlePendingFetches();},_unpackData:function(_c){return _c;},_findOrCreateItem:function(_d){var _e={};dojo.mixin(_e,this.itemParameters);dojo.mixin(_e,{store:this,initialData:_d,initialGeneration:this.generation,onChange:dojo.hitch(this,this._itemChangeHandler)});var i=new this.itemConstructor(_e);var id=i.getIdentity();var o=this.fetchItemByIdentity(id);if(o!=null&&o.hasFlag("new")){o.unsetFlag("new");}return (o!=null)?this._insertItem(o,-1):this._addItem(i,-1);},_itemChangeHandler:function(_12,_13,_14,_15){if(!this._changingIdentity){this.onSet(_12,_13,_14,_15);}},_insertItem:function(_16,_17){if(_17>=0){var i=Math.min(_17,this._items.length);}else{i=Math.max(this._items.length+(_17+1),0);}this._items.splice(i,0,_16);return _16;},_addItem:function(_19,_1a){var id=_19.getIdentity();if(this._byId[id]!=undefined){if(!this._byId[id].hasFlag("deleted")){throw new Error("Item already exists with id: ",id);}}this._byId[id]=_19;this._insertItem(_19,_1a);if(this.initialized){this.onNew(_19,null);}return _19;},_updateCompleteHandler:function(_1c){if(--this._pendingItemUpdates==0){this._finishUpdate();}},_removeDeletedItems:function(_1d){this._localItems=0;dojo.forEach(_1d,function(i){if(i.generation<this.generation){var _1f=i.hasFlag("deleted");if(i.hasFlag("new")&&!_1f){this._localItems++;this._items.unshift(i);}else{if(i.isDirty()&&!_1f){this._localItems++;this._items.unshift(i);}else{if(!_1f){this._deleteItem(i);}i.store=null;delete this._byId[i.getIdentity()];}}}},this);},_deleteItem:function(_20){if(_20.hasFlag("deleted")){return;}_20.setFlag("deleted");if(this.initialized){this.onDelete(_20);}},_finishUpdate:function(){if(this.initialized==false){this.initialized=true;this._handlePendingFetches();}dojo.forEach(this._inProgressUpdates,function(kw){if(kw.onComplete!=null){kw.onComplete.call(kw.scope);}},this);if(this.autoUpdate==null){this._inProgressUpdates=null;if(this._queuedUpdates.length>0){this._startUpdate();}}else{if(this._queuedUpdates.length>0){this._queuedUpdates=[];}}},getFeatures:function(){return {"dojo.data.api.Identity":true,"dojo.data.api.Read":true,"dojo.data.api.Write":true,"dojo.data.api.Notification":true};},getIdentity:function(_22){return _22.getIdentity();},getIdentityAttributes:function(_23){return _23.getIdentityAttributes();},fetchItemByIdentity:function(_24){if(typeof _24=="string"){return this._byId[_24];}else{var _25=this._byId[_24.identity];_24.onItem.call(_24.scope,_25);}},getValue:function(_26,_27,_28){return _26.getValue(_27,_28);},getValues:function(_29,_2a){return _29.getValues(_2a);},getAttributes:function(_2b){return _2b.getAttributes();},hasAttribute:function(_2c,_2d){return _2c.hasAttribute(_2d);},containsValue:function(_2e,_2f,_30){return _2e.containsValue(_2f,_30);},isItem:function(_31){return _31.store==this;},isItemLoaded:function(_32){return _32.isLoaded();},loadItem:function(_33){_33.item.load(_33);},_item_matches_query:function(_34,_35,_36){if(_34.hasFlag("deleted")){return false;}if(this.preQuery&&!this.preQuery(_34)){return false;}for(var k in _35){var _38=false;var ev=_35[k];var re=_36[k];var _3b=this.getValues(_34,k);for(var i=0;i<_3b.length&&!_38;i++){var v=_3b[i];if(typeof (v)=="string"&&re!=null){_38=v.match(re);}else{if(typeof (ev)=="function"){_38=ev(v);}else{_38=v==ev;}}}if(!_38){return false;}}return true;},_handlePendingFetches:function(){for(var i=0;i<this._pendingFetches.length;i++){this._pendingFetches[i].call(this);}this._pendingFetches=[];},_fetchItems:function(_3f,_40,_41){var _42=_3f.queryOptions?_3f.queryOptions.ignoreCase:false;var _43={};var _44=_3f["query"];if(_44!=null){for(var k in _44){var v=_44[k];if(typeof (v)=="string"){_43[k]=dojo.data.util.filter.patternToRegExp(v,_42);}}}var f=function(){var _48=[];for(var i=0;i<this._items.length;i++){var _4a=this._items[i];if(!this._item_matches_query(_4a,_44,_43)){continue;}_48.push(_4a);}_40(_48,_3f);};if(this.initialized&&!this._handlingServerResponse){f.call(this);}else{this._pendingFetches.push(f);}},close:function(){},getLabel:function(_4b){return _4b.getLabel();},getLabelAttributes:function(_4c){return _4c.getLabelAttributes();},_clearItems:function(){var _4d=this._items;this._items=[];dojo.forEach(_4d,function(i){if(i.hasFlag("new")||i.hasFlag("deleted")||i.isDirty()){this._items.push(i);}else{i.store!=null;delete this._byId[i.getIdentity()];if(this.initialized){this.onDelete(i);}}},this);},newItem:function(_4f,_50){var i=new this.itemConstructor({store:this,initialData:_4f,initialGeneration:this.generation,onChange:dojo.hitch(this,this._itemChangeHandler)});i.setFlag("new");this._addItem(i,0);},deleteItem:function(_52){this._deleteItem(_52,true);},setValue:function(_53,_54,_55){this._prepareForAnyIdentityChange(_53,_54);_53.setValue(_54,_55);this._completeAnyIdentityChange(_53);},setValues:function(_56,_57,_58){this._prepareForAnyIdentityChange(_56,_57);_56.setValues(_57,_58);this._completeAnyIdentityChange(_56);},_prepareForAnyIdentityChange:function(_59,_5a){if(dojo.some(_59.getIdentityAttributes(),function(a){return a==_5a;})){this._changingIdentity=true;this.queueAllSaves();delete this._byId[_59.getIdentity()];this.onDelete.call(dojo.global,_59);}},_completeAnyIdentityChange:function(_5c){if(this._changingIdentity){this._byId[_5c.getIdentity()]=_5c;this.onNew.call(dojo.global,_5c);this._changingIdentity=false;this.releaseQueuedSaves();}},unsetAttribute:function(_5d,_5e,_5f){_5d.unsetAttribute(_5e);},isDirty:function(_60){return _60.isDirty();},save:function(_61){if(_61==undefined){_61={};}_61.errhandler=this.coreui.UpdateErrorHandler.kwCreate(_61);this._queuedSaves.push(_61);if(this._inProgressSaves!=null||this._queueAllSaves){return;}this._startSave();},queueAllSaves:function(){this._queueAllSaves=true;},releaseQueuedSaves:function(){if(this._queueAllSaves==false){return;}this._queueAllSaves=false;if(this._inProgressSaves==null&&this._queuedSaves.length>0){this._startSave();}},_startSave:function(){this._inProgressSaves=this._queuedSaves;this._queuedSaves=[];var _62=this._packData();if(_62=="abort"){return;}if(_62!=null){this.updatemgr.rawXhrPut({url:this.url,headers:{"content-type":"application/json"},putData:dojo.toJson(_62),timeout:this.timeout,load:dojo.hitch(this,function(_63,_64){this._finishSave();},this),error:this._inProgressSaves.slice(-1)[0].errhandler});}else{this._pendingItemSaves=this._items.length;dojo.forEach(this._items,function(i){var kw={scope:this,onComplete:dojo.hitch(this,"_itemSaveComplete"),onError:this._inProgressSaves.slice(-1)[0].errhandler};if(i.hasFlag("new")){i.createOnServer(kw);}else{if(i.hasFlag("deleted")){i.deleteOnServer(kw);}else{if(i.isDirty()){i.save(kw);}else{this._itemSaveComplete();}}}},this);}},_packData:function(){return null;},_packDataList:function(_67){var _68=false;var _69=[];dojo.forEach(this._items,function(i){if(!i.hasFlag("deleted")){if(i.isValid()){if(_67.packFn==null){_69.push(i._data);}else{_69.push(_67.packFn(i));}}else{_68=true;}}},this);if(_68&&_67.abortOnInvalid){return "abort";}if(_67.name==null){return _69;}else{var o={};o[_67.name]=_69;return dojo.mixin(o,_67.otherData);}},_itemSaveComplete:function(_6c,_6d){if(--this._pendingItemSaves==0){this._finishSave();}},_finishSave:function(){this.acceptLocalChanges();dojo.forEach(this._inProgressSaves,function(kw){if(kw.onComplete!=null){kw.onComplete.call(kw.scope);}},this);this._inProgressSaves=null;if(this._queuedSaves.length>0){this._startSave();}},acceptLocalChanges:function(){var _6f=this._items;this._items=[];dojo.forEach(_6f,function(_70){if(_70.hasFlag("deleted")){_70.store=null;delete this._byId[_70.getIdentity()];return;}if(_70.isValid()){if(_70.hasFlag("new")){_70.unsetFlag("new");}_70.acceptLocalChanges();}_70.generation=this.generation;this._items.push(_70);},this);},revert:function(){dojo.forEach(this._items,function(i){if(i.isDirty()){i.revert();}if(i.hasFlag("new")&&!i.hasFlag("deleted")){i.unsetFlag("new");this._deleteItem(i,false);}else{if(i.hasFlag("deleted")){i.unsetFlag("deleted");this.onNew(i,null);}}},this);},onSet:function(_72,_73,_74,_75){},onNew:function(_76,_77){},onDelete:function(_78){},isValid:function(_79){return _79.isValid();},itemCount:function(){return this._items.length;},cloneItem:function(_7a){return new this.itemConstructor({initialData:_7a._data});},installDebugLogging:function(){dojo.connect(this,"onSet",function(_7b,_7c,_7d,_7e){console_log("Item ",_7b," attribute ",_7c," changed from ",_7d," to ",_7e);});dojo.connect(this,"onNew",function(_7f,_80){console_log("Item ",_7f," added with parent ",_80);});dojo.connect(this,"onDelete",function(_81){console_log("Item ",_81," deleted");});}});dojo.extend(nox.ext.apps.commonui.coreui._UpdatingStore,dojo.data.util.simpleFetch);}