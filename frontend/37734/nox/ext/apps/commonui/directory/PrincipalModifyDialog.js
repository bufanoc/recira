/* Copyright (c) 2008, 2009, 2010 Nicira, Inc. */

if(!dojo._hasResource["nox.ext.apps.commonui.directory.PrincipalModifyDialog"]){dojo._hasResource["nox.ext.apps.commonui.directory.PrincipalModifyDialog"]=true;dojo.provide("nox.ext.apps.commonui.directory.PrincipalModifyDialog");dojo.require("dijit._Widget");dojo.require("dijit.Dialog");dojo.require("dijit._Templated");dojo.require("dijit.form.FilteringSelect");dojo.require("dijit.form.Button");dojo.require("dijit.form.TextBox");dojo.require("nox.ext.apps.commonui.directory.Directories");var coreui=nox.ext.apps.commonui.coreui;dojo.declare("nox.ext.apps.commonui.directory.PrincipalModifyDialog",[dijit._Widget,dijit._Templated],{templateString:"<div dojoAttachPoint=\"content\" > \n  <div dojoType=\"dijit.Dialog\" dojoAttachPoint=\"main_dialog\" \n      title=\"${title}\" > \n      <table>\n        <tr dojoAttachPoint=\"dir_row\"> <td> Directory: \n            <!-- We need to dynamically generate the store for this textbox\n            --> \n            <span dojoType=\"dijit.layout.ContentPane\" \n              dojoAttachPoint=\"dir_textbox_div\"> </span> \n       </td></tr> \n        <tr> <td> Name:\n        <input dojoType=\"dijit.form.TextBox\" type=\"text\" trim=\"true\" dojoAttachPoint=\"name\"/>\n        </td> </tr> \n        <tr><td> \n    <button dojoType=\"dijit.form.Button\" dojoAttachPoint=\"addBtn\">Add</button>\n    <button dojoType=\"dijit.form.Button\" dojoAttachPoint=\"cancelBtn\">Cancel</button>\n        </td></tr>\n        </table> \n      </div>\n</div> \n",widgetsInTemplate:true,principal:null,ctor:null,principal_type:null,title:null,type:null,group_ctor:null,onChange:function(){},_set_widget_values:function(){if(!this.principal){return;}var _1=this.principal.directoryName();if(_1!="discovered"){this.directory.setDisplayedValue(_1);}},_cancel:function(){this.main_dialog.hide();},_done:function(){var g=new this.ctor({});if(!g.check_name(this.name.getValue())){coreui.UpdateErrorHandler.showError("'"+this.name.getValue()+"' is an invalid name",{header_msg:"Operation Failed:",hide_retry:true,validation_error:true});return;}if(!g.check_name(this.directory.getValue())){coreui.UpdateErrorHandler.showError("'"+this.directory.getValue()+"' is an invalid directory "+"name",{header_msg:"Operation Failed:",hide_retry:true,validation_error:true});return;}if(!this.directory.validate()){this.directory._hasBeenBlurred=true;this.directory.focus();return;}this.main_dialog.hide();this.principal_name=this.name.getValue();this.principal_directory=this.directory.getValue();if(this.type=="add_principal"){var _3=this.principal_type;var _4=this.directory.getValue()+";"+this.name.getValue();this.principal=new this.ctor({initialData:{name:_4}});this.principal.create(function(e){var p=_3.substring(0,1).toUpperCase()+_3.substring(1);top.location.pathname="/Monitors/"+p+"s/"+p+"Info?name="+encodeURIComponent(_4);});}else{if(this.type=="add_to_group"||this.type=="add_to_role"){var _7=this.directory.getValue()+";"+this.name.getValue();var _8=this.principal.getValue("name");var _9=new this.group_ctor({initialData:{name:_7},updateList:[]});var _a={name:this.principal.principalName(),directory:this.principal.directoryName(),ctor:this.ctor,principal_type:this.principal_type};_9.modify_direct_member("PUT",_a);}else{console_log("unknown principal modify type: "+this.type);}}this.onChange(this.principal);},_name_keypress:function(_b){switch(_b.keyCode){case dojo.keys.ENTER:this._done();break;}},show:function(){this.main_dialog.show();this.name.focus();},postCreate:function(){this.main_dialog.closeButtonNode.style.display="none";dojo.connect(this.name.domNode,"onkeypress",this,"_name_keypress");dojo.connect(this.addBtn,"onClick",this,"_done");dojo.connect(this.cancelBtn,"onClick",this,"_cancel");query={};query["write_"+this.principal_type+"_enabled"]=true;this.directory=new dijit.form.FilteringSelect({store:dmws.Directories.datastore,searchAttr:"name",query:query});this.dir_textbox_div.domNode.appendChild(this.directory.domNode);if(this.type=="add_to_role"){this.directory.setValue("Built-in");dojo.style(this.dir_row,{display:"none"});}var d=this.directory;dmws.Directories.datastore.fetch({onComplete:function(_d){if(_d.length==2){dojo.forEach(_d,function(_e){if(_e.displayName()!="discovered"){d.setDisplayedValue(_e.displayName());}});}}});this._set_widget_values();}});}