/* Copyright (c) 2008, 2009, 2010 Nicira, Inc. */

if(!dojo._hasResource["nox.ext.apps.commonui.directory._Principal"]){dojo._hasResource["nox.ext.apps.commonui.directory._Principal"]=true;dojo.provide("nox.ext.apps.commonui.directory._Principal");dojo.require("nox.ext.apps.commonui.coreui.base");dojo.require("nox.ext.apps.commonui.coreui._NamedEntity");dojo.require("nox.ext.apps.commonui.directory.PrincipalModifyDialog");dojo.declare("nox.ext.apps.commonui.directory._Principal",[nox.ext.apps.commonui.coreui._NamedEntity],{coreui:nox.ext.apps.commonui.coreui,dmws:nox.ext.apps.commonui.directory,constructor:function(_1){dojo.mixin(this.derivedAttributes,{fullName:{get:dojo.hitch(this,"fullName"),set:dojo.hitch(this,"fullNameSet"),hasChanged:dojo.hitch(this,"nameHasChanged")},directoryName:{get:dojo.hitch(this,"directoryName"),set:dojo.hitch(this,"directoryNameSet"),hasChanged:dojo.hitch(this,"nameHasChanged")},principalName:{get:dojo.hitch(this,"principalName"),set:dojo.hitch(this,"principalNameSet"),hasChanged:dojo.hitch(this,"nameHasChanged")},wsv1Path:{get:dojo.hitch(this,"wsv1Path"),hasChanged:dojo.hitch(this,"nameHasChanged")},uiMonitorPath:{get:dojo.hitch(this,"uiMonitorPath"),hasChanged:dojo.hitch(this,"nameHasChanged")},uiMonitorLink:{get:dojo.hitch(this,"uiMonitorLink"),hasChanged:dojo.hitch(this,"nameHasChanged")},uiMonitorLinkText:{get:dojo.hitch(this,"uiMonitorLinkText"),hasChanged:dojo.hitch(this,"nameHasChanged")},statusNode:{get:dojo.hitch(this,"statusNode"),hasChanged:dojo.hitch(this,"statusHasChanged")},statusMarkup:{get:dojo.hitch(this,"statusMarkup"),hasChanged:dojo.hitch(this,"statusHasChanged")}});dojo.mixin(this.updateTypes,{"status":{load:dojo.hitch(this,"updateStatus")}});},isNull:function(){return (this._data.name==null);},fullName:function(){return this._data.name;},fullNameSet:function(v){this.setValue("name",v);},directoryName:function(){try{return this._data.name.split(";",2)[0];}catch(e){return null;}},directoryNameSet:function(v){var _4=this.principalName();this.setValue("name",v+";"+_4);},principalName:function(){try{return this._data.name.split(";",2)[1];}catch(e){return null;}},principalNameSet:function(v){var _6=this.directoryName();this.setValue("name",_6+";"+v);},displayName:function(){return this.getValue("name");},statusHasChanged:function(l){return dojo.some(l,"return item.attribute == 'status';");},statusNode:function(){var s=document.createElement("span");var _9="unknown";s.className="errormsg";var _a=this.getValue("status");if(_a){_9=this.getValue("status");if(_9=="active"){s.className="successmsg";}}s.appendChild(document.createTextNode(_9));return s;},statusMarkup:function(){var cl="errormsg";var _c="unknown";var _d=this.getValue("status");if(_d){_c=_d;if(_d=="active"){cl="successmsg";}}return "<span class='"+cl+"'>"+_c+"</span>";},wsv1Path:function(){throw Error("Method must be overridden by subclass");},uiMonitorPath:function(){throw Error("Method must be overridden by subclass");},uiMonitorLink:function(_e){var _f=((_e==true)?this.getValue("name"):this.principalName());var p=this.uiMonitorPath();if(p==null){return document.createTextNode(_f);}else{return nox.ext.apps.commonui.coreui.base.createLink(p,_f);}},uiMonitorLinkText:function(_11){var _12=((_11==true)?this.getValue("name"):this.principalName());return "<a href='"+this.uiMonitorPath()+"'>"+_12+"</a>";},updateStatus:function(_13){return this._xhrGetMixin("status",this.wsv1Path()+"/active",function(r){return {"status":r?"active":"inactive"};});},deleteOnServer:function(_15){this._do_modify_request(this.wsv1Path(),"DELETE",_15.onComplete);},create:function(_16){onExisting=dojo.hitch(this,function(){coreui.UpdateErrorHandler.showError("Principal '"+this.principalName()+"' already exists"+" in directory "+this.directoryName(),{header_msg:"Create Failed:",hide_retry:true,validation_error:true});});onNonexisting=dojo.hitch(this,function(){this._do_modify_request(this.wsv1Path(),"PUT",_16);});this.check_exist(onExisting,onNonexisting);},check_exist:function(_17,_18){cb=function(_19){if(_19){_17.call(dojo.global);}else{_18.call(dojo.global);}};this.exists(dojo.hitch(this,cb));},exists:function(_1a){nox.ext.apps.commonui.coreui.getUpdateMgr().xhrGet({url:this.wsv1Path(),headers:{"content-type":"application/json"},load:function(_1b,_1c){_1a.call(dojo.global,true);},error:function(_1d,_1e){_1a.call(dojo.global,false);},timeout:30000});},change_directory:function(arg){arg.directory=arg.name;arg.name=this.principalName();this.full_rename(arg);},rename:function(arg){arg.directory=this.directoryName();this.full_rename(arg);},full_rename:function(arg){if(this.check_name(arg.name)==false){coreui.UpdateErrorHandler.showError("'"+arg.name+"' is an invalid name",{header_msg:"Rename Failed:",hide_retry:true,validation_error:true});return;}if(this.check_name(arg.directory)==false){coreui.UpdateErrorHandler.showError("'"+arg.directory+"' is an invalid directory name",{header_msg:"Rename Failed:",hide_retry:true,validation_error:true});return;}var _22=arg.directory+";"+arg.name;if(_22==this._data.name){if(arg.onComplete!=null){arg.onComplete.call(dojo.global,this);}return;}var _23=new this.constructor();_23.setValue("name",_22);onExisting=dojo.hitch(coreui.UpdateErrorHandler,"showError","Principal '"+arg.name+"' already exists.",{header_msg:"Rename Failed:",hide_retry:true,validation_error:true});onNonexisting=function(){nox.ext.apps.commonui.coreui.getUpdateMgr().rawXhrPut({url:this.wsv1Path(),headers:{"content-type":"application/json"},putData:dojo.toJson({name:_22}),load:dojo.hitch(_23,function(_24,_25){if(arg.onComplete!=null){arg.onComplete.call(dojo.global,_23);}}),timeout:30000,errorHandlers:{400:function(_26,_27,_28,_29){coreui.UpdateErrorHandler.showError(_26.responseText,{auto_show:true,header_msg:"Rename Failed:"});}}});};_23.check_exist(onExisting,dojo.hitch(this,onNonexisting));},_do_modify_request:function(_2a,_2b,_2c){var _2d=nox.ext.apps.commonui.coreui;_2d.getUpdateMgr().xhr(_2b,{url:_2a,headers:{"content-type":"application/json"},putData:dojo.toJson({}),load:function(_2e,_2f){if(_2c!=null){_2c.call(dojo.global);}},error:function(_30,_31){_2d.UpdateErrorHandler.showError("Failed to modify/remove "+ptype+" "+this.principalName()+" from directory "+this.directoryName(),{header_msg:"Modify Failed:"});},timeout:30000});},delete_binding:function(_32){var _33=this.getValue("principalName");var _34=this.getValue("directoryName");coreui.getUpdateMgr().xhr("DELETE",{url:this.wsv1Path()+"/binding",headers:{"content-type":"application/json"},load:function(_35){if(_32!=null){_32(_35);}},putData:dojo.toJson({}),timeout:30000,handleAs:"json",recur:false,error:nox.ext.apps.commonui.coreui.UpdateErrorHandler.create()});}});dojo.declare("nox.ext.apps.commonui.directory.PrincipalUtil",[],{dmws:nox.ext.apps.commonui.directory,show_modify_dialog:function(_36,_37,_38,_39){var _3a=dijit.byId("modify_principal_id");if(_3a){_3a.destroy();}var _3b={principal:_37,title:_38,ctor:_39,principal_type:_36,type:"add_principal"};_3a=new dmws.PrincipalModifyDialog(_3b);dojo.body().appendChild(_3a.domNode);_3a.startup();_3a.show();return _3a;},setup_listpage_edit_hooks:function(_3c,_3d,_3e,_3f){var _40=dijit.byId("add_principal_button");if(_40!=null){dojo.connect(_40,"onClick",function(){var _41="Add "+_3c.substring(0,1).toUpperCase()+_3c.substring(1)+" Principal";var _42=dmws.getPrincipalUtil().show_modify_dialog(_3c,null,_41,_3e);dojo.connect(_42,"onChange",_3d,"update");});}var _43=dijit.byId("remove_principal_button");if(_43!=null){dojo.connect(_43,"onClick",function(){var _44=_3f.selection.getSelected();for(var i in _44){var _46=_44[i];var _47=_46.getValue("directoryName");var q={name:_47};q["write_"+_3c+"_enabled"]=true;var _49=false;dmws.Directories.datastore.fetch({query:q,onItem:function(_4a){if(_49){return;}_49=true;_3d.deleteItem(_46);_3d.save();},onComplete:function(){if(!_49){coreui.UpdateErrorHandler.showError("Cannot remove a "+_3c+" from read-only directory '"+_47+"'",{header_msg:"Removal Failed:",hide_retry:true,validation_error:true});}}});}});_43.setAttribute("disabled",true);dojo.connect(_3f.selection,"onChanged",function(){var _4b=_3f.selection.getSelectedCount();_43.setAttribute("disabled",!(_4b>0));});}},setup_listpage_deauth_hooks:function(_4c,_4d){var _4e=dijit.byId("deauth_principal_button");if(_4e!=null){dojo.connect(_4e,"onClick",function(){var _4f=_4d.selection.getSelected();for(var i in _4f){var _51=_4f[i];_51.delete_binding(function(){coreui.getUpdateMgr().updateNow();});}});_4e.setAttribute("disabled",true);dojo.connect(_4d.selection,"onChanged",function(){var _52=_4d.selection.getSelectedCount();_4e.setAttribute("disabled",!(_52>0));});}},get_listpage_store_error_handler:function(_53){return function(_54,_55,_56,_57){var ueh=nox.ext.apps.commonui.coreui.UpdateErrorHandler;if(_56==undefined||_56==null){var _59=ueh.get_error_type(_54);if(_59==404&&_57!=null){}else{if(_59!=500&&_59!=400&&_59!=404&&ueh.defaultHandlers[_59]!=null){ueh.defaultHandlers[_59].apply(dojo.global,[_54,_55]);}else{ueh.showError("Unable to retrieve list of "+_53,{header_msg:"Server Error:"});}}return true;}};},get_principal_not_found_fn:function(_5a,_5b){var _5c=_5a.substring(0,1).toUpperCase();var _5d=_5c+_5a.substring(1);return function(_5e,_5f){coreui.UpdateErrorHandler.showError("No "+_5a+" named "+_5b+" exists.",{hide_dismiss:true,header_msg:_5d+" Not Found:"});};}});(function(){var _60=nox.ext.apps.commonui.directory;var _61=null;_60.getPrincipalUtil=function(){if(_61==null){_61=new _60.PrincipalUtil();}return _61;};})();}