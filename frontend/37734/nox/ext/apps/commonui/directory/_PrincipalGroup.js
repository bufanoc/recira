/* Copyright (c) 2008, 2009, 2010 Nicira, Inc. */

if(!dojo._hasResource["nox.ext.apps.commonui.directory._PrincipalGroup"]){dojo._hasResource["nox.ext.apps.commonui.directory._PrincipalGroup"]=true;dojo.provide("nox.ext.apps.commonui.directory._PrincipalGroup");dojo.require("nox.ext.apps.commonui.coreui.base");dojo.require("nox.ext.apps.commonui.coreui._NamedEntity");dojo.require("nox.ext.apps.commonui.directory.GroupModifyDialog");dojo.declare("nox.ext.apps.commonui.directory._PrincipalGroup",[nox.ext.apps.commonui.coreui._NamedEntity],{coreui:nox.ext.apps.commonui.coreui,dmws:nox.ext.apps.commonui.directory,count_subgroups:null,count_members:null,constructor:function(_1,_2){dojo.mixin(this.derivedAttributes,{directoryName:{get:dojo.hitch(this,"directoryName"),hasChanged:dojo.hitch(this,"nameHasChanged")},groupName:{get:dojo.hitch(this,"groupName"),hasChanged:dojo.hitch(this,"nameHasChanged")},uiMonitorLink:{get:dojo.hitch(this,"uiMonitorLink")},uiMonitorPath:{get:dojo.hitch(this,"uiMonitorPath")},uiMonitorLinkText:{get:dojo.hitch(this,"uiMonitorLinkText")},uiRoleLink:{get:dojo.hitch(this,"uiRoleLink")},uiRolePath:{get:dojo.hitch(this,"uiRolePath")},uiRoleLinkText:{get:dojo.hitch(this,"uiRoleLinkText")}});dojo.mixin(this.updateTypes,{"info":{load:this.updateInfo}});},isNull:function(){return this._data.name==null;},nameHasChanged:function(l){return dojo.some(l,"return item.attribute == 'name';");},directoryName:function(){try{return this._data.name.split(";",2)[0];}catch(e){return null;}},groupName:function(){try{return this._data.name.split(";",2)[1];}catch(e){return null;}},wsv1Path:function(){throw Error("Method must be overridden by subclass");},uiMonitorPath:function(){throw Error("Method must be overridden by subclass");},uiMonitorLink:function(_4){var _5=(_4==true||this.force_use_mangled)?this._data.name:this.groupName();return nox.ext.apps.commonui.coreui.base.createLink(this.uiMonitorPath(),_5);},uiMonitorLinkText:function(_6){var _7=(_6==true||this.force_use_mangled)?this._data.name:this.groupName();return "<a href='"+this.uiMonitorPath()+"'>"+_7+"</a>";},uiRolePath:function(){return "/Monitors/Roles/RoleInfo?name="+encodeURIComponent(this.getValue("groupName"));},uiRoleLink:function(){var p=this.uiRolePath();var _9=this.getValue("groupName");return nox.ext.apps.commonui.coreui.base.createLink(p,_9);},uiRoleLinkText:function(){return "<a href='"+this.uiRolePath()+"'>"+this.getValue("groupName")+"</a>";},change_directory:function(_a){_a.directory=_a.name;_a.name=this.groupName();this.full_rename(_a);},rename:function(_b){_b.directory=this.directoryName();this.full_rename(_b);},full_rename:function(_c){if(this.check_name(_c.name)==false){coreui.UpdateErrorHandler.showError("'"+_c.name+"' is an invalid name",{header_msg:"Rename Failed:",hide_retry:true,validation_error:true});return;}if(this.check_name(_c.directory)==false){coreui.UpdateErrorHandler.showError("'"+_c.directory+"' is an invalid directory name",{header_msg:"Rename Failed:",hide_retry:true,validation_error:true});return;}var _d=_c.directory+";"+_c.name;if(_d==this._data.name){return;}var _e=new this.constructor();_e.setValue("name",_d);onExisting=dojo.hitch(coreui.UpdateErrorHandler,"showError","Group '"+_c.name+"' already exists.",{header_msg:"Rename Failed:",hide_retry:true,validation_error:true});onNonexisting=function(){nox.ext.apps.commonui.coreui.getUpdateMgr().rawXhrPut({url:this.wsv1Path(),headers:{"content-type":"application/json"},putData:dojo.toJson({name:_d}),load:dojo.hitch(_e,function(_f,_10){if(_c.onComplete!=null){_c.onComplete.call(dojo.global,_e);}}),timeout:30000,errorHandlers:{400:function(_11,_12,_13,_14){coreui.UpdateErrorHandler.showError(_11.responseText,{auto_show:true,header_msg:"Rename Failed:"});}}});};_e.check_exist(onExisting,dojo.hitch(this,onNonexisting));},parentGroupStore:function(){throw Error("Method must be overridden by subclass");},principalMemberStore:function(){throw Error("Method must be overridden by subclass");},subgroupMemberStore:function(){throw Error("Method must be overridden by subclass");},updateInfo:function(_15){return this._xhrGetMixin("info",this.wsv1Path());},direct_member_path:function(_16,_17){return this.wsv1Path()+"/principal/"+encodeURIComponent(_16)+"/"+encodeURIComponent(_17);},subgroup_path:function(_18,_19){return this.wsv1Path()+"/subgroup/"+encodeURIComponent(_18)+"/"+encodeURIComponent(_19);},exists:function(_1a){nox.ext.apps.commonui.coreui.getUpdateMgr().xhrGet({url:this.wsv1Path(),headers:{"content-type":"application/json"},load:function(_1b,_1c){_1a.call(dojo.global,true);},error:function(_1d,_1e){_1a.call(dojo.global,false);},timeout:30000});},deleteOnServer:function(_1f){this._do_modify_request(this.wsv1Path(),"DELETE",_1f);},create:function(_20){this._do_modify_request(this.wsv1Path(),"PUT",_20);},check_exist:function(_21,_22){cb=function(_23){if(_23){_21.call(dojo.global);}else{_22.call(dojo.global);}};this.exists(dojo.hitch(this,cb));},_patch_callback:function(_24){return function(){nox.ext.apps.commonui.coreui.getUpdateMgr().updateNow();if(_24.onComplete!=null){_24.onComplete(arguments);}};},delete_parent:function(_25,_26){var a=_26.split(";",2);var _28={directory:a[0],name:a[1],ctor:_25};this.modify_parent("DELETE",_28);},modify_parent:function(_29,_2a){var _2b=_2a.directory+";"+_2a.name;var _2c=new _2a.ctor({initialData:{name:_2b}});if(_2c.isNull()){throw "invalid parent group name";}var _2d=_2c.subgroup_path(this.directoryName(),this.groupName());var _2e=this._patch_callback(_2a);var cb=dojo.hitch(_2c,"_do_modify_request",_2d,_29,_2e);var _30=dojo.hitch(coreui.UpdateErrorHandler,"showError","Group '"+_2a.name+"' does not exist.",{header_msg:"Modify Failed:",hide_retry:true,validation_error:true});_2c.check_exist(cb,_30);},delete_subgroup:function(_31,_32){var a=_32.split(";",2);var _34={directory:a[0],name:a[1],ctor:_31};this.modify_subgroup("DELETE",_34);},modify_subgroup:function(_35,_36){var _37=_36.directory+";"+_36.name;var _38=new _36.ctor({initialData:{name:_37}});if(_38.isNull()){throw "invalid subgroup name";}var _39=this.subgroup_path(_36.directory,_36.name);var _3a=this._patch_callback(_36);var cb=dojo.hitch(this,"_do_modify_request",_39,_35,_3a);var _3c=dojo.hitch(coreui.UpdateErrorHandler,"showError","Group '"+_36.name+"' does not exist.",{header_msg:"Modify Failed:",hide_retry:true,validation_error:true});_38.check_exist(cb,_3c);},delete_direct_member:function(_3d){var a=_3d.split(";",2);var _3f={directory:a[0],name:a[1]};this.modify_direct_member("DELETE",_3f);},modify_direct_member:function(_40,_41){var _42=this.direct_member_path(_41.directory,_41.name);var _43=this._patch_callback(_41);if(_41.principal_type!=null&&_41.principal_type!="hostnetname"){var _44;if(_41.principal_type=="switch"){_44=this.dmws.Switch;}else{if(_41.principal_type=="location"){_44=this.dmws.Location;}else{if(_41.principal_type=="user"){_44=this.dmws.User;}else{if(_41.principal_type=="host"){_44=this.dmws.Host;}else{throw "unknown principal type";}}}}var _45=_41.directory+";"+_41.name;var _46=new _44({initialData:{name:_45}});if(_46.isNull()){throw "invalid member name";}var cb=dojo.hitch(this,"_do_modify_request",_42,_40,_43);var _48=function(){var _49=_41.principal_type.substring(0,1).toUpperCase()+_41.principal_type.substring(1);coreui.UpdateErrorHandler.showError(_49+" '"+_41.name+"' in directory '"+_41.directory+"' does not exist.",{header_msg:"Modify Failed:",hide_retry:true,validation_error:true});};_46.check_exist(cb,_48);}else{this._do_modify_request(_42,_40,_43);}},_do_modify_request:function(_4a,_4b,_4c){nox.ext.apps.commonui.coreui.getUpdateMgr().xhr(_4b,{url:_4a,headers:{"content-type":"application/json"},putData:dojo.toJson({}),load:function(_4d,_4e){if(_4c!=null){_4c.call(dojo.global);}},timeout:30000});},track_counts:function(){this.count_subgroups=this.subgroupMemberStore({autoUpdate:{onComplete:dojo.hitch(this,function(){this.setValue("subgroup_cnt",this.count_subgroups.itemCount());})}});this.count_members=this.principalMemberStore({autoUpdate:{onComplete:dojo.hitch(this,function(){this.setValue("member_cnt",this.count_members.itemCount());})}});},saveGroup:function(_4f){var _50={name:this._data.name};if(this._data.description!=null){_50["description"]=this._data.description;}var _51;if(_4f!=null&&_4f["errorHandlers"]!=null){_51=_4f["errorHandlers"];}else{_51={400:function(_52,_53,_54,_55){nox.ext.apps.commonui.coreui.UpdateErrorHandler.showError(_52.responseText,{auto_show:true,header_msg:"Save failed"});}};}nox.ext.apps.commonui.coreui.getUpdateMgr().rawXhrPut({url:this.wsv1Path(),headers:{"content-type":"application/json"},putData:dojo.toJson(_50),timeout:30000,errorHandlers:_51});}});dojo.declare("nox.ext.apps.commonui.directory.PrincipalGroupUtil",[],{dmws:nox.ext.apps.commonui.directory,show_modify_dialog:function(_56,_57,_58,_59,_5a){var _5b=dijit.byId("modify_group_id");if(_5b){_5b.destroy();}var _5c={id:"modify_group_id",group:_57,type:_58,title:_59,ctor:_5a,principal_type:_56};_5b=new nox.ext.apps.commonui.directory.GroupModifyDialog(_5c);dojo.body().appendChild(_5b.domNode);_5b.startup();_5b.show();return _5b;},setup_infopage_edit_hooks:function(_5d,_5e,_5f,_60,_61){if(principal_group_editable){var _62=dojo.byId("add_direct_member_link");if(_62!=null){dojo.connect(_62,"onclick",dojo.hitch(this,"show_modify_dialog",_5d,_5e,"member","Add "+_5d.substring(0,1).toUpperCase()+_5d.substring(1)+" Member",_5f));}var _63=dijit.byId("delete_direct_member_link");if(_63!=null){dojo.connect(_63,"onClick",function(){var _64=_60.selection.getSelected();dojo.forEach(_64,function(_65){_5e.delete_direct_member(_65.fullName());_61.deleteItem(_65);});});}}else{dijit.byId("add_direct_member_link").attr("disabled",true);dijit.byId("delete_direct_member_link").attr("disabled",true);}},setup_listpage_edit_hooks:function(_66,_67,_68,_69,_6a){dojo.connect(dijit.byId("add_group_button"),"onClick",function(){var _6b=dmws.getPrincipalGroupUtil().show_modify_dialog(_66,null,"group","Add "+_66.substring(0,1).toUpperCase()+_66.substring(1)+" Group",_68);dojo.connect(_6b,"onChange",_67,"update");});dojo.connect(dijit.byId("remove_group_button"),"onClick",function(){var _6c=_69.selection.getSelected();for(var i in _6c){var _6e=_6c[i];if(_6a!=undefined&&!_6a(_6e.groupName())){coreui.UpdateErrorHandler.showError("Removing '"+_6e.groupName()+"' not allowed",{header_msg:"Remove Failed:",hide_retry:true,validation_error:true});return;}var _6f=_6e.getValue("directoryName");var q={name:_6f};q["write_"+_66+"_enabled"]=true;var _71=false;dmws.Directories.datastore.fetch({query:q,onItem:function(_72){if(_71){return;}_71=true;_6e.deleteOnServer(function(){_67.deleteItem(_6e);if(_6e.count_subgroups){_6e.count_subgroups.destroy();}if(_6e.count_members){_6e.count_members.destroy();}coreui.getUpdateMgr().updateNow();});},onComplete:function(){if(!_71){coreui.UpdateErrorHandler.showError("Cannot remove a group from read-only directory '"+_6f+"'",{header_msg:"Directory Removal Failed:",hide_retry:true,validation_error:true});}}});}});},get_group_not_found_fn:function(_73,_74){return function(_75,_76){coreui.UpdateErrorHandler.showError("No "+_73+" group named "+_74+" exists.",{hide_dismiss:true,header_msg:"Group Not Found:"});};}});(function(){var _77=nox.ext.apps.commonui.directory;var _78=null;_77.getPrincipalGroupUtil=function(){if(_78==null){_78=new _77.PrincipalGroupUtil();}return _78;};})();}