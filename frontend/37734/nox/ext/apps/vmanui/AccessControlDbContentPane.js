/* Copyright (c) 2008, 2009, 2010 Nicira, Inc. */

if(!dojo._hasResource["nox.ext.apps.vmanui.AccessControlDbContentPane"]){dojo._hasResource["nox.ext.apps.vmanui.AccessControlDbContentPane"]=true;dojo.provide("nox.ext.apps.vmanui.AccessControlDbContentPane");dojo.require("dojo.parser");function byId(id,_2){var _3=dojo.query("[id="+id+"]",_2);return (_3.length>0)?_3[0]:null;};dojo.declare("nox.ext.apps.vmanui.AccessControlDbContentPane",nox.ext.apps.vmanui.DbContentPane,{pm:null,top_layer:null,parse_results:null,read_only:null,parseOnLoad:false,constructor:function(){this.show_desc=true;this.read_only=false;this.ui_state={};this.expanded_state={};this.hasPolicy=true;this.lastRoleStack=null;this.vmanui=nox.ext.apps.vmanui;},postMixInProperties:function(){this.inherited(arguments);dojo.connect(this,"onUnload",this,function(){if(this.pm){this.pm.cancel();}});},postCreate:function(){this.inherited(arguments);},doubleBufferCallback:function(_4){this.vmanui.main.set_document_subtitle("Access Control");var d1=new dojo.Deferred();var _6=document.createElement("div");_6.innerHTML=_4;var _7=byId("policy_div",_6);if(!_7){return;}dojo.addClass(_7,this.read_only?"policy_readonly":"policy_edit");var _8=byId("role_uid",_6).value;if(!this.ui_state[_8]){this.ui_state[_8]={visibility_state:{},role_to_show:{}};}if(this.pm){this.pm.cancel();}this.lastPm=this.pm;this.pm=new nox.ext.apps.vmanui.PolicyManager(_8);this.pm.initialize().addCallback(dojo.hitch(this,"pmCallback",d1,_7,_6));return d1;},pmCallback:function(d,_a,_b,_c){try{if(this.pm.isCanceled()){d.cancel();return;}var _d=this.needRefresh();this.lastRoleStack=dojo.clone(this.pm.role_stack);if(!_d){this.pm=this.lastPm;d.callback(null);return;}if(!_c){_a.innerHTML="<center>Error loading ACL data</center>";d.callback(_b);return;}this.destroyWidgets();this.parse_results=dojo.parser.parse(_b,true);if(this.top_layer){this.top_layer.destroyRecursive();}this.top_layer=new nox.ext.apps.vmanui.role_policy_layer({role_index:0,policy_manager:this.pm,is_stats:false,is_readonly:this.read_only});this.top_layer.startup();dojo.connect(this.top_layer,"onModify",this.vmanui.main.editStarted);this.enforceVisibility();this.sync_to_expand(true);this.top_layer.changeShowDesc(this.show_desc);dojo.connect(this.top_layer,"onShowDescChange",this,function(_e){this.show_desc=_e;});_a.appendChild(this.top_layer.domNode);}catch(e){this.vmanui.main.vmanui_error("Error drawing ACLs: ",e);this.vmanui.main.console_log("acl-draw err: ",e);}dojo.connect(dijit.byId("save_role_btn",_b),"onClick",dojo.hitch(this,function(){var d=this.pm.saveAll();d.addErrback(dojo.hitch(this.vmanui.main,"vmanui_error","Failed to Save Policy Changes"));d.addCallback(dojo.hitch(this,function(){dijit.byId("save_role_btn",_b).attr("disabled",true);dijit.byId("reset_role_btn",_b).attr("disabled",true);this.vmanui.main.editFinished();nox.ext.apps.vmanui.main.refresh_current(false,true);}));}));dojo.connect(dijit.byId("reset_role_btn",_b),"onClick",this,function(){this.vmanui.main.refresh_current(true);this.vmanui.main.editFinished();});dojo.connect(byId("policy_expand_link",_b),"onclick",dojo.hitch(this,function(){var _10=this.top_layer.getBottomLayer();var uid=_10.uid;this.expanded_state[uid]=!this.expanded_state[uid];this.sync_to_expand();}));dojo.connect(this.pm,"onModify",this,function(_12){this.vmanui.main.editStarted();dijit.byId("save_role_btn").attr("disabled",false);dijit.byId("reset_role_btn").attr("disabled",false);});d.callback(_b);},enforceVisibility:function(_13){if(this.top_layer){this.top_layer.recursiveEnforceVisibility();}},sync_to_expand:function(_14){if(this.top_layer){var _15=this.top_layer.policy_manager.role_stack.length;var _16=dijit.byId("policy_expand_link");dojo.removeClass(_16.domNode,"hidden");if(_15<=1){dojo.addClass(_16.domNode,"hidden");}else{var _17=this.top_layer.getBottomLayer();var _18=this.expanded_state[_17.uid];_16.attr("label",(_18?"Collapse All":"Expand All"));}if(!_14){this.top_layer.recursiveSetVisibility(_18);}}},destroyWidgets:function(){if(!this.parse_results){return;}dojo.forEach(this.parse_results,function(w){if(w.destroyRecursive&&w.domNode){w.destroyRecursive();}});this.parse_results=[];}});}