/* Copyright (c) 2008, 2009, 2010 Nicira, Inc. */

if(!dojo._hasResource["nox.ext.apps.vmanui.PortConfigDbContentPane"]){dojo._hasResource["nox.ext.apps.vmanui.PortConfigDbContentPane"]=true;dojo.provide("nox.ext.apps.vmanui.PortConfigDbContentPane");dojo.require("dojo.parser");function byId(id,_2){var _3=dojo.query("[id="+id+"]",_2);return (_3.length>0)?_3[0]:null;};dojo.declare("nox.ext.apps.vmanui.PortConfigDbContentPane",nox.ext.apps.vmanui.DbContentPane,{pm:null,top_qos_layer:null,top_rspan_layer:null,parse_results:null,read_only:false,parseOnLoad:false,doubleBufferCallback:function(_4){nox.ext.apps.vmanui.main.set_document_subtitle("Port Configuration");var _5=nox.ext.apps.vmanui;var d1=new dojo.Deferred();var _7=document.createElement("div");_7.innerHTML=_4;var _8=byId("qos_div",_7);var _9=byId("rspan_div",_7);if(!_8||!_9){return;}var _a=byId("port_role_uid",_7).value;if(this.pm){this.pm.cancel();}this.pm=new nox.ext.apps.vmanui.PolicyManager(_a);this.pm.initialize().addCallback(dojo.hitch(this,function(_b){try{if(this.pm.isCanceled()){d1.cancel();return;}if(!_b){policy_node.innerHTML="<center>Error loading Port Configuration data</center>";d1.callback(_7);return;}this.destroyWidgets();this.parse_results=dojo.parser.parse(_7,true);var _c=dijit.byId("disable_mac_spoof_check");if(_c){var _d=this.pm.getDisableMACSpoof(_a);_c.setValue(_d=="true");_c.setAttribute("disabled",this.read_only);this.connect(_c,"onClick",function(e){_5.main.editStarted();dijit.byId("save_port_config_btn").attr("disabled",false);dijit.byId("reset_port_config_btn").attr("disabled",false);var _f=dojo.byId("port_role_uid");if(_f){var uid=_f.value;this.pm.setDisableMACSpoof(uid,_c.getValue());}});}if(this.top_qos_layer){this.top_qos_layer.destroyRecursive();}if(this.top_rspan_layer){this.top_rspan_layer.destroyRecursive();}this.top_qos_layer=new nox.ext.apps.vmanui.role_qos_layer({role_index:0,policy_manager:this.pm,is_readonly:this.read_only});this.top_qos_layer.startup();_8.appendChild(this.top_qos_layer.domNode);this.top_rspan_layer=new nox.ext.apps.vmanui.role_rspan_layer({role_index:0,policy_manager:this.pm,is_readonly:this.read_only});this.top_rspan_layer.startup();_9.appendChild(this.top_rspan_layer.domNode);dojo.connect(dijit.byId("save_port_config_btn"),"onClick",this,function(){if(!this.top_qos_layer||!this.top_qos_layer.recursiveInputIsValid()){_5.main.vmanui_error("Invalid QoS settings");return;}if(!this.top_rspan_layer||!this.top_rspan_layer.recursiveInputIsValid()){_5.main.vmanui_error("Invalid RSPAN settings");return;}var d=this.pm.saveAll();d.addErrback(function(){_5.main.vmanui_error("Failed to Save Port Configuration Changes");});d.addCallback(function(){dijit.byId("save_port_config_btn").attr("disabled",true);dijit.byId("reset_port_config_btn").attr("disabled",true);_5.main.editFinished();});});dojo.connect(dijit.byId("reset_port_config_btn"),"onClick",function(){_5.main.refresh_current(false);_5.main.editFinished();});var _12=function(_13){dijit.byId("save_port_config_btn").attr("disabled",!_13);};dojo.connect(this.top_qos_layer,"onIsValidChange",_12);dojo.connect(this.top_rspan_layer,"onIsValidChange",_12);dojo.connect(this.pm,"onModify",function(_14){dijit.byId("reset_port_config_btn").attr("disabled",false);});}catch(e){_5.main.vmanui_error("Error drawing Port Config:"+e);_5.main.console_log("err: ",e);}d1.callback(_7);}));return d1;},postMixInProperties:function(){this.inherited(arguments);dojo.connect(this,"onUnload",this,function(){if(this.pm){this.pm.cancel();}});},destroyWidgets:function(){if(!this.parse_results){return;}dojo.forEach(this.parse_results,function(w){if(w.destroyRecursive&&w.domNode){w.destroyRecursive();}});this.parse_results=[];}});}