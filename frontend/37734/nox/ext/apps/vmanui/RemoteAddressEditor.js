/* Copyright (c) 2008, 2009, 2010 Nicira, Inc. */

if(!dojo._hasResource["nox.ext.apps.vmanui.RemoteAddressEditor"]){dojo._hasResource["nox.ext.apps.vmanui.RemoteAddressEditor"]=true;dojo.provide("nox.ext.apps.vmanui.RemoteAddressEditor");dojo.require("dojo.DeferredList");dojo.require("dijit.form.Button");dojo.require("dijit.layout.BorderContainer");dojo.require("dojox.grid.DataGrid");dojo.require("dojox.grid.cells.dijit");dojo.require("dojo.data.ItemFileReadStore");dojo.require("dojo.data.ItemFileWriteStore");dojo.require("dojox.dtl.html");dojo.require("nox.ext.apps.vmanui.BoundedDialog");dojo.declare("nox.ext.apps.vmanui.RemoteAddressEditor",nox.ext.apps.vmanui.BoundedDialog,{templateString:"<div class=\"dijitDialog selectRemoteAddressDialog\" tabindex=\"-1\" waiState=\"labelledby-${id}_title\">\n  <div dojoAttachPoint=\"titleBar\" class=\"dijitDialogTitleBar\">\n    <span dojoAttachPoint=\"titleNode\" class=\"dijitDialogTitle\" id=\"${id}_title\"></span>\n    <span dojoAttachPoint=\"closeButtonNode\" class=\"dijitDialogCloseIcon\" dojoAttachEvent=\"onclick: onCancel\" title=\"${buttonCancel}\">\n      <span dojoAttachPoint=\"closeText\" class=\"closeText\" title=\"${buttonCancel}\">x</span>\n    </span>\n  </div>\n  <div dojoAttachPoint=\"containerNode\" >\n    <div dojoAttachPoint=\"layoutContainer\" style=\"height:480px;width:500px\" dojoType=\"dijit.layout.BorderContainer\" design=\"headline\" gutters=\"false\">\n      <div dojoType=\"dijit.layout.BorderContainer\" design=\"sidebar\" region=\"center\" class=\"contentContainer\" gutters=\"false\">\n        <div dojoAttachPoint=\"left\" class=\"sideContainer\" region=\"left\" style=\"height: 381px; width: 200px;\" dojoType=\"dijit.layout.BorderContainer\" design=\"headline\" gutters=\"false\">\n          <div dojoType=\"dijit.layout.ContentPane\" region=\"top\" class=\"tableHeader\">\n              Other Address Groups\n          </div>\n          <!-- list goes here -->\n\n          <div dojoType=\"dijit.layout.ContentPane\" minSize=35 region=\"bottom\" class=\"bottomPane\"></div>\n        </div>\n        <div dojoAttachPoint=\"center\" region=\"center\" dojoType=\"dijit.layout.ContentPane\" class=\"middleButtonContainer\">\n          <button dojoType=\"dijit.form.Button\" dojoAttachPoint=\"addOne\" dojoAttachEvent=\"onClick: onAddOne\">&#62;&#62;</button>\n          <br/>\n          <button dojoType=\"dijit.form.Button\" dojoAttachPoint=\"remOne\" dojoAttachEvent=\"onClick: onRemOne\">&#60;&#60;</button>\n          <br/>\n          <hr>\n          <button dojoType=\"dijit.form.Button\" dojoAttachPoint=\"addAll\" dojoAttachEvent=\"onClick: onAddAll\">All &#62;&#62;</button>\n          <br/>\n          <button dojoType=\"dijit.form.Button\" dojoAttachPoint=\"remAll\" dojoAttachEvent=\"onClick: onRemAll\">&#60;&#60; All</button>\n        </div>\n        <div dojoAttachPoint=\"right\" class=\"sideContainer\" region=\"right\" style=\"height: 381px; width: 200px;\" dojoType=\"dijit.layout.BorderContainer\" design=\"headline\" gutters=\"false\">\n          <div dojoType=\"dijit.layout.ContentPane\" region=\"top\" class=\"tableHeader\">\n              Selected Address Groups\n          </div>\n          <!-- list goes here -->\n          <!--\n          <div dojoType=\"dijit.layout.ContentPane\" region=\"center\">\n            <select multiple=\"true\" dojoAttachPoint=\"allGroups\" class=\"item-list-editor-list\"></select>\n          </div>\n          -->\n          <div dojoType=\"dijit.layout.ContentPane\" minSize=35 region=\"bottom\" class=\"bottomPane\">\n            <table width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" style=\"position:absolute; top: 3px;\">\n              <tr>\n                <td width=\"70%\" style=\"padding-right: 5px;\">\n                  <input type=\"text\" dojoType=\"nox.ext.apps.vmanui.regex.NetworkTextBox\" dojoAttachPoint=\"quickAddText\" dojoAttachEvent=\"onFocus: onQuickAddTextFocus, onBlur: onQuickAddTextBlur\" value=\"${quickAddDefaultText}\"/>\n                </td>\n                <td>    \n                  <button dojoType=\"dijit.form.Button\" dojoAttachPoint=\"quickAddButton\" dojoAttachEvent=\"onClick: onQuickAddClicked\" >Add</button>\n                </td> \n              </tr>\n            </table>\n          </div>\n        </div>\n      </div>\n\n      <div dojoType=\"dijit.layout.ContentPane\" region=\"bottom\">\n        <div class=\"dialogButtonContainer\">\n<!--\n          <div style=\"text-align: left;\"> \n            <input dojoType=\"dijit.form.CheckBox\" dojoAttachPoint=\"invert_radio\" /> \n            Invert Selection: Match address EXCEPT those selected. \n          </div> \n-->\n          <button class=\"blueButton\" dojoType=\"dijit.form.Button\" dojoAttachPoint=\"doneButton\" dojoAttachEvent=\"onClick: onExecute\">Done</button>\n          <button dojoType=\"dijit.form.Button\" dojoAttachPoint=\"cancelButton\" dojoAttachEvent=\"onClick: onCancel\">Cancel</button>\n        </div>\n      </div>\n\n    </div>\n  </div>\n</div>\n",widgetsInTemplate:true,quickAddDefaultText:"",buttonCancel:"",layoutContainer:null,policy_manager:null,acl_widget:null,postMixInProperties:function(){this.allStore=this.policy_manager.getNWAddrGroupStore();var _1=[];var _2=this.acl_widget.acl.remote_groups;var i;for(i=0;i<_2.length;i++){var _4=_2[i];var _5=this.policy_manager.getNWAddrGroup(_4).name;_1.push({uid:_4,name:_5,type:"group"});}var _6=this.acl_widget.acl.remote_customs;for(i=0;i<_6.length;i++){var c=_6[i];_1.push({uid:c,name:c,type:"custom"});}this.selectedStore=new dojo.data.ItemFileReadStore({data:{identifier:"uid",label:"name",items:_1}});},postCreate:function(){this.inherited(arguments);var d1=new dojo.Deferred();var d2=new dojo.Deferred();var dl=new dojo.DeferredList([d1,d2]);dl.addCallback(this,function(_b){var _c=_b[0][1];var _d=_b[1][1];var _e=dojo.hitch(this,function(_f){var _10=false;dojo.forEach(_d,function(_11){if(this.selectedStore.isItem(_11)&&this.allStore.isItem(_f)&&this.selectedStore.getValue(_11,"uid")==this.allStore.getValue(_f,"uid")){_10=true;}},this);return _10;});var _12=[];var i,_14;dojo.forEach(_c,function(_15){if(!_e(_15)){_12.push(_15);}});this.tempAllStore=new dojo.data.ItemFileWriteStore({data:{items:_12}});var _16=[{name:"Groups",field:"name",width:"100%",editable:false,type:dojox.grid.cells._Widget}];var _17=this.leftGrid=new dojox.grid.DataGrid({store:this.tempAllStore,query:{},structure:_16,region:"center"});this.left.addChild(_17);_17.startup();_12=[];dojo.forEach(_d,function(_18){_12.push(_18);});this.tempSelectedStore=new dojo.data.ItemFileWriteStore({data:{items:_12}});var _19=[{name:"Groups",field:"name",width:"100%"}];var _1a=this.rightGrid=new dojox.grid.DataGrid({store:this.tempSelectedStore,query:{},structure:_19,region:"center"});this.right.addChild(_1a);_1a.startup();this.layoutContainer.resize();});this.allStore.fetch({query:{},onComplete:function(_1b){d1.callback(_1b);},onError:function(){nox.ext.apps.vmanui.main.vmanui_error("Error loading all address data");}});this.selectedStore.fetch({query:{},onComplete:function(_1c){d2.callback(_1c);},onError:function(e){nox.ext.apps.vmanui.main.vmanui_error("Error loading selected address data");}});var _1e=this.acl_widget.acl.invert_remote_addresses;},_moveItems:function(_1f,_20,_21,_22){var _23=_1f.selection.getSelected();dojo.forEach(_23,function(_24){if(!_22||_24.type=="group"){var _25={"uid":_20.getValue(_24,"uid"),"name":_20.getValue(_24,"name"),"type":"group"};_21.newItem(_25);}_20.deleteItem(_24);});_21.save();_20.save();},_moveAll:function(_26,_27,_28){_26.fetch({query:{},onComplete:function(_29){dojo.forEach(_29,function(_2a){if(!_28||_2a.type=="group"){var _2b={"uid":_26.getValue(_2a,"uid"),"name":_26.getValue(_2a,"name"),"type":"group"};_27.newItem(_2b);}_26.deleteItem(_2a);});_27.save();_26.save();}});},onAddOne:function(){this._moveItems(this.leftGrid,this.tempAllStore,this.tempSelectedStore,false);},onRemOne:function(){this._moveItems(this.rightGrid,this.tempSelectedStore,this.tempAllStore,true);},onAddAll:function(){this._moveAll(this.tempAllStore,this.tempSelectedStore,false);},onRemAll:function(){this._moveAll(this.tempSelectedStore,this.tempAllStore,true);},_hasAddress:function(_2c){var _2d=false;this.tempSelectedStore.fetch({query:{},onItem:function(_2e){if(_2e.name==_2c){_2d=true;}}});return _2d;},_addNameToStore:function(_2f){if(this._hasAddress(_2f)){return;}this.tempSelectedStore.newItem({uid:_2f,name:_2f,type:"custom"});},onQuickAddTextFocus:function(){var _30=dojo.trim(this.quickAddText.attr("value"));if(_30==this.quickAddDefaultText){this.quickAddText.attr("value","");this.quickAddText.focus();}},onQuickAddTextBlur:function(){var _31=dojo.trim(this.quickAddText.attr("value"));if(_31.length===0){this.quickAddText.attr("value",this.quickAddDefaultText);}},onQuickAddClicked:function(){if(!this.quickAddText.isValid()){return;}var _32=dojo.trim(this.quickAddText.attr("value"));if(_32!=this.quickAddDefaultText&&_32.length>0){var _33=_32.split(/\s*,\s*/);dojo.forEach(_33,this._addNameToStore,this);}this.quickAddText.attr("value",this.quickAddDefaultText);},onExecute:function(){this.tempSelectedStore.fetch({query:{},onComplete:dojo.hitch(this,function(_34){var _35=[];var _36=[];for(var i=0;i<_34.length;i++){var _38=this.tempSelectedStore.getValue(_34[i],"type");var uid=this.tempSelectedStore.getValue(_34[i],"uid");if(_38=="group"){_36.push(uid);}else{_35.push(uid);}}var _3a=this.acl_widget.role_widget.get_role();var acl=this.acl_widget.acl;acl.remote_customs=_35;acl.remote_groups=_36;acl.invert_remote_addresses=false;_3a.acl_rules[acl.ui_index]=acl;this.policy_manager.setRole(_3a);this.acl_widget.role_widget.redraw_acls();})});this.hide();},hide:function(){this.inherited(arguments);this.destroyRecursive();}});}