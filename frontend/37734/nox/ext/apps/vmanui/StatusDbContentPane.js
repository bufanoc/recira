/* Copyright (c) 2008, 2009, 2010 Nicira, Inc. */

if(!dojo._hasResource["nox.ext.apps.vmanui.StatusDbContentPane"]){dojo._hasResource["nox.ext.apps.vmanui.StatusDbContentPane"]=true;dojo.provide("nox.ext.apps.vmanui.StatusDbContentPane");dojo.require("dojo.parser");function byId(id,_2){var _3=dojo.query("[id="+id+"]",_2);return (_3.length>0)?_3[0]:null;};dojo.declare("nox.ext.apps.vmanui.StatusDbContentPane",nox.ext.apps.vmanui.DbContentPane,{pm:null,vif_top_layer:null,old_vif_top_layer:null,parse_results:null,show_desc:true,constructor:function(){this.hasPolicy=true;this.lastRoleStack=null;this.vmanui=nox.ext.apps.vmanui;},postMixInProperties:function(){this.inherited(arguments);var h=dojo.connect(this,"onUnload",this,function(){if(this.pm){this.pm.cancel();}dojo.disconnect(h);});},doubleBufferCallback:function(_5){var t=this.vmanui.vac.node_types;var _7=this.vmanui.vac_status._get_current_node_type();if(_7===null){return _5;}switch(_7){case t.NETWORK_VIF:case t.SERVER_NETWORK_VIF:case t.SERVER_VIF:case t.VM_VIF:case t.ADMIN_VIF:this.parseOnLoad=false;break;default:this.parseOnLoad=true;return;}var _8=document.createElement("div");_8.innerHTML=_5;var _9=byId("iface_stats",_8);var d1=new dojo.Deferred();var _b="vif;"+byId("uid",_8).value;if(this.pm){this.pm.cancel();}this.lastPm=this.pm;this.pm=new nox.ext.apps.vmanui.PolicyManager(_b);this.pm.initialize().addCallback(dojo.hitch(this,"pmCallback",d1,_9,_8));return d1;},pmCallback:function(d,_d,_e,_f){try{if(this.pm.isCanceled()){d.cancel();return;}var _10=this.needRefresh();this.lastRoleStack=dojo.clone(this.pm.role_stack);if(!_10){d.callback(null);this.pm=this.lastPm;return;}if(this._h_vif_top){dojo.disconnect(this._h_vif_top);}if(!_f){_d.innerHTML="<center>Error loading VIF ACLs</center>";d.callback(_e);return;}this.parse_results=dojo.parser.parse(_e,true);this.old_vif_top_layer=this.vif_type_layser;this.vif_top_layer=new nox.ext.apps.vmanui.role_policy_layer({role_index:0,policy_manager:this.pm,is_stats:true,is_readonly:true});this.vif_top_layer.startup();this.vif_top_layer.recursiveSetVisibility(true);this.vif_top_layer.changeShowDesc(this.show_desc);this._h_vif_top=dojo.connect(this.vif_top_layer,"onShowDescChange",this,function(_11){this.show_desc=_11;this.fill_acl_stats();});this.recursivelyConnectSetVisibility(this.vif_top_layer);dojo.addClass(_d,"policy_readonly");_d.appendChild(this.vif_top_layer.domNode);var mac=byId("mac_addr",_e).value;nox.ext.apps.vmanui.xhrGet({url:"/ws.v1/vmac/"+mac+"/aclcount",preventCache:true,handleAs:"json",timeout:3000,load:dojo.hitch(this,function(res){this.acl_stats_map=res;this.fill_acl_stats();})});d.callback(_e);if(this.old_vif_top_layer){this.old_vif_top_layer.destroyRecursive();this.old_vif_top_layer=null;}}catch(e){console.log(e);this.vmanui.main.vmanui_error("Error drawing ACL Stats");this.vmanui.main.console_log("Error drawing ACL Stats",e);}},recursivelyConnectSetVisibility:function(_14){dojo.connect(_14,"setVisibility",this,function(_15){if(_15){this.fill_acl_stats();}});if(_14.child){this.recursivelyConnectSetVisibility(_14.child);}},fill_acl_stats:function(){for(var id in this.acl_stats_map){var s=dojo.byId("acl-hits-uid-"+id);if(s){s.innerHTML=this.acl_stats_map[id];}}},destroyWidgets:function(){if(!this.parse_results){return;}dojo.forEach(this.parse_results,function(w){if(w.destroyRecursive&&w.domNode){w.destroyRecursive();}});this.parse_results=[];}});}