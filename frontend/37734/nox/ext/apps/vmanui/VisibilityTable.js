/* Copyright (c) 2008, 2009, 2010 Nicira, Inc. */

if(!dojo._hasResource["nox.ext.apps.vmanui.VisibilityTable"]){dojo._hasResource["nox.ext.apps.vmanui.VisibilityTable"]=true;dojo.provide("nox.ext.apps.vmanui.VisibilityTable");dojo.require("dojo.number");dojo.require("dojo.DeferredList");dojo.require("nox.ext.apps.vmanui.util");dojo.require("nox.ext.apps.vmanui.menu_creator");dojo.declare("nox.ext.apps.vmanui.VisibilityTable",[dijit._Widget,dijit._Templated],{templateString:"<div class=\"visibility_table\">\n  <div style=\"border-bottom:1px solid #CCCCCC;margin-bottom:5px;text-align:right;\">\n    <span class=\"netflow_pool_warning\" style=\"visibility:visible;float:left;\" dojoAttachPoint=\"netflow_config_warning\">\n      <span style=\"color:red;font-weight:bold\">Warning:</span> <span class=\"link\" dojoAttachPoint=\"pool_warning_label\">One or more selected pools</span> is not configured to forward NetFlow records to ${app_name_short}\n    </span>\n    <span>${interval_str}</span>\n  </div>\n  <table dojoAttachPoint=\"bidir_table\" class=\"visibility_table_bidir\">\n    <tbody>\n      <tr>\n        <td dojoAttachPoint=\"bidir_in_table_cell\" class=\"bidir_table_cell inbound_table_cell\"></td>\n        <td dojoAttachPoint=\"bidir_out_table_cell\" class=\"bidir_table_cell outbound_table_cell\"></td>\n      </tr>\n    </tbody>\n  </table>\n  <div dojoAttachPoint=\"unidir_table\" class=\"visibility_table_unidir\"></div>\n</div>\n",manager:null,interval:null,interval_str:null,direction:null,bin_type:null,count_type:null,tree_uid:null,in_totals:null,out_totals:null,in_sum:null,out_sum:null,max_items:null,pools_to_warn:null,constructor:function(){this.manager=null;this.interval=1;this.interval_str="";this.direction="";this.bin_type="";this.count_type="";this.tree_uid="";this.in_totals=[];this.out_totals=[];this.in_sum=null;this.out_sum=null;this.max_items=10;this.pools_to_warn=[];this.netflowWarningMenu=null;this.totalsTables={};},postMixInProperties:function(){this.app_name_short=nox.ext.apps.vmanui.main.app_name_short;this.in_sum=parseInt(this.in_sum)||null;this.out_sum=parseInt(this.out_sum)||null;},postCreate:function(){this.treeNode=nox.ext.apps.vmanui.main.current_tree_item;this.buildPhrases();dojo.removeClass(this.bidir_table,"hidden");dojo.removeClass(this.unidir_table,"hidden");if(this.direction=="bidir"){this.buildBidirectionalTable();}else{this.buildUnidirectionalTable(this.direction);}this.buildNetflowWarning();},buildNetflowWarning:function(){if(this.pools_to_warn.length){this.buildNetflowWarningMenu();dojo.style(this.netflow_config_warning,{visibility:"visible"});}else{dojo.style(this.netflow_config_warning,{visibility:"hidden"});}},buildNetflowWarningMenu:function(){var _1=[];var aD=[];dojo.forEach(this.pools_to_warn,function(_3){var d=nox.ext.apps.vmanui.xhrGet({url:"/ws.v1/xen_directory/"+_3,handleAs:"json",load:function(r){return [_3,r.name];}});aD.push(d);},this);var _6=new dojo.DeferredList(aD);_6.addCallback(dojo.hitch(this,function(r){_1=dojo.map(r,function(_8){return _8[1];});var _9=nox.ext.apps.vmanui.menu_creator.creator;this.netflowWarningMenu=_9.create_netflow_warning_menu(this.pool_warning_label,_1);}));},buildPhrases:function(){this.binPhrase="";this.scopePhrase="";var _a=this.treeNode.node_type;var _b=nox.ext.apps.vmanui.util.escapeMarkup(this.treeNode.name);var nt=nox.ext.apps.vmanui.vac.node_types;if(this.bin_type=="host"){this.binPhrase="by source VM";}else{if(this.bin_type=="l3proto"){this.binPhrase="by protocol";}else{if(this.bin_type=="l4proto"){this.binPhrase="by application";}else{if(this.binType=="ip"){this.binPhrase="by source IP";}else{}}}}switch(_a){case nt.ALL_POOLS:case nt.ADMIN_GROUPS:case nt.ADMIN_NETWORKS:this.scopePhrase="all resource pools";break;case nt.POOL:this.scopePhrase="resource pool '"+_b+"'";break;case nt.NETWORKS:this.scopePhrase="selected resource pool";break;case nt.NETWORK:this.scopePhrase="VMs on network '"+_b+"'";break;case nt.VM:this.scopePhrase="VM '"+_b+"'";break;case nt.VM_VIF:this.scopePhrase="VM interface '"+_b+"'";break;case nt.NETWORK_VM:this.scopePhrase="VM '"+_b+"' on selected Network";break;case nt.VMS:this.scopePhrase="selected resource pool";break;case nt.SERVERS:this.scopePhrase="selected resource pool";break;case nt.SERVER_NETWORKS:this.scopePhrase="VMs on selected server";break;case nt.SERVER_NETWORK:this.scopePhrase="VMs on network '"+_b+"' on selected server";break;case nt.SERVER_NETWORK_VM:this.scopePhrase="VM '"+_b+"' on selected Network";break;case nt.SERVER:this.scopePhrase="all VMs on server '"+_b+"'";break;case nt.ADMIN_GROUP:this.scopePhrase="VM group '"+_b+"'";break;case nt.ADMIN_NET:this.scopePhrase="address group '"+_b+"'";break;case nt.ADMIN_NET_GROUP:this.scopePhrase="address group '"+_b+"'";break;default:this.scopePhrase=_b?"'"+_b+"'":"selected group";}},buildUnidirectionalTable:function(_d){dojo.addClass(this.bidir_table,"hidden");dojo.addClass(this.bidir_table,_d);var _e=(_d=="in")?this.in_totals:this.out_totals;var _f=(_d=="in")?this.in_sum:this.out_sum;if(_e.length>this.max_items){var _10=this.trunc_msg(_e.length);dojo.place(_10,this.unidir_table,"last");}this.totalsTables.uni=this.addTotalsTable(this.unidir_table,_e,_f,_d);this.manager.styleSortIcons(_d,this.totalsTables.uni);},buildBidirectionalTable:function(){dojo.addClass(this.unidir_table,"hidden");if(this.in_totals.length>this.max_items){var _11=this.trunc_msg(this.in_totals.length);dojo.place(_11,this.bidir_in_table_cell,"last");}if(this.out_totals.length>this.max_items){var _11=this.trunc_msg(this.out_totals.length);dojo.place(_11,this.bidir_out_table_cell,"last");}this.totalsTables.bi_in=this.addTotalsTable(this.bidir_in_table_cell,this.in_totals,this.in_sum,"in",true);this.manager.styleSortIcons("in",this.totalsTables.bi_in);this.totalsTables.bi_out=this.addTotalsTable(this.bidir_out_table_cell,this.out_totals,this.out_sum,"out",true);this.manager.styleSortIcons("out",this.totalsTables.bi_out);},addTotalsTable:function(_12,_13,_14,_15,_16){var _17=(_15=="in")?"Inbound":"Outbound";var _18=this.count_type+"/s";var _19="Source IP";var _1a=nox.ext.apps.vmanui.util.toUpperFirst(this.count_type);if(this.count_type=="bits"){_18="Kbit/s";}else{if(this.count_type=="bytes"){_18="KByte/s";}}if(this.bin_type=="l3proto"){_19="Protocol";}else{if(this.bin_type=="l4proto"){var _1b=(_15=="in")?"client":"server";_19="Application (as "+_1b+")";}else{if(this.bin_type=="host"){_19="Source VM";}}}var _1c=this.titlePhrase(_16?_15:"");var _1d=new nox.ext.apps.vmanui.VisibilityTotalsTable({vis_table:this,table_title:_1c,bin_name:_19,total_units:[_17,_1a].join(" "),rate_units:[_17,"Rate"].join(" "),perc_units:["% of Total"].join(" "),rate_units_abbr:_18});dojo.place(_1d.domNode,_12,"only");dojo.addClass(_1d.domNode,_15);_1d.createRows(_13,_14,this.interval);return _1d;},titlePhrase:function(_1e){var _1f=[];if(_1e=="in"){_1f.push("Inbound");_1f.push(this.count_type);_1f.push("to switch");}else{if(_1e=="out"){_1f.push("Outbound");_1f.push(this.count_type);_1f.push("from switch");}else{_1f.push(nox.ext.apps.vmanui.util.toUpperFirst(this.count_type));_1f.push(this.direction=="in"?"to switch":"from switch");}}_1f.push(this.binPhrase);return _1f.join(" ");},trunc_msg:function(_20){var _21=dojo.doc.createElement("span");dojo.style(_21,{fontSize:"smaller"});var _22=dojo.doc.createTextNode("(Limiting display to first "+this.max_items+" of "+_20+" items)");dojo.place(_22,_21,"only");return _21;},rows:function(){var _23=[];for(var key in this.totalsTables){_23=_23.concat(this.totalsTables[key].rows());}return _23;},uninitialize:function(){if(this.netflowWarningMenu){this.netflowWarningMenu.destroyRecursive();}for(var s in this.totalsTables){var o=this.totalsTables[s];if(o&&dojo.isObject(o)&&dojo.isFunction(o.destroyRecursive)){o.destroyRecursive();}this.totalsTables[s]=null;}this.totalsTables={};this.inherited(arguments);}});dojo.declare("nox.ext.apps.vmanui.VisibilityTotalsTable",[dijit._Widget,dijit._Templated],{templateString:"<div class=\"visibility_totals\">\n  <h2>${table_title}</h2>\n  <table class=\"TableVisibilityStats\" cellspacing=\"0\">\n    <thead>\n      <tr class=\"TableVisibilityStatsHeader\">\n        <th class=\"TableHeaderGradientLight icon_col\">&nbsp;</th>\n        <th class=\"TableHeaderGradientLight\"><a class=\"sort name\">${bin_name}</a><span class=\"sort_icon\"></span></th>\n        <th class=\"TableHeaderGradientLight\"><a class=\"sort total numeric\">${total_units}</a><span class=\"sort_icon\"></span></th>\n        <th class=\"TableHeaderGradientLight\"><a class=\"sort rate numeric\">${rate_units}</a> <span style=\"font-size:smaller\">(${rate_units_abbr})</span><span class=\"sort_icon\"></span></th>\n        <th class=\"TableHeaderGradientLight\"><a class=\"sort perc numeric\">${perc_units}</a></span><span class=\"sort_icon\"></span></th>\n      </tr>\n    </thead>\n    <tbody dojoAttachPoint=\"tbody\">\n    </tbody>\n  </table>\n</div>\n",table_title:null,vis_table:null,bin_name:null,total_units:null,rate_units:null,rate_units_abbr:null,constructor:function(){this.table_title="";this.vis_table=null;this.bin_name="";this.total_units="";this.rate_units="";this.rate_units_abbr="";this.__totals_table_rows=[];},postMixInProperties:function(){this.static_base=nox.ext.apps.vmanui.main.static_base;},postCreate:function(){this.bin_type=this.vis_table?this.vis_table.bin_type:"";this.count_type=this.vis_table?this.vis_table.count_type:"";this.max_items=this.vis_table?this.vis_table.max_items:50;},rows:function(){return this.__totals_table_rows;},empty:function(){dojo.empty(this.tbody);this.__totals_table_rows=[];},createRows:function(_27,_28,_29){dojo.forEach(_27,function(_2a,i){var _2c=_2a[1][0];if(_2c>0){var _2d,_2e;var _2f=_2a[2];_2d=_2f.name;_2e=_2f.tree_uid;var _30=1;if(this.count_type=="bits"||this.count_type=="bytes"){_30=1000;}var _31=_2c/(_30*_29);var _32={};_32.places=(_31<10)?2:0;var _33=new nox.ext.apps.vmanui.VisibilityTotalsTableRow({series_id:_2a[0].join("_"),name:nox.ext.apps.vmanui.util.escapeMarkup(_2d),tree_uid:_2e,total:dojo.number.format(parseInt(_2c)),perc:dojo.number.format(parseInt(_2c)/_28,{type:"percent",places:1}),rate:dojo.number.format(_31,_32)});dojo.place(_33.domNode,this.tbody,"last");dojo.addClass(_33.domNode,i%2?"oddRow":"evenRow");this.__totals_table_rows.push(_33);}},this);},uninitialize:function(){while(this.__totals_table_rows.length){var o=this.__totals_table_rows.pop();if(o&&dojo.isObject(o)&&dojo.isFunction(o.destroyRecursive)){o.destroyRecursive();}o=null;}this.inherited(arguments);}});dojo.declare("nox.ext.apps.vmanui.VisibilityTotalsTableRow",[dijit._Widget,dijit._Templated],{templateString:"<tr class=\"TableVisibilityStatsRow\">\n  <td class=\"TableVisibilityCell TableVisibilityLegendCell\" dojoAttachPoint=\"legendCell\"><img dojoAttachPoint=\"legendImage\" src=\"${static_base}/nox/ext/apps/vmanui/images/legend_fill.png\" /></td>\n  <td class=\"TableVisibilityCell TableVisibilityNameCell\"><span dojoAttachPoint=\"nameSpan\"></span></td>\n  <td class=\"TableVisibilityCell TableVisibilityTotalCell\" dojoAttachPoint=\"totalCell\"></td>\n  <td class=\"TableVisibilityCell TableVisibilityRateCell\" dojoAttachPoint=\"rateCell\"></td>\n  <td class=\"TableVisibilityCell TableVisibilityPercentageCell\" dojoAttachPoint=\"percentageCell\"></td>\n</tr>\n",name:null,tree_uid:null,total:null,rate:null,perc:null,series_id:null,constructor:function(){this.name="";this.tree_uid=null;this.total=0;this.rate=0;this.perc=0;this.series_id="";},attributeMap:dojo.delegate(dijit._Widget.prototype.attributeMap,{name:{node:"nameSpan",type:"innerHTML"},total:{node:"totalCell",type:"innerHTML"},rate:{node:"rateCell",type:"innerHTML"},perc:{node:"percentageCell",type:"innerHTML"}}),postMixInProperties:function(){this.static_base=nox.ext.apps.vmanui.main.static_base;},clickName:function(){nox.ext.apps.vmanui.vac.show_vac_tab("visibility",this.tree_uid);},postCreate:function(){if(this.tree_uid){this.connect(this.nameSpan,"onclick","clickName");dojo.addClass(this.nameSpan,"link");}},fillLegendColor:function(_35){dojo.style(this.legendImage,{backgroundColor:_35});},uninitialize:function(){return this.inherited(arguments);}});}