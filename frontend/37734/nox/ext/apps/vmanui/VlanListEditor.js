/* Copyright (c) 2008, 2009, 2010 Nicira, Inc. */

if(!dojo._hasResource["nox.ext.apps.vmanui.VlanListEditor"]){dojo._hasResource["nox.ext.apps.vmanui.VlanListEditor"]=true;dojo.provide("nox.ext.apps.vmanui.VlanListEditor");dojo.require("dojo.DeferredList");dojo.require("nox.ext.apps.vmanui.ListEditor");dojo.declare("nox.ext.apps.vmanui.VlanListEditor",nox.ext.apps.vmanui.ListEditor,{pool_id:null,network_id:null,vlan_counts:null,constructor:function(){this._baselineValues={};this.vmanui=nox.ext.apps.vmanui;},postMixInProperties:function(){this._readonly=!nox.ext.apps.vmanui.User.hasCapability("update-xen-dir");},postCreate:function(){this.inherited(arguments);if(this._readonly){var _1="all pools";if(this.pool_id){_1="this pool";if(this.network_id){_1="this network";}}this.emptyTextReadOnly.innerHTML="No VLANs configured for "+_1;}else{this.connect(this.delete_button,"onClick","editStarted");this.connect(this.add_button,"onClick","editStarted");}},editStarted:function(){this.vmanui.main.editStarted();},clickItem:function(){this.inherited(arguments);this.vmanui.main.editStarted();},setBaseline:function(){this._baselineValues={};for(var _2 in this._items){this._items[_2].attr("readOnly",true);this._baselineValues[this._items[_2].attr("value")]=1;}this.evaluateState();},reset:function(_3){this.resetToBaseline();},orderedBaselineValues:function(){var _4=[];for(var _5 in this._baselineValues){_4.push(_5);}return _4.sort(function(a,b){return a-b;});},resetToBaseline:function(){var _8=this.orderedBaselineValues();var _9=dojo.map(this._itemOrder,function(_a){return this._items[_a];},this);var _b=Math.max(_8.length,_9.length);for(var i=0;i<_b;i++){var _d=_9[i],_e=_8[i];var _f=null;if(_d&&_e){if(_d.attr("value")!=_e){_d.attr("value",_e);}}else{if(_d){this.removeItem(_d,true);}else{if(_e){this.newItem(_e,true);}}}}this.__itemsChanged();this.setBaseline();return;},createItem:function(_10){if(this._readonly){return;}this.newItem();},newItem:function(_11,_12){var _13={required:true,intermediateChanges:true,promptMessage:"Enter a value from 1 to 4094",constraints:{min:1,max:4094}};if(_11!=undefined){_13.value=_11;}var _14=new dijit.form.NumberTextBox(_13);_14.domNode.style.width="60px";this.addItem(_14);this.connect(_14,"onChange","evaluateState");if(!_12){this.selectItems([_14.id],false);}},__itemsChanged:function(){this.inherited(arguments);this.evaluateState();},isValid:function(){if(this._readonly){return true;}var _15=true;var _16={},_17=[],_18="";for(var sId in this._items){var _1a=this._items[sId];var _1b=_1a.attr("value");_16[_1b]=_16[_1b]||0;_16[_1b]++;_15=_1a.isValid()&&_15;}if(_15){for(_1b in _16){if(_16[_1b]!=1){_17.push(_1b);}}}if(_17.length){_15=false;_18="Duplicate VLANS: "+_17.join(", ");}this.errorNode.innerHTML=_18;return _15;},evaluateState:function(_1c){if(this._readonly){this.save_button.attr("disabled",true);this.reset_button.attr("disabled",true);return;}var _1d=true;_1d=_1d&&this.isValid();_1d=_1d&&this.compareBaseline();this.save_button.attr("disabled",!_1d);this.reset_button.attr("disabled",!_1d);this.__check_vlan_count();},compareBaseline:function(){if(this._readonly){return false;}var _1e={};var _1f=false;for(var _20 in this._baselineValues){_1e[_20]=1;}for(var sId in this._items){var _22=this._items[sId];var _20=_22.attr("value");if(_1e[_20]){_1e[_20]++;}else{_1e[_20]=1;}}for(var _20 in _1e){if(_1e[_20]!=2){_1f=true;}}return _1f;},save:function(_23){if(this._readonly){return;}if(this.isValid()){this.__save();}else{this.vmanui.main.vmanui_error("Can't save invalid VLAN data");}},__deltas:function(){var _24=[],_25=[],_26={};if(!this._readonly){for(var sId in this._items){var _28=this._items[sId].attr("value").toString();_26[_28]=1;if(!this._baselineValues[_28]){_24.push(_28);}}for(var _28 in this._baselineValues){_28=_28.toString();if(!_26[_28]){_25.push(_28);}}}return {"add":_24.sort(function(a,b){return a-b;}),"delete":_25.sort(function(a,b){return a-b;}),"diffs":_24.length+_25.length};},__save:function(_2d){if(this._readonly){return;}var _2e=this.__deltas();var _2f=_2e["add"],_30=_2e["delete"];if(!_2d&&_30.length){if(this.__confirmDeletions(_30)){return;}}aDeferreds=[];dojo.forEach(_30,function(_31){var d=this.__delete_vlan(_31);aDeferreds.push(d);},this);dojo.forEach(_2f.sort(),function(_33){var d=this.__post_vlan(_33);aDeferreds.push(d);},this);var d=new dojo.DeferredList(aDeferreds,false,true);d.addCallback(dojo.hitch(this,"__save_callback"));},__confirmDeletions:function(_36){if(this._readonly){return false;}var _37=[];dojo.forEach(_36,function(_38){if(this.vlan_counts[_38]){_37.push(_38);}},this);if(_37.length){var _39=dijit.byId("remove_target_vlan_dialog");var _3a=dojo.query(".vlans",_39.domNode)[0];_3a.innerHTML=_37.join(", ");_39.vlanEditor=this;_39.show();return true;}return false;},__save_callback:function(r){if(this._readonly){return;}var _3c=0;var _3d=[];var _3e={"delete":[],"post":[]};dojo.forEach(r,function(dr){vlan=dr[1][1];_40=dr[1][2];if(dr[1][0]==true){if(_40=="delete"){_3d=_3d.concat(dr[1][3]);}}else{_3e[_40].push(vlan);_3c++;}});if(_3d.length){}if(_3c){var _41=[];for(var _40 in _3e){var _42=_3e[_40];if(_42.length){var _43=(_42.length==1?"vlan":"vlans");_41.push("Failed to "+_40.toUpperCase()+" "+_43+" "+_42.join(", "));}}this.vmanui.main.vmanui_error(_41.join(". "),this.__finish_save,this);}else{this.__finish_save();}},_onSelectChange:function(){if(this._readonly){return;}this.inherited(arguments);this.__check_vlan_count();},__check_vlan_count:function(){if(this._readonly){return;}dojo.style(this.infoNode,{"display":"none"});if(this._selected.length==1){var id=this._selected[0];var _45=this._items[id];var _46=_45.attr("value");if(!isNaN(_46)){var _47=this.vlan_counts[_46];if(_47){this.infoNode.innerHTML="VLAN "+_46+" is used in "+_47+" RSPAN configuration"+(_47==1?"":"s");dojo.style(this.infoNode,{"display":"block"});}}}},__finish_save:function(){if(this._readonly){return;}this.vmanui.main.editFinished();this.vmanui.main.refresh_current();},__ws_vlan_url:function(_48){var _49=["ws.v1","xen_directory"];if(this.pool_id){_49.push(this.pool_id);if(this.network_id){_49.push("network",this.network_id);}}_49.push("vlan",_48);return _49.join("/");},__delete_vlan:function(_4a){if(this._readonly){return;}var _4b=dijit.byId("csrf_token_v").getValue();var d=nox.ext.apps.vmanui.xhrDelete({url:this.__ws_vlan_url(_4a),headers:{"content-type":"application/json","X-CSRF-Token":_4b},timeout:30000,handleAs:"json",load:function(r){return [true,_4a,"delete",r];},error:function(r){return [false,_4a,"delete"];}});return d;},__post_vlan:function(_4f){if(this._readonly){return;}var _50=dijit.byId("csrf_token_v").getValue();var d=nox.ext.apps.vmanui.rawXhrPost({url:this.__ws_vlan_url(_4f),headers:{"content-type":"application/json","X-CSRF-Token":_50},postData:dojo.toJson({"csrf_token":_50}),timeout:30000,handleAs:"json",load:function(r){return [true,_4f,"post"];},error:function(r){return [false,_4f,"post"];}});return d;},uninitialize:function(){this.vmanui=null;this.inherited(arguments);}});}