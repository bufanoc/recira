/* Copyright (c) 2008, 2009, 2010 Nicira, Inc. */

if(!dojo._hasResource["nox.ext.apps.vmanui.acl"]){dojo._hasResource["nox.ext.apps.vmanui.acl"]=true;dojo.provide("nox.ext.apps.vmanui.acl");dojo.require("dijit._Widget");dojo.require("dojox.dtl._Templated");dojo.require("dojox.dtl.Context");dojo.declare("nox.ext.apps.vmanui.acl",[dijit._Widget,dijit._Templated],{templateString:"    <tr class=\"aclRow\">\n\t  <td width=\"8%\" align=\"left\" style=\"border-left: 1px solid #CCC\">\n        <a class=\"acl-action-link\" dojoAttachPoint=\"actionLink\">${acl.action}</a>\n      </td>\n      <td width=\"10%\" align=\"left\">\n        <a class=\"acl-protocol-link\" dojoAttachPoint=\"protocolLink\">${proto_text}</a>\n      </td>\n      <td width=\"6%\">\n        <a class=\"acl-direction-link\" dojoAttachPoint=\"directionLink\">${dir_text}</a>\n      </td>\n      <td width=\"25%\">\n        <a class=\"acl-remote-link\" dojoAttachPoint=\"remoteLink\">${remote_text}</a>\n      </td>\n      <td width=\"40%\" align=\"left\" class=\"acl-desc\">\n        <span dojoAttachPoint=\"desc_box\" dojoType=\"dijit.InlineEditBox\" class=\"acl-desc-link\"\n            noValueIndicator=\"&lt; none &gt;\">${desc_text}</span>\n      </td>\n      <td width=\"40%\" align=\"left\" class=\"acl-rule\">\n        <span class=\"acl-rule-link\">${acl.rule}</span>\n      </td>\n      <td align=\"left\" class=\"acl-hit-count\">\n        <span id=\"${acl_hits_id}\">-</span>\n      </td>\n      <td align=\"center\" width=\"3%\" class=\"acl-button\" style=\"border-right: 1px solid #CCC\">\n        <a class=\"acl-num-link\" dojoAttachPoint=\"numLink\">${acl.ui_index}</a>\n      </td>\n    </tr>\n\n",widgetsInTemplate:true,acl:null,role_widget:null,menuTypeMethods:{"action":"firstClickAction","direction":"firstClickDirection","protocol":"firstClickProtocol","num":"firstClickNum"},constructor:function(){this.show_desc=null;this._cellConnects={};},postMixInProperties:function(){this.acl_hits_id="";if(this.acl){var pm=this.role_widget.policy_manager;this.acl.rule=this._get_rule_text();var _2=dojo.map(this.acl.remote_groups,dojo.hitch(this,function(_3){var pm=this.role_widget.policy_manager;return pm.getNWAddrGroup(_3).name;}));switch(this.acl.direction){case "in":this.dir_text="from";break;case "out":this.dir_text="to";break;case "both":this.dir_text="to / from";break;default:this.dir_text="&lt;Unknown&gt;";}var _5=dojo.map(this.acl.remote_customs,function(c){return c;});var _7=_2.concat(_5);this.remote_text=nox.ext.apps.vmanui.util.escapeMarkup(_7.join(" , "));if(this.remote_text.length===0){this.remote_text="Any";}if(this.acl.invert_remote_addresses){this.remote_text="not("+this.remote_text+")";}var _8=pm.getProtocol(this.acl.protocol_uid);this.proto_text="Unknown";if(this.acl.protocol_uid===null){this.proto_text="Any";}else{if(_8===undefined){this.proto_text="Invalid";}else{if(_8.name!==null){this.proto_text=nox.ext.apps.vmanui.util.escapeMarkup(_8.name);}else{this.proto_text="&lt;Custom&gt;";}}}if(this.acl.uid!==undefined){this.acl_hits_id="acl-hits-uid-"+this.acl.uid;}if(this.acl.description===null){this.desc_text="";}else{this.desc_text=nox.ext.apps.vmanui.util.escapeMarkup(this.acl.description);}}else{this.remote_text="";this.proto_text="";this.desc_text="";this.dir_text="";}},postCreate:function(){this.desc_cell=dojo.query(".acl-desc",this.domNode)[0];this.rule_cell=dojo.query(".acl-rule",this.domNode)[0];if(this.acl){if(this.role_widget.is_readonly){this.desc_box.attr("disabled",true);}else{for(var _9 in this.menuTypeMethods){var _a=this.menuTypeMethods[_9];var _b=this[_9+"Link"];this._cellConnects[_9]=dojo.connect(_b,"onclick",this,_a);}this._cellConnects["remote"]=dojo.connect(this.remoteLink,"onclick",this,"firstClickRemote");dojo.connect(this.desc_box,"onChange",this,"changeDescription");dojo.connect(this.desc_box,"edit",nox.ext.apps.vmanui.main.editStarted);}}else{dojo.empty(this.domNode);var _c=dojo.create("tr");var _d=dojo.create("td");dojo.style(_d,"borderLeft","None");dojo.attr(_d,"colSpan",5);var _e=dojo.create("span");_e.innerHTML=this._getInnerACLLabel();dojo.addClass(_e,"inner-acl-span");_d.appendChild(_e);var _f=dojo.create("td");dojo.addClass(_f,"acl-button-white-bg");dojo.style(_f,"borderRight","1px solid #CCC");_f.innerHTML="&nbsp;";_c.appendChild(_d);_c.appendChild(_f);this.domNode=_c;if(!this.role_widget.is_readonly){this.connectInnerRow=dojo.connect(this,"onClick",this,"firstClickInnerRow");}}this.setDescRuleDisplay();},changeDescription:function(val){return this.role_widget.changeDescription(this,val);},firstClickAction:function(e){this.role_widget.clickCellLink(e.target,this,"action","create_action_menu",e);dojo.disconnect(this._cellConnects.action);},firstClickDirection:function(e){this.role_widget.clickCellLink(e.target,this,"direction","create_direction_menu",e);dojo.disconnect(this._cellConnects.direction);},firstClickProtocol:function(e){this.role_widget.clickCellLink(e.target,this,"protocol","create_protocol_menu",e);dojo.disconnect(this._cellConnects.protocol);},firstClickNum:function(e){this.role_widget.clickCellLink(e.target,this,"num","create_modify_menu",e);dojo.disconnect(this._cellConnects.num);},firstClickRemote:function(e){this.role_widget.clickRemote(this);dojo.disconnect(this._cellConnects.remote);},firstClickInnerRow:function(e){this.role_widget.clickCellLink(this.domNode,this,"innerRow","create_modify_menu",e);dojo.disconnect(this.connectInnerRow);},setDescRuleDisplay:function(){if(this.role_widget.show_desc!==this.show_desc){var _17=this.role_widget.show_desc?this.desc_cell:this.rule_cell;var _18=this.role_widget.show_desc?this.rule_cell:this.desc_cell;dojo.style(_17,{display:""});dojo.style(_18,{display:"none"});this.show_desc=this.role_widget.show_desc;}},_get_proto_text:function(){if(this.acl.protocol_uid===null){return "any protocol";}var _19=function(_1a){var str="";if(_1a.dst_port!==null){str+=" dst port "+_1a.dst_port;}if(_1a.src_port!==null){str+=" src port "+_1a.src_port;}return str;};var pm=this.role_widget.policy_manager;var _1d=pm.getProtocol(this.acl.protocol_uid);if(_1d){var _1e=null;switch(_1d.iptype){case 1:_1e="ICMP";break;case 6:_1e="TCP"+_19(_1d);break;case 17:_1e="UDP"+_19(_1d);break;default:if(_1d.iptype!==null){_1e="IP-Proto '"+_1d.iptype+"'";}else{if(_1d.ethertype!==null){var _1f=dojo.string.pad(_1d.ethertype.toString(16).toUpperCase(),4,"0");_1e="Ethertype: 0x"+_1f;}}}return _1e;}throw "Invalid Protocol";},_get_remote_text:function(){var _20=[];var pm=this.role_widget.policy_manager;var _22=dojo.forEach(this.acl.remote_groups,function(_23){var g=pm.getNWAddrGroup(_23);dojo.forEach(g.members,function(_25){_20.push(_25.address);});});var _26=dojo.forEach(this.acl.remote_customs,function(c){_20.push(c);});var res=(_20.length>0)?_20.join(" , "):"any address";if(this.acl.invert_remote_addresses){res="all addresses except "+res;}return res;},_get_rule_text:function(){try{var pm=this.role_widget.policy_manager;var str=(this.acl.action=="deny")?"Deny ":"Allow ";str+=this._get_proto_text();switch(this.acl.direction){case "in":str+=" from ";break;case "out":str+=" to ";break;case "both":str+=" to/from ";break;default:throw "Invalid direction '"+this.acl.direction+"'";}str+=this._get_remote_text();var _2b=pm.getProtocol(this.acl.protocol_uid);if(_2b&&!_2b.unidirectional){str+=" (and reply traffic)";}return str;}catch(e){nox.ext.apps.vmanui.main.console_log("Error getting acl text: "+e);return "&lt;Unknown&gt;";}},_getInnerACLLabel:function(){var _2c=this.role_widget.role.uid.split(";")[0];var pfx="Placeholder for more specific ";switch(_2c){case "global":return pfx+"Pool, Network, VM, and Interface policies.";case "pool":return pfx+"Network, VM, and Interface policies.";case "network":return pfx+"VM and Interface policies.";case "vm":return pfx+"Interface policy.";default:return "";}},uninitialize:function(){this.inherited(arguments);if(this.desc_box){this.desc_box.destroyRecursive();}}});}