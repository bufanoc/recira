/* Copyright (c) 2008, 2009, 2010 Nicira, Inc. */

if(!dojo._hasResource["nox.ext.apps.vmanui.dashboard"]){dojo._hasResource["nox.ext.apps.vmanui.dashboard"]=true;dojo.provide("nox.ext.apps.vmanui.dashboard");dojo.require("nox.ext.apps.vmanui.main");dojo.require("nox.ext.apps.vmanui.plotUtil");(function(){var _1=nox.ext.apps.vmanui;var _2=_1.main;var _3=_1.dashboard;var _4=_1.vac_visibility;_3.charts={};_3.chartRotation=0;_3.chartsNeeded=[];_3.chart_metadata=[{plotId:"dashboardBitsPlot",binType:"host",countType:"bits"},{plotId:"dashboardFlowsPlot",binType:"host",countType:"flows"},{plotId:"dashboardPacketsPlot",binType:"host",countType:"packets"}];_3.dashboard_init=function(_5,_6){nox.ext.apps.vmanui.main.set_document_subtitle("Dashboard");_3.update_server_stats();_3.update_network_stats();_3.update_network_events(_6);_3.update_admin_events(_6);var dm=_3;if(_4==undefined){_4=_1.vac_visibility;}_3.chartsNeeded=[];dojo.forEach(_3.chart_metadata,function(_8){var _9=_8.plotId;if(!_3.charts[_9]){_3.chartsNeeded.push(_8);}});if(_3.chartsNeeded.length==0){var _a=_3.chart_metadata.length;_3.chartRotation=(_3.chartRotation+1)%_a;var _b=_3.chart_metadata[_3.chartRotation];_3.chartsNeeded.push(_b);}if(_3.chartsNeeded.length){if(dojo.isIE){_2.pause_clicked(false);}}_3.create_needed_chart();return false;};_3.create_needed_chart=function(){if(_3.chartsNeeded.length){var _c=_3.chartsNeeded.shift();_3._update_dashboard_plot(_c.plotId,_c.binType,_c.countType);}else{if(dojo.isIE){nox.ext.apps.vmanui.main.play_clicked(false);}}};_3.update_server_stats=function(){_3.update_server_uptime();_3.update_server_cpu_load();};_3.update_server_cpu_load=function(){var d=nox.ext.apps.vmanui.xhrGet({url:"/ws.v1/nox/cpu/stat",timeout:5000,handleAs:"json",preventCache:true,load:function(r){dojo.byId("server_cpu_load").innerHTML=parseInt(r.user)+" %";}});};_3.__get_uptime_string=function(_f){var _10=24*60;var _11=parseInt(_f/60);var _12=parseInt(_11/_10);if(_12>0){_11=parseInt(_11%(_12*_10));}var _13=parseInt(_11/60);if(_13>0){_11=parseInt(_11%(_13*60));}if(_12>0){return _12+" days, "+_13+" hrs, "+_11+" min";}else{if(_13>0){return _13+" hrs, "+_11+" min";}else{return _11+" min";}}};_3.update_server_uptime=function(){var d=nox.ext.apps.vmanui.xhrGet({url:"/ws.v1/nox/uptime",timeout:5000,handleAs:"json",preventCache:true,load:function(r){dojo.byId("server_uptime").innerHTML=_3.__get_uptime_string(r);}});};_3.net_events_label_map={"resource_pools_net_stats":"Resource Pools","xenservers_net_stats":"XenServers","networks_net_stats":"Networks","vms_net_stats":"VMs"};_3.update_network_stats=function(){var d=nox.ext.apps.vmanui.xhrGet({url:"/ws.v1/xen/entity_counts",timeout:5000,handleAs:"json",preventCache:true,load:function(r){for(var id in _3.net_events_label_map){var _19=_3.net_events_label_map[id];var _1a=r[_19];dojo.byId(id).innerHTML=[_1a.managed,_1a.active,_1a.total].join(" / ");}}});};_3.update_network_events=function(_1b){var _1c=dijit.byId("net_events_pane");if(_1b||!_1c.pauseRefresh){_1c.refresh(true);}};_3.update_admin_events=function(_1d){var _1e=dijit.byId("admin_events_pane");if(_1d||!_1e.pauserefresh){_1e.refresh(true);}};_3._update_dashboard_plot=function(_1f,_20,_21){var _22=new Date();var _23=_22.getTime();var _24=_23-60*60*1000;var _25={plotChartContainerId:_1f,chartTab:"dashboard",interval:60*60};var _26={tz:(new Date()).getTimezoneOffset()*-1,direction:"bidir",bintype:_20,counttype:_21,start_epoch:parseInt(_24/1000),end_epoch:parseInt(_23/1000),reverse:1,count:5,tree_uid:1};var _27=new nox.ext.apps.vmanui.flowStatsManager(_26,_25,_3.charts[_1f]);var d=_27.draw();d.addCallback(function(_29){if(!_3.charts[_1f]&&_29.chart){_3.charts[_1f]=_29.chart;}});d.addCallback(_3.create_needed_chart);d.addCallback(function(){_27=null;});return d;};_3._display_error=function(e){console.log("Dashboard Plot Display Error:",e);};_3.on_dashboard_load=function(){_1.main.set_section_container_display("block");_3.dashboard_init();};})();}