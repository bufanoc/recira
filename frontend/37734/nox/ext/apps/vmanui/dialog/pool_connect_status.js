/* Copyright (c) 2008, 2009, 2010 Nicira, Inc. */

if(!dojo._hasResource["nox.ext.apps.vmanui.dialog.pool_connect_status"]){dojo._hasResource["nox.ext.apps.vmanui.dialog.pool_connect_status"]=true;dojo.provide("nox.ext.apps.vmanui.dialog.pool_connect_status");dojo.require("nox.ext.apps.vmanui.BoundedDialog");dojo.declare("nox.ext.apps.vmanui.dialog.pool_connect_status",[dijit._Widget,dojox.dtl._Templated],{popup:null,widgetsInTemplate:true,canceled:false,pool_obj:null,master_addr:"<unknown>",templateString:"<div dojoAttachPoint=\"containerNode\" style=\"width:300px\">\n  <div class=\"pollingDiv\">\n    <div>Trying to connect to '{{ master_addr }}'</div> \n    <div style=\"text-align:center;margin-top:12px;\">\n      <div dojoType=\"dijit.ProgressBar\" style=\"width:300px\" indeterminate=\"true\"></div>\n    </div> \n    <div class=\"dialogButtonContainer\">\n      <button dojoType=\"dijit.form.Button\" dojoAttachEvent=\"onClick:onCancel\">Cancel </button> \n    </div> \n  </div>\n  <div class=\"stealingDiv\">\n    <div style=\"margin-bottom:15px\">This pool is already managed by controller <span class=\"currentControllerIP\"></span>.\n    Would you like to steal control by force or just leave it under the other controller's command?</div>\n    <div style=\"text-align:right\">\n      <button class=\"blueButton\" dojoType=\"dijit.form.Button\" dojoAttachEvent=\"onClick:stealPool\">Steal Control</button>\n      <button dojoType=\"dijit.form.Button\" dojoAttachEvent=\"onClick:hide\">Leave it</button>\n    </div>\n  </div>\n</div>\n",postMixInProperties:function(){this.inherited(arguments);this.popup=new nox.ext.apps.vmanui.BoundedDialog({});dojo.connect(this.popup,"onCancel",this,"onCancel");this.popup.attr("title","Establishing XenServer Connection...");for(var i=0;i<this.pool_obj.properties.length;i++){var p=this.pool_obj.properties[i];if(p[0]=="master_address_1"){this.master_addr=p[1];}}},postCreate:function(){this.pollingDiv=dojo.query("div.pollingDiv",this.domNode)[0];this.stealingDiv=dojo.query("div.stealingDiv",this.domNode)[0];this.pollingDiv.style.display="block";this.stealingDiv.style.display="none";},show:function(){this.popup.attr("content",this.domNode);dojo.addClass(this.popup.domNode,"poolConnectStatusDialog");nox.ext.apps.vmanui.main.onDialogOpen();this.popup.show();setTimeout(dojo.hitch(this,"poll"),1000);},stealPool:function(){this.hide();nox.ext.apps.vmanui.vac_status.retry_add_pool_with_steal();},askToSteal:function(_3){this.pollingDiv.style.display="none";this.stealingDiv.style.display="block";dojo.query("span.currentControllerIP",this.domNode).forEach(function(_4){_4.innerHTML=_3.controller;});},poll:function(){var _5=nox.ext.apps.vmanui;if(this.canceled){return;}var d=_5.vac_status.get_pool_tree_item(this.pool_obj.uid);d.addCallback(dojo.hitch(this,function(_7){var _8=_7["active"];var _9=parseInt(_8);if(this.canceled){return;}if(_9==10){if(!this.pool_obj["refresh_status"]){this.askToSteal(_7);}else{this.hide();}return;}else{if((_9==0)||(_9==9)){this.hide();return;}else{if(_9==1){setTimeout(dojo.hitch(this,function(){this.poll();}),500);return;}}}this.hide();delete this.pool_obj["refresh_status"];var _a=new _5.dialog.pool_edit({pool_obj:this.pool_obj,error_str:this._getErrorStr(_8)});_a.show();}));d.addErrback(dojo.hitch(this,function(_b){if(_b.status==404){setTimeout(dojo.hitch(this,function(){this.poll();}),1000);}}));},hide:function(){nox.ext.apps.vmanui.main.onDialogClose();this.popup.destroy();this.destroy();},onCancel:function(){this.canceled=true;this.hide();var _c=new nox.ext.apps.vmanui.dialog.pool_edit({pool_obj:this.pool_obj});_c.show();},_getErrorStr:function(_d){switch(_d){case 2:return "Internal Error";case 3:return "Unable to establish network connection";case 4:return "Invalid address";case 5:return "Peer is not a valid XenServer";case 6:return "Duplicate pool";case 7:return "Invalid username or password";default:return "Unknown Error";}}});}