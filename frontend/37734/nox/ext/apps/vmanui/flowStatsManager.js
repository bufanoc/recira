/* Copyright (c) 2008, 2009, 2010 Nicira, Inc. */

if(!dojo._hasResource["nox.ext.apps.vmanui.flowStatsManager"]){dojo._hasResource["nox.ext.apps.vmanui.flowStatsManager"]=true;dojo.provide("nox.ext.apps.vmanui.flowStatsManager");dojo.require("nox.ext.apps.vmanui.util");dojo.declare("nox.ext.apps.vmanui.flowStatsManager",null,{wsArgs:null,plotParams:null,chartToReuse:null,poolsToWarn:null,aInPoints:null,aOutPoints:null,aInTotals:null,aOutTotals:null,iSumIn:null,iSumOut:null,pauseRefresh:false,__node_type_cache:{},__sort_cache:{"in":{"sense":"desc","criterion":"numeric","target":"total"},"out":{"sense":"desc","criterion":"numeric","target":"total"}},flow_stages:[[1,60],[2,150],[4,150],[8,225],[16,225],[32,225],[96,225],[192,225],[384,225],[768,225],[3072,225]],constructor:function(_1,_2,_3,_4){this.wsArgs=_1||{};this.plotParams=_2||{};this.chartToReuse=_3||null;this.poolsToWarn=_4||[];},draw:function(){return this.get_chart_data();},get_chart_data:function(){this.__node_cache={};var d=nox.ext.apps.vmanui.xhrGet({url:"/ws.v1/flowapi/get_totals_series",content:this.wsArgs,handleAs:"json",timeout:30000,load:dojo.hitch(this,"load"),error:function(r,_7){console.log("[Flow stats error]:",r,_7);var _8=dojo.byId(this.plotParams.plotTableContainerId);var _9=dojo.doc.createTextNode(r);dojo.place(_9,_8,"only");}});d.addCallback(dojo.hitch(this,"fillLegendColors"));d.addCallback(dojo.hitch(this,"setupSort"));return d;},fillLegendColors:function(_a){var _b=_a.chart||this.chartToReuse;if(_a.table&&_b){nox.ext.apps.vmanui.plotUtil.fillTableLegendColors(_b,_a.table.rows());}return _a;},setupSort:function(_c){var _d=[];var _e=dojo.query(".visibility_table .sort");var _f=nox.ext.apps.vmanui.util;dojo.forEach(_e,function(_10){var _11=dojo.connect(_10,"click",this,function(e){var _13=_f.findAncestorNodeByClass(_10,"visibility_totals");var _14=dojo.hasClass(_10,"name")?"name":"numeric";var _15=_c.table.totalsTables;var _16,_17;if(_15.uni){_16=_15.uni;_17=_c.table.direction;}else{_17=dojo.hasClass(_13,"in")?"in":"out";if(_17=="in"){_16=_15.bi_in;}else{if(_17=="out"){_16=_15.bi_out;}}}var _18=this.__sort_cache[_17];var _19=_18["sense"]=="asc"?"desc":"asc";this.sortTotals(_17,_14,_19);if(_14=="name"){_18["target"]="name";}else{if(dojo.hasClass(_10,"total")){_18["target"]="total";}else{if(dojo.hasClass(_10,"rate")){_18["target"]="rate";}else{if(dojo.hasClass(_10,"perc")){_18["target"]="perc";}}}}_16.empty();var _1a=_17=="in"?this.aInTotals:this.aOutTotals;var sum=_17=="in"?this.iSumIn:this.iSumOut;var _1c=_c.table.interval;_16.createRows(_1a,sum,_1c);this.styleSortIcons(_17,_16);this.fillLegendColors(_c);this.setupSort(_c);});_d.push(_11);},this);var h=dojo.connect(_c.table,"destroy",function(){dojo.forEach(_d,function(_1e){dojo.disconnect(_1e);});_d=[];dojo.disconnect(h);});},styleSortIcons:function(_1f,_20){var _21=this.__sort_cache[_1f];var _22=_21["target"];dojo.query(".sort_icon",_20.domNode).forEach(function(_23){dojo.style(_23,{"visibility":"hidden"});});dojo.query("."+_22,_20.domNode).forEach(function(_24){dojo.query(".sort_icon",_24.parentNode).forEach(function(_25){var _26=_21.sense;var _27=_26=="asc"?"desc":"asc";dojo.removeClass(_25,_27);dojo.addClass(_25,_26);dojo.style(_25,{"visibility":"visible"});});});},vmLink:function(sId){var _29={name:"",tree_uid:null};var _2a;if(sId==0){_2a="Other";}else{_2a=this._series_name([sId]);_2a=nox.ext.apps.vmanui.util.unescapeMarkup(_2a);}if(_2a=="unknown"){_2a="Unknown Host ("+sId+")";}return {name:_2a,tree_uid:this.get_tree_uid(sId)};},get_tree_uid:function(sId){var nt=this.__node_type_cache[sId];if(!nt){nt=this.wsArgs.default_node_type;}var _2d=nox.ext.apps.vmanui.vac.node_types;var _2e=null;switch(nt){case _2d.ALL_POOLS:case _2d.POOL:case _2d.NETWORKS:case _2d.VMS:case _2d.VM_VIF:case _2d.ADMIN_NETWORKS:case _2d.ADMIN_NET_GROUP:case _2d.ADMIN_NET:case _2d.ADMIN_GROUPS:_2e=_2d.VM;break;case _2d.NETWORK:case _2d.NETWORK_VIF:_2e=_2d.NETWORK_VM;break;case _2d.SERVERS:case _2d.SERVER:case _2d.SERVER_NETWORKS:case _2d.SERVER_VIF:_2e=_2d.SERVER_VM;break;case _2d.SERVER_NETWORK:case _2d.SERVER_NETWORK_VIF:_2e=_2d.SERVER_NETWORK_VM;break;case _2d.ADMIN_GROUP:case _2d.ADMIN_VIF:_2e=_2d.ADMIN_VM;break;}if(!_2e){_2e=nt;}var _2f=this.get_nodes({node_type:_2e,uid:sId});if(_2f.length==0){return null;}if(_2f[0].tree_uid==this.wsArgs.tree_uid){return null;}return _2f[0].tree_uid;},load:function(r,_31){var _32=this.wsArgs;var _33=this.plotParams;var _34=this.chartToReuse;var _35={};this.aInPoints=r[0];this.aOutPoints=r[1];this.aInTotals=r[2];this.aOutTotals=r[3];this.iSumIn=parseInt(r[4][0]);this.iSumOut=parseInt(r[5][0]);dojo.forEach(this.aInTotals.concat(this.aOutTotals),function(_36){if(_32.bintype=="host"){_36[2]=this.vmLink(_36[0][0]);}else{_36[2]={"name":this._series_name(_36[0])};}},this);var _37=this.__sort_cache["in"];this.sortTotals("in",_37["criterion"],_37["sense"]);var _38=this.__sort_cache["out"];this.sortTotals("out",_38["criterion"],_38["sense"]);_35.chart=this.write_chart();_35.table=this.write_table();return _35;},write_chart:function(){var _39=[];var _3a={};var _3b=this.plotParams;var _3c=0;var _3d=(new Date()).getTime();var _3e=[[this.aInPoints,"high"],[this.aOutPoints,"low"]];for(var i=0;i<_3e.length;i++){var _40=_3e[i][0];var _41=_3e[i][1];for(var j=0;j<_40.length;j++){var key=_40[j][0];var _44=_40[j][1];var id=this.series_key_to_id(key);_39.push(id);var _46=this._series_name(key);if(!_3a.hasOwnProperty(id)){_3a[id]={data:{},name:_46};}_3d=Math.min(_3d,1000*_44[0][0]);_3c=Math.max(_3c,1000*_44[_44.length-1][0]);for(var k=0;k<_44.length;k++){var ts=_44[k][0];var val=_44[k][1];if(!_3a[id].data.hasOwnProperty(ts)){_3a[id].data[ts]={high:0,low:0};}_3a[id].data[ts][_41]=val;}}}var _4a=this.create_series_data(_3a);var _4b=this.create_label_data(_3d,_3c);var _4c=this.timestamp_for_duration(_3d,_3b.interval*1000);var _4d=this.timestamp_for_duration(_3c,_3b.interval*1000);this.sInterval=_4c+" - "+_4d;var _4e=_3b.plotChartContainerId;var _4f=this.chartToReuse;if(_4e){if(_39.length){if(_4f){nox.ext.apps.vmanui.plotUtil.setChartSeries(_4f,_39,_4a,_4b);}else{var _50=_3b.chartTab||"visibility";_4f=nox.ext.apps.vmanui.plotUtil.plotNetFlow(_4e,_4a,_4b,_39,_50);}}else{dojo.empty(_4e);}}return _4f;},series_key_to_id:function(k){var _52=dojo.filter(k,function(_53){return !isNaN(parseInt(_53));});return _52.join("_");},_series_name:function(_54){var bt=this.wsArgs.bintype;var _56;if(_54.length==2&&_54[0]==0&&_54[1]==0){return "Other";}if(_54.length==1&&_54[0]==0){return "Other";}if(bt=="host"){if(_54[0]==undefined){return "Unknown VM";}var _57=this.get_nodes({uid:_54[0],node_type:nox.ext.apps.vmanui.vac.node_types.VM});if(_57&&_57.length==1){_56=_57[0].name;}else{_56="Unknown Host: "+_54[0];}}else{if(bt=="l3proto"){if(_54[0]==256){return "Other";}_56=this.l3_str(_54[0]);}else{if(bt=="l4proto"){if(_54[0]==256){return "Other";}_56=this.l4_str(_54[0],_54[1]);}else{if(bt=="ip"){_56=this.create_ipaddr(_54[0]);}}}}return nox.ext.apps.vmanui.util.escapeMarkup(_56);},get_nodes:function(_58){var uid=_58.uid;var _5a=_58.node_type;if(this.__node_cache[_5a]&&this.__node_cache[_5a][uid]){return this.__node_cache[_5a][uid];}var _5b=[];nox.ext.apps.vmanui.xhrGet({url:"/ws.v1/tree/node",content:_58,sync:true,handleAs:"json",load:function(r){_5b=r;}});if(!this.__node_cache[_5a]){this.__node_cache[_5a]={};}this.__node_cache[_5a][uid]=_5b;return this.__node_cache[_5a][uid];},create_ipaddr:function(key){var _5e=[];for(var i=0;i<4;i++){var _60=8*(3-i);_5e[i]=(key>>_60)&255;}return _5e.join(".");},l3_str:function(_61){return nox.ext.apps.vmanui.protoUtil.l3_str(_61);},l4_str:function(_62,_63){return nox.ext.apps.vmanui.protoUtil.l4_str(_62,_63);},create_series_data:function(_64){var _65=this.wsArgs;var _66={};var _67=0;var _68=(_65.direction=="bidir")?2*_65.count:_65.count;for(var sId in _64){_67++;if(_67>_68){continue;}var _6a=[];var _6b=_64[sId].data;var _6c=_64[sId].name;var _6d=[];for(var ts in _6b){_6d.push(ts);}_6d=_6d.sort();dojo.forEach(_6d,function(ts){var _70=_6b[ts];_6a.push({"x":ts,"high":_70.high,"low":_70.low});});_66[sId]={"name":_6c,"data":_6a};}return _66;},create_label_data:function(_71,_72){var _73=[];var _74=this.get_bin_interval(_71,_72);var _75=parseInt(_71/_74)*_74;var _76=_72-_71;while(_75<=_72){var _77=parseInt(_75/1000);var _78=this.timestamp_for_duration(_75,_76);_73.push({value:_77,text:_78});_75+=_74*1000;}return _73;},get_bin_interval:function(_79,_7a){var _7b=((new Date()).getTime()-_79)/1000;var _7c=this.flow_stages[0][0];dojo.forEach(this.flow_stages,function(_7d){var _7e=_7d[0];var _7f=_7d[1];if(_7b<_7e*_7f*1.5){return;}_7c=_7e;});return _7c;},timestamp_for_duration:function(iTS,_81){var _82=this._get_time_format(_81);return new Date(iTS).strftime(_82);},_get_time_format:function(_83){if(_83<24*60*60*1000){return "%H:%M:%S";}return "%m/%d %H:%M:%S";},_get_sort_fn:function(_84,_85){return function(a,b){var _88;if(_84=="name"){_88=(_85=="desc")?a[2].name.toLowerCase()<b[2].name.toLowerCase():b[2].name.toLowerCase()<a[2].name.toLowerCase();}else{_88=(_85=="desc")?a[1][0]<b[1][0]:b[1][0]<a[1][0];}return _88?1:-1;};},sortTotals:function(_89,_8a,_8b){var _8c=(_89=="in")?this.aInTotals:this.aOutTotals;_8c.sort(this._get_sort_fn(_8a,_8b));var _8d=this.__sort_cache[_89];_8d.sense=_8b;_8d.criterion=_8a;},write_table:function(){var _8e=this.aInTotals;var _8f=this.aOutTotals;var _90=this.iSumIn;var _91=this.iSumOut;var _92=this.plotParams;var _93=this.wsArgs;var _94=_92.plotTableContainerId;var _95=null;if(_94){dojo.empty(_94);var _96=false;dojo.forEach(_8e.concat(_8f),function(_97){if(_97[1][0]){_96=true;}});var _98=dojo.byId(_94);if(_96){_95=new nox.ext.apps.vmanui.VisibilityTable({manager:this,interval:_92.interval,interval_str:this.sInterval,direction:_93.direction,count_type:_93.counttype,bin_type:_93.bintype,tree_uid:_93.tree_uid,in_totals:_8e,out_totals:_8f,in_sum:_90,out_sum:_91,pools_to_warn:this.poolsToWarn,max_items:50});dojo.place(_95.domNode,_98,"only");}else{_98.innerHTML="No available data to plot";}}return _95;}});}