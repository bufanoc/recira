/* Copyright (c) 2008, 2009, 2010 Nicira, Inc. */

if(!dojo._hasResource["nox.ext.apps.vmanui.menu_creator"]){dojo._hasResource["nox.ext.apps.vmanui.menu_creator"]=true;dojo.provide("nox.ext.apps.vmanui.menu_creator");dojo.require("nox.ext.apps.vmanui.RemoteAddressEditor");dojo.require("dijit.form.Textarea");dojo.declare("nox.ext.apps.vmanui.MenuCreator",null,{_insert_into_rules:function(_1,_2,_3,_4){var _5=_3.acl_rules;if(_2==_5.length){_5.push(_1);}else{var _6=[];for(var i=0;i<_5.length;i++){if(i==_2){_6.push(_1);}_6.push(_5[i]);}_3.acl_rules=_6;}if(_4=="before"){_3.acl_split_before++;}},_change_role:function(pm,_9,_a){pm.setRole(_9);_a.redraw_acls();dojo.behavior.apply();},change_protocol_for_acl:function(_b,_c){var _d=_c.role_widget;var _e=_c.acl.ui_index;var _f=_d.role;var pm=_d.policy_manager;_f.acl_rules[_e].protocol_uid=_b;this._change_role(pm,_f,_c.role_widget);},_add_acl_from_modify_menu:function(_11,pm,dir,_14){var _15=null;var _16=null;var _17=_11.role_widget.get_role();if(_11.acl){_16=_11.type;_15=_11.acl.ui_index;if(_14){++_15;}}else{_15=_17.acl_split_before;_16=(_14)?"after":"before";}this._add_acl(pm,_17,_15,_16,dir,_11.role_widget);},_add_acl_from_header_menu:function(_18,pm,dir,_1b){var _1c=_18.get_role();var _1d=0;if(_1b=="after"){_1d=_1c.acl_split_before;}this._add_acl(pm,_1c,_1d,_1b,dir,_18);},_add_acl:function(pm,_1f,_20,_21,dir,_23){var acl=pm._make_acl(dir,"");this._insert_into_rules(acl,_20,_1f,_21);this._change_role(pm,_1f,_23);},_move_acl:function(_25,pm,_27){var _28=_25.role_widget.get_role();var acl=_25.acl;var _2a=acl.ui_index;var tmp=null;if(_27){if(_2a==_28.acl_split_before){_28.acl_split_before++;}else{if(_2a===0){nox.ext.apps.vmanui.main.console_log("error, can't move top ACL up");return;}else{tmp=_28.acl_rules[_2a-1];_28.acl_rules[_2a-1]=_28.acl_rules[_2a];_28.acl_rules[_2a]=tmp;}}}else{if(_2a==(_28.acl_split_before-1)){_28.acl_split_before--;}else{if(_2a==(_28.acl_rules.length-1)){nox.ext.apps.vmanui.main.console_log("error, can't move bottom ACL down");return;}else{tmp=_28.acl_rules[_2a+1];_28.acl_rules[_2a+1]=_28.acl_rules[_2a];_28.acl_rules[_2a]=tmp;}}}this._change_role(pm,_28,_25.role_widget);},_delete_acl:function(_2c,pm){var _2e=_2c.role_widget.get_role();var _2f=_2c.acl.ui_index;var _30=[];for(var i=0;i<_2e.acl_rules.length;i++){if(i!=_2f){_30.push(_2e.acl_rules[i]);}}_2e.acl_rules=_30;if(_2f<_2e.acl_split_before){_2e.acl_split_before--;}this._change_role(pm,_2e,_2c.role_widget);},create_simple_acl_menu:function(_32,_33,pm,_35){var _36=new dijit.Menu({targetNodeIds:[_32],leftClickToOpen:true});_36.role_widget=_33;_36.policy_manager=pm;if(_33.is_vif_role()){_36.addChild(new dijit.MenuItem({label:"Add New ACL",onClick:dojo.hitch(this,function(_37,e){this._add_acl_from_header_menu(_37.role_widget,_37.policy_manager,"both","before");},_36)}));}else{if(_35!="before"){_36.addChild(new dijit.MenuItem({label:"Add New Mandatory ACL",onClick:dojo.hitch(this,function(_39,e){this._add_acl_from_header_menu(_39.role_widget,_39.policy_manager,"both","before");},_36)}));}if(_35!="after"){_36.addChild(new dijit.MenuItem({label:"Add New Default ACL",onClick:dojo.hitch(this,function(_3b,e){this._add_acl_from_header_menu(_3b.role_widget,_3b.policy_manager,"both","after");},_36)}));}}this.attach_menu_listeners(_36);_36.startup();return _36;},create_modify_menu:function(_3d,_3e,pm){var _40=new dijit.Menu({targetNodeIds:[_3d],leftClickToOpen:true});_40.acl_widget=_3e;_40.policy_manager=pm;_40.addChild(new dijit.MenuItem({label:"Add New ACL Above",onClick:dojo.hitch(this,function(_41,e){this._add_acl_from_modify_menu(_41.acl_widget,_41.policy_manager,"both",false);},_40)}));_40.addChild(new dijit.MenuItem({label:"Add New ACL Below",onClick:dojo.hitch(this,function(_43,e){this._add_acl_from_modify_menu(_43.acl_widget,_43.policy_manager,"both",true);},_40)}));var _45=_40.acl_widget.role_widget.get_role();var acl=_40.acl_widget.acl;if(acl!==null){var _47=_45.uid.indexOf("vif")===0;if(acl.ui_index!==0||(!_47&&acl.ui_index==_45.acl_split_before)){_40.addChild(new dijit.MenuItem({label:"Move Up",onClick:dojo.hitch(this,function(){this._move_acl(_40.acl_widget,_40.policy_manager,true);},_40)}));}if(acl.ui_index<(_45.acl_rules.length-1)||(!_47&&acl.ui_index<_45.acl_split_before)){_40.addChild(new dijit.MenuItem({label:"Move Down",onClick:dojo.hitch(this,function(){this._move_acl(_40.acl_widget,_40.policy_manager,false);},_40)}));}_40.addChild(new dijit.MenuItem({label:"Delete",onClick:dojo.hitch(this,function(){this._delete_acl(_40.acl_widget,_40.policy_manager);},_40)}));}this.attach_menu_listeners(_40);_40.startup();return _40;},attach_menu_listeners:function(_48){var _49=false;dojo.connect(_48,"onOpen",function(){_49=true;nox.ext.apps.vmanui.main.onDialogOpen();});dojo.connect(_48,"onClose",function(){if(_49){nox.ext.apps.vmanui.main.onDialogClose();_49=false;}});},create_netflow_warning_menu:function(_4a,_4b){var _4c=new dijit.Menu({targetNodeIds:[_4a],leftClickToOpen:true});dojo.forEach(_4b,function(_4d){var sId=_4d[0];var _4f=_4d[1];_4c.addChild(new dijit.MenuItem({label:_4f,onClick:function(){var _50=[nox.ext.apps.vmanui.vac.node_types.POOL,sId].join("_");nox.ext.apps.vmanui.vac.show_vac_tab("status",_50);}}));});this.attach_menu_listeners(_4c);return _4c;},create_action_menu:function(_51,_52,pm){var _54=new dijit.Menu({targetNodeIds:[_51],leftClickToOpen:true});_54.acl_widget=_52;_54.policy_manager=pm;var _55=_54.acl_widget.acl.action;var _56=(_55=="deny")?"Allow":"Deny";_54.addChild(new dijit.MenuItem({label:"Change Action to "+_56,onClick:dojo.hitch(this,function(_57,e){var _59=(_55=="deny")?"Allow":"Deny";var _5a=_57.acl_widget.role_widget.get_role();var _5b=_57.acl_widget.acl.ui_index;_5a.acl_rules[_5b].action=(_5a.acl_rules[_5b].action=="deny")?"allow":"deny";this._change_role(pm,_5a,_57.acl_widget.role_widget);},_54)}));this.attach_menu_listeners(_54);return _54;},create_direction_menu:function(_5c,_5d,pm){var _5f=new dijit.Menu({targetNodeIds:[_5c],leftClickToOpen:true});dojo.forEach([{val:"in",text:"Use Direction 'from'"},{val:"out",text:"Use Direction 'to'"},{val:"both",text:"Use Direction 'to/from'"}],function(dir){if(_5d.acl.direction==dir.val){return;}_5f.addChild(new dijit.MenuItem({label:dir.text,onClick:dojo.hitch(this,function(e){var _62=_5d.role_widget.get_role();_62.acl_rules[_5d.acl.ui_index].direction=dir.val;this._change_role(pm,_62,_5d.role_widget);})}));},this);this.attach_menu_listeners(_5f);return _5f;},create_protocol_menu:function(_63,_64,pm){var _66=nox.ext.apps.vmanui;var _67=new dijit.Menu({targetNodeIds:[_63],leftClickToOpen:true});_67.acl_widget=_64;_67.policy_manager=pm;_67.addChild(new dijit.MenuItem({label:"Match any protocol",onClick:dojo.hitch(this,function(_68,e){this.change_protocol_for_acl(null,_68.acl_widget);},_67)}));if(_64.acl.protocol_uid!==null){_67.addChild(new dijit.MenuItem({label:"View / modify current protocol",onClick:dojo.hitch(this,function(_6a,e){var _6c=new _66.dialog.protocol_edit({acl_widget:_6a.acl_widget,protocol_uid:_6a.acl_widget.acl.protocol_uid});_6c.show();},_67)}));}_67.addChild(new dijit.MenuItem({label:"Use an existing protocol",onClick:dojo.hitch(this,function(_6d,e){var _6f=new _66.dialog.select_existing_protocol({acl_widget:_6d.acl_widget});_6f.show();},_67)}));_67.addChild(new dijit.MenuItem({label:"Use a new protocol",onClick:dojo.hitch(this,function(_70,e){var _72=new _66.dialog.protocol_edit({acl_widget:_70.acl_widget,protocol_uid:null});_72.show();},_67)}));this.attach_menu_listeners(_67);return _67;},show_remote_dialog:function(_73,pm){var _75=new nox.ext.apps.vmanui.RemoteAddressEditor({title:"Select Remote Addresses",acl_widget:_73,policy_manager:pm});nox.ext.apps.vmanui.main.onDialogOpen();var _76=false;dojo.connect(_75,"hide",function(){if(!_76){nox.ext.apps.vmanui.main.onDialogClose();_76=true;}});_75.startup();_75.show();},create_changevisibleuid_menu:function(_77,_78,pm,cb){var _7b=new dijit.Menu({targetNodeIds:[_77],leftClickToOpen:true});_7b.policy_manager=pm;dojo.forEach(_78,function(_7c){_7b.addChild(new dijit.MenuItem({label:"Show policy for Network '"+_7c.name+"'",onClick:dojo.hitch(this,function(_7d,e){cb(_7c.uid);},_7b)}));});this.attach_menu_listeners(_7b);return _7b;},create_ntp_server_menu:function(_7f,_80){var _81=new dijit.Menu({targetNodeIds:[_7f],leftClickToOpen:true});_81.serverName=_80;var _82=dojo.hitch(nox.ext.apps.vmanui.settings,"remove_ntp",_80);_81.addChild(new dijit.MenuItem({label:"Remove",onClick:_82}));this.attach_menu_listeners(_81);_81.startup();return _81;},create_admin_account_menu:function(_83,_84){var _85=[];var _86=(_84==nox.ext.apps.vmanui.User.username());var _87=(_84=="admin");var _88=nox.ext.apps.vmanui.User.hasCapability("admin-user-change-any-passwd");var _89=nox.ext.apps.vmanui.User.hasCapability("admin-user-change-my-passwd");var _8a=nox.ext.apps.vmanui.User.hasCapability("admin-user-change-priv");var _8b=nox.ext.apps.vmanui.User.hasCapability("admin-user-remove");var _8c=nox.ext.apps.vmanui.User.hasCapability("admin-user-remove-myself");if((_86&&_89)||_88){var _8d=dojo.hitch(nox.ext.apps.vmanui.settings,"show_change_cred_dialog",_84);_85.push(new dijit.MenuItem({label:"Change Password",onClick:_8d}));}if(!_87&&!_86&&_8a){var _8e=dojo.hitch(nox.ext.apps.vmanui.settings,"show_change_privileges_dialog",_84);_85.push(new dijit.MenuItem({label:"Change Privileges",onClick:_8e}));}if(!_87&&((_86&&_8c)||_8b)){var _8f=dojo.hitch(nox.ext.apps.vmanui.settings,"remove_user",_84);_85.push(new dijit.MenuItem({label:"Remove",onClick:_8f}));}if(_85.length){var _90=new dijit.Menu({targetNodeIds:[_83],leftClickToOpen:true});dojo.forEach(_85,function(_91){_90.addChild(_91);});this.attach_menu_listeners(_90);_90.startup();return _90;}},create_snapshot_menu:function(_92,_93){var _94=nox.ext.apps.vmanui.User;var _95=[];if(_94.hasCapability("restore-snapshot")){var _96=dojo.hitch(nox.ext.apps.vmanui.settings,"show_restore_snapshot_dialog",_93);_95.push(new dijit.MenuItem({label:"Restore to Snapshot",onClick:_96}));}if(_94.hasCapability("create-snapshot")){var _96=dojo.hitch(nox.ext.apps.vmanui.settings,"show_delete_snapshot_dialog",_93);_95.push(new dijit.MenuItem({label:"Delete Snapshot",onClick:_96}));}if(_94.hasCapability("import-export-snapshot")){var _97=dojo.hitch(nox.ext.apps.vmanui.settings,"download_snapshot",_93);_95.push(new dijit.MenuItem({label:"Download",onClick:_97}));}if(_95.length){var _98=new dijit.Menu({targetNodeIds:[_92],leftClickToOpen:true});dojo.forEach(_95,function(_99){_98.addChild(_99);});this.attach_menu_listeners(_98);_98.startup();return _98;}},create_syslog_menu:function(_9a,_9b){var _9c=new dijit.Menu({targetNodeIds:[_9a],leftClickToOpen:true});var _9d=dojo.hitch(nox.ext.apps.vmanui.settings,"remove_syslog",_9b);_9c.addChild(new dijit.MenuItem({label:"Remove",onClick:_9d}));this.attach_menu_listeners(_9c);_9c.startup();return _9c;},create_pool_modify_menu:function(_9e){var _9f=new dijit.Menu({targetNodeIds:[_9e],leftClickToOpen:true});var _a0=parseInt(_9e.getAttribute("xapi_status"))||-1;var uid=_9e.getAttribute("uid");_9f.pool_uid=_9e.getAttribute("pool_uid");_9f.pool_name=_9e.getAttribute("pool_name");_9f.addChild(new dijit.MenuItem({label:"Modify Pool",onClick:function(e){nox.ext.apps.vmanui.vac_status.start_modify_pool(_9f.pool_uid,null);}}));if(_a0!=10){_9f.addChild(new dijit.MenuItem({label:"Refresh Status",onClick:function(e){nox.ext.apps.vmanui.vac_status.refresh_pool(_9f.pool_uid);}}));}_9f.addChild(new dijit.MenuItem({label:"Remove Pool",onClick:function(e){if(_a0>0){nox.ext.apps.vmanui.vac_status.find_fail_mode(uid,function(_a5){frag.status.allpools.removeConfirmDialog.openDialog(_9f.pool_name,_9f.pool_uid,(_a5=="fail_safe"));});}else{frag.status.allpools.removeConfirmDialog.openDialog(_9f.pool_name,_9f.pool_uid,false);}}}));if(_a0==10){_9f.addChild(new dijit.MenuItem({label:"Steal Pool",onClick:function(e){nox.ext.apps.vmanui.vac_status.start_modify_pool(_9f.pool_uid,true);}}));}this.attach_menu_listeners(_9f);_9f.startup();return _9f;}});nox.ext.apps.vmanui.menu_creator.creator=new nox.ext.apps.vmanui.MenuCreator();}