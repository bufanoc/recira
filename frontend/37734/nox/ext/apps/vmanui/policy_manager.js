/* Copyright (c) 2008, 2009, 2010 Nicira, Inc. */

if(!dojo._hasResource["nox.ext.apps.vmanui.policy_manager"]){dojo._hasResource["nox.ext.apps.vmanui.policy_manager"]=true;dojo.provide("nox.ext.apps.vmanui.policy_manager");dojo.require("dojo._base.Deferred");dojo.require("dojo.DeferredList");dojo.require("dojo.data.ItemFileReadStore");dojo.require("nox.ext.apps.vmanui.role_policy_layer");dojo.require("nox.ext.apps.vmanui.role_qos_layer");dojo.require("nox.ext.apps.vmanui.role_rspan_layer");dojo.require("nox.ext.apps.vmanui.main");dojo.declare("nox.ext.apps.vmanui.PolicyManager",null,{_role_map:null,_proto_map:null,_nwaddrgroup_map:null,owner_uid:null,role_stack:null,menus:null,canceled:false,constructor:function(_1){this.owner_uid=_1;this._dirty_roles={};this._proto_map={};this._nwaddrgroup_map={};this.dirty_protos={};},_make_acl:function(_2,_3){return {action:"allow",uid:null,protocol_uid:null,description:_3,direction:_2,invert_remote_addresses:false,remote_groups:[],remote_customs:[]};},_do_get:function(_4){return nox.ext.apps.vmanui.xhrGet({url:_4,timeout:10000,handleAs:"json",preventCache:true});},initialize:function(){var d1=this._do_get("/ws.v1/protocol");var d2=this._do_get("/ws.v1/role/"+encodeURI(this.owner_uid)+"/stack");var d3=this._do_get("/ws.v1/group/nwaddr");var _8=new dojo.DeferredList([d1,d2,d3]);_8.addCallback(dojo.hitch(this,function(_9){this.init_deferred=null;var _a=false;if(_9.length!=3){nox.ext.apps.vmanui.main.console_log("Error: deferredlist expected 3 items, got: ",res);_a=true;}dojo.forEach(_9,function(_b){if(!_b[0]){nox.ext.apps.vmanui.main.console_log("Error loading policy data",_b[1]);_a=true;}});if(_a){all_done.callback(false);return;}this._proto_map={};dojo.forEach(_9[0][1],function(p){this._proto_map[p.uid]=p;},this);this.role_stack=_9[1][1];this.setRoleMapFromStack();this._nwaddgroup_map={};dojo.forEach(_9[2][1],function(g){this._nwaddrgroup_map[g[0]]={"uid":g[0],"name":g[1],"members":g[2]};},this);return true;}));this.init_deferred=_8;return _8;},setRoleMapFromStack:function(){this._role_map={};for(var i=0;i<this.role_stack.length;i++){if(dojo.isArray(this.role_stack[i])){var _f=this.role_stack[i];for(var j=0;j<_f.length;j++){this._role_map[_f[j].uid]=_f[j];}}else{this._role_map[this.role_stack[i].uid]=this.role_stack[i];}}return null;},setDisableMACSpoof:function(uid,val){this._role_map[uid].mac_spoof_disabled=val=="on"?"true":"false";this._dirty_roles[uid]="";},getDisableMACSpoof:function(uid){return this._role_map[uid].mac_spoof_disabled;},getRole:function(_14){return this._role_map[_14];},setRole:function(_15){if(_15.uid===undefined||_15.uid===null){nox.ext.apps.vmanui.main.console_log("error, cannot setRole with empty uid");return;}this._role_map[_15.uid]=_15;this._dirty_roles[_15.uid]="";this.onModify(_15);},onModify:function(_16){},saveAll:function(){return this.saveRoles();},saveRoles:function(){var _17=dijit.byId("csrf_token_v").getValue();var _18=new dojo.Deferred();var _19=[];for(var uid in this._dirty_roles){if(true){var _1b=dojo.clone(this.getRole(uid));_1b["csrf_token"]=_17;var d=nox.ext.apps.vmanui.rawXhrPut({url:"/ws.v1/role/"+encodeURI(uid),headers:{"content-type":"application/json","X-CSRF-Token":_17},putData:dojo.toJson(_1b),timeout:10000});_19.push(d);}}var _1d=new dojo.DeferredList(_19);_1d.addCallback(dojo.hitch(this,function(_1e){dojo.forEach(_1e,function(res){if(!res[0]){nox.ext.apps.vmanui.main.console_log("error saving role data",res[1]);return;}this._dirty_roles={};_18.callback();});this.onSaveSuccess();}));return _18;},onSaveSuccess:function(){},getProtocol:function(_20){return this._proto_map[_20];},getProtocolStore:function(){return this._get_readonlystore_from_uid_map(this._proto_map);},_get_readonlystore_from_uid_map:function(_21){var _22=[];for(var uid in _21){if(true){_22.push(dojo.clone(_21[uid]));}}var _24={identifier:"uid",label:"name",items:_22};return new dojo.data.ItemFileReadStore({data:_24});},_refresh_protocols:function(_25){var d2=this._do_get("/ws.v1/protocol");d2.addCallback(dojo.hitch(this,function(_27){this._proto_map={};dojo.forEach(_27,function(p){this._proto_map[p.uid]=p;},this);return _25.uid;}));return d2;},addProtocol:function(_29){var _2a=dijit.byId("csrf_token_v").getValue();var _2b=dojo.clone(_29);_2b["csrf_token"]=_2a;var d=nox.ext.apps.vmanui.rawXhrPost({url:"/ws.v1/protocol",headers:{"content-type":"application/json","X-CSRF-Token":_2a},postData:dojo.toJson(_2b),handleAs:"json",timeout:10000});d.addCallback(dojo.hitch(this,"_refresh_protocols"));return d;},modifyProtocol:function(_2d){var _2e=dijit.byId("csrf_token_v").getValue();var _2f=dojo.clone(_2d);_2f["csrf_token"]=_2e;var d=nox.ext.apps.vmanui.rawXhrPut({url:"/ws.v1/protocol/"+encodeURIComponent(_2f.uid),headers:{"content-type":"application/json","X-CSRF-Token":_2e},putData:dojo.toJson(_2f),handleAs:"json",timeout:10000});d.addCallback(dojo.hitch(this,"_refresh_protocols"));d.addErrback(function(){nox.ext.apps.vmanui.main.console_log("error modifying protocol: ",arguments);});return d;},deleteProtocol:function(uid){var _32=dijit.byId("csrf_token_v").getValue();var d=nox.ext.apps.vmanui.xhrDelete({url:"/ws.v1/protocol/"+encodeURIComponent(uid),headers:{"content-type":"application/json","X-CSRF-Token":_32},handleAs:"json",timeout:10000});d.addCallback(dojo.hitch(this,"_refresh_protocols"));return d;},getNWAddrGroup:function(_34){return this._nwaddrgroup_map[_34];},getNWAddrGroupStore:function(){return this._get_readonlystore_from_uid_map(this._nwaddrgroup_map);},isCanceled:function(){return this.canceled;},cancel:function(){this.canceled=true;if(this.init_deferred){this.init_deferred.cancel();this.init_deferred=null;}}});}