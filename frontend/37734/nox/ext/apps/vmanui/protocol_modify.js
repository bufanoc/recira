/* Copyright (c) 2008, 2009, 2010 Nicira, Inc. */

if(!dojo._hasResource["nox.ext.apps.vmanui.protocol_modify"]){dojo._hasResource["nox.ext.apps.vmanui.protocol_modify"]=true;dojo.provide("nox.ext.apps.vmanui.protocol_modify");dojo.require("dijit._Widget");dojo.require("dojox.dtl._Templated");dojo.require("dojox.dtl.Context");dojo.require("dijit.form.CheckBox");dojo.declare("nox.ext.apps.vmanui.protocol_modify",[dijit._Widget,dojox.dtl._Templated],{templateString:"<div class=\"protocol_modify\">\n\n  <div class=\"protocol_section\">Ethertype</div>\n\n  <div class=\"protocol_inputs\">\n    <input dojoType=\"dijit.form.RadioButton\" name=\"ethertype\" dojoAttachPoint=\"ethertype_ip\" type=\"radio\" />\n    <label>IP</label>\n    <input dojoType=\"dijit.form.RadioButton\" name=\"ethertype\" dojoAttachPoint=\"ethertype_other\" type=\"radio\" />\n    <label>Other</label>\n    <input dojoType=\"nox.ext.apps.vmanui.regex.EthertypeTextBox\" dojoAttachPoint=\"ethertype_other_text\" style=\"width: 120px; padding: 0;\"/>\n  </div>\n\n  <div class=\"protocol_section\" dojoAttachPoint=\"ip_row1\">IP Protocol</div>\n\n  <div class=\"protocol_inputs\" dojoAttachPoint=\"ip_row2\">\n    <input dojoType=\"dijit.form.RadioButton\" name=\"iptype\" dojoAttachPoint=\"iptype_any\" type=\"radio\" />\n    <label>Any</label>\n    <input dojoType=\"dijit.form.RadioButton\" name=\"iptype\" dojoAttachPoint=\"iptype_tcp\" type=\"radio\" />\n    <label>TCP</label>\n    <input dojoType=\"dijit.form.RadioButton\" name=\"iptype\" dojoAttachPoint=\"iptype_udp\" type=\"radio\" />\n    <label>UDP</label>\n    <input dojoType=\"dijit.form.RadioButton\" name=\"iptype\" dojoAttachPoint=\"iptype_icmp\" type=\"radio\" />\n    <label>ICMP</label>\n    <input dojoType=\"dijit.form.RadioButton\" name=\"iptype\" dojoAttachPoint=\"iptype_other\" type=\"radio\" />\n    <label>Other</label>\n    <input dojoType=\"nox.ext.apps.vmanui.regex.IPProtocolTextBox\" dojoAttachPoint=\"iptype_other_text\" style=\"width: 80px; padding: 0;\"/>\n  </div>\n\n  <div class=\"protocol_section\" dojoAttachPoint=\"tport_row1\">Destination Port</div>\n\n  <div class=\"protocol_inputs\" dojoAttachPoint=\"tport_row2\">\n    <input dojoType=\"dijit.form.RadioButton\" name=\"dst_port\" dojoAttachPoint=\"dst_port_any\" type=\"radio\" />\n    <label>Any</label>\n    <input dojoType=\"dijit.form.RadioButton\" name=\"dst_port\" dojoAttachPoint=\"dst_port_only\" type=\"radio\" />\n    <label>Only</label> port\n    <input dojoType=\"nox.ext.apps.vmanui.regex.TransportPortTextBox\" dojoAttachPoint=\"dst_port_text\" style=\"width: 120px; padding: 0;\" />\n  </div>\n\n  <div class=\"protocol_section\" dojoAttachPoint=\"tport_row3\">Source Port</div>\n\n  <div class=\"protocol_inputs\" dojoAttachPoint=\"tport_row4\">\n    <input dojoAttachPoint=\"src_port_any\" type=\"radio\" dojoType=\"dijit.form.RadioButton\" name=\"src_port\"/>\n    <label>Any</label>\n    <input dojoType=\"dijit.form.RadioButton\" name=\"src_port\" dojoAttachPoint=\"src_port_only\" type=\"radio\" />\n    <label>Only</label> port\n    <input dojoType=\"nox.ext.apps.vmanui.regex.TransportPortTextBox\" dojoAttachPoint=\"src_port_text\" style=\"width: 120px; padding: 0;\" />\n  </div>\n\n  <div class=\"protocol_section\" dojoAttachPoint=\"icmp_row1\" style=\"display: none;\">ICMP Type</div>\n\n  <div class=\"protocol_inputs\" dojoAttachPoint=\"icmp_row2\" style=\"display: none;\">\n    <input dojoType=\"dijit.form.RadioButton\" name=\"icmp_type\" dojoAttachPoint=\"icmp_type_any\" type=\"radio\" />\n    <label>Any</label>\n    <input dojoType=\"dijit.form.RadioButton\" name=\"icmp_type\" dojoAttachPoint=\"icmp_type_only\" type=\"radio\" />\n    <label>Only</label> type\n    <input dojoType=\"nox.ext.apps.vmanui.regex.ICMPTypeTextBox\" dojoAttachPoint=\"icmp_type_text\" style=\"width: 120px; padding: 0;\" />\n  </div>\n\n  <div class=\"protocol_section\" dojoAttachPoint=\"icmp_row3\" style=\"display: none;\">ICMP Code</div>\n\n  <div class=\"protocol_inputs\" dojoAttachPoint=\"icmp_row4\" style=\"display: none;\">\n    <input dojoAttachPoint=\"icmp_code_any\" type=\"radio\" dojoType=\"dijit.form.RadioButton\" name=\"icmp_code\"/>\n    <label>Any</label>\n    <input dojoType=\"dijit.form.RadioButton\" name=\"icmp_code\" dojoAttachPoint=\"icmp_code_only\" type=\"radio\" />\n    <label>Only</label> code\n    <input dojoType=\"nox.ext.apps.vmanui.regex.ICMPCodeTextBox\" dojoAttachPoint=\"icmp_code_text\" style=\"width: 120px; padding: 0;\" />\n  </div>\n\n  <div class=\"protocol_inputs\">\n    <input dojoAttachPoint=\"bidirectional\" dojoType=\"dijit.form.CheckBox\" type=\"checkbox\" />Match reply traffic\n  </div>\n\n  <div class=\"protocol_section\">One-time Use vs. Multiple Uses</div>\n\n  <div class=\"protocol_inputs\" dojoAttachPoint=\"div_name_custom\">\n    <input dojoType=\"dijit.form.RadioButton\" name=\"name_type\" dojoAttachPoint=\"name_custom\" type=\"radio\" />\n    Only use it once. Do NOT add it to the list of protocols.\n  </div>\n\n  <div class=\"protocol_inputs\">\n    <input dojoType=\"dijit.form.RadioButton\" name=\"name_type\" dojoAttachPoint=\"name_save\" type=\"radio\" />\n    Create a name for it and add it to the list of protocols.\n    <input dojoType=\"dijit.form.ValidationTextBox\" dojoAttachPoint=\"name\" promptMessage=\"Enter any string name for this protocol\" style=\"width: 120px; margin-left: 14px; padding: 0;\"/>\n  </div>\n\n  <div class=\"dialogButtonContainer\">\n{% if is_standalone %}\n    <button class=\"blueButton\" dojoType=\"dijit.form.Button\" dojoAttachPoint=\"save_button\">\n      Save &amp; Use\n    </button>\n    <button dojoType=\"dijit.form.Button\" dojoAttachPoint=\"cancel_button\">\n      Cancel\n    </button>\n{% else %}\n    <button class=\"blueButton\" dojoType=\"dijit.form.Button\" dojoAttachPoint=\"save_button\">\n      Save Protocol Changes\n    </button>\n    <button dojoType=\"dijit.form.Button\" dojoAttachPoint=\"delete_button\">\n      Delete Protocol\n    </button>\n{% endif %}\n  </div>\n\n</div>\n",widgetsInTemplate:true,is_new:null,protocol_uid:null,is_standalone:null,policy_manager:null,acl_widget:null,postMixInProperties:function(){},showProtocol:function(_1){this.is_new=false;this._redraw(_1);this.onShow();},showNewProtocol:function(){var _2={"ethertype":2048,"name":null,"unidirectional":false,"dst_port":null,"src_port":null,"iptype":6};this.is_new=true;this._redraw(_2);this.onShow();},_setup_other_click_listener:function(_3,_4){dojo.connect(_3,"onChange",dojo.hitch(this,function(_5,_6){var _7=!_5.getValue();if(_7){_6.setValue("");_6.focusNode.blur();}_6.setAttribute("disabled",_7);},_3,_4));},_reset_ip_settings:function(_8){this.iptype_tcp.setValue(true);dojo.forEach(["iptype_any","iptype_tcp","iptype_udp","iptype_icmp","iptype_other"],dojo.hitch(this,function(_9){this[_9].attr("disabled",_8);}));var _a=(_8)?"none":"";dojo.style(this.ip_row1,"display",_a);dojo.style(this.ip_row2,"display",_a);},_reset_transport_port_settings:function(_b){this.dst_port_any.setValue(true);this.dst_port_text.attr("disabled",true);this.src_port_any.setValue(true);this.src_port_text.attr("disabled",true);var _c=(_b)?"none":"";dojo.style(this.tport_row1,"display",_c);dojo.style(this.tport_row2,"display",_c);dojo.style(this.tport_row3,"display",_c);dojo.style(this.tport_row4,"display",_c);},_reset_icmp_settings:function(_d){this.icmp_type_any.setValue(true);this.icmp_type_text.attr("disabled",true);this.icmp_code_any.setValue(true);this.icmp_code_text.attr("disabled",true);var _e=(_d)?"none":"";dojo.style(this.icmp_row1,"display",_e);dojo.style(this.icmp_row2,"display",_e);dojo.style(this.icmp_row3,"display",_e);dojo.style(this.icmp_row4,"display",_e);},_reset_bidirectionality:function(_f){this.bidirectional.setValue(_f);var _10=!this.iptype_udp.getValue();this.bidirectional.attr("disabled",_10);},_redraw:function(_11){dojo.style(this.domNode,{"display":"block"});if(!this.is_new){this.protocol_uid=_11.uid;}var _12=_11.ethertype;var _13=(_12==2048);this.ethertype_ip.setValue(_13);dojo.connect(this.ethertype_ip,"onChange",dojo.hitch(this,function(){var _14=(this.ethertype_ip.getValue())?false:true;this._reset_ip_settings(_14);this._reset_transport_port_settings(_14);this._reset_icmp_settings(true);this._reset_bidirectionality(!_14);}));this.ethertype_other.setValue(!_13);if(!_13){var _15=dojo.string.pad(_12.toString(16).toUpperCase(),4,"0");this.ethertype_other_text.setValue("0x"+_15);}else{this.ethertype_other_text.setValue("");}if(_13){this.ethertype_other_text.setAttribute("disabled",true);}this._setup_other_click_listener(this.ethertype_other,this.ethertype_other_text);this.iptype_tcp.setValue(true);this.iptype_icmp.setValue(false);var _16=dojo.hitch(this,function(){var _17=!(this.iptype_tcp.getValue()||this.iptype_udp.getValue());this._reset_transport_port_settings(_17);this._reset_bidirectionality(!_17);});dojo.connect(this.iptype_tcp,"onChange",_16);dojo.connect(this.iptype_udp,"onChange",_16);var _18=dojo.hitch(this,function(){var _19=!(this.iptype_icmp.getValue());this._reset_icmp_settings(_19);if(!_19){this._reset_bidirectionality(false);}});dojo.connect(this.iptype_icmp,"onChange",_18);this._setup_other_click_listener(this.iptype_other,this.iptype_other_text);var _1a=_11.iptype;var _1b=false;if(_1a===null){this.iptype_any.setValue(true);}else{if(_1a==6){this.iptype_tcp.setValue(true);}else{if(_1a==17){this.iptype_udp.setValue(true);}else{if(_1a==1){this.iptype_icmp.setValue(true);}else{this.iptype_other.setValue(true);this.iptype_other_text.setValue(_1a);_1b=true;}}}}this.iptype_other_text.setAttribute("disabled",!_1b);this._setup_other_click_listener(this.src_port_only,this.src_port_text);this._setup_other_click_listener(this.dst_port_only,this.dst_port_text);this._setup_other_click_listener(this.icmp_type_only,this.icmp_type_text);this._setup_other_click_listener(this.icmp_code_only,this.icmp_code_text);if(_1a==6||_1a==17){var _1c=_11.dst_port;this.dst_port_any.setValue(_1c===null);this.dst_port_only.setValue(_1c!==null);this.dst_port_text.setAttribute("disabled",(_1c===null));this.dst_port_text.setValue((_1c!==null)?_1c:"");var _1d=_11.src_port;this.src_port_any.setValue(_1d===null);this.src_port_only.setValue(_1d!==null);this.src_port_text.setAttribute("disabled",(_1d===null));this.src_port_text.setValue((_1d!==null)?_1d:"");}else{if(_1a==1){var _1e=_11.src_port;this.icmp_type_any.setValue(_1e===null);this.icmp_type_only.setValue(_1e!==null);this.icmp_type_text.setAttribute("disabled",(_1e===null));this.icmp_type_text.setValue((_1e!==null)?_1e:"");var _1f=_11.dst_port;this.icmp_code_any.setValue(_1f===null);this.icmp_code_only.setValue(_1f!==null);this.icmp_code_text.setAttribute("disabled",(_1f===null));this.icmp_code_text.setValue((_1f!==null)?_1f:"");}}this._reset_bidirectionality(!_11.unidirectional);this.name_save.setValue(_11.name!==null);this.name_custom.setValue(_11.name===null);this._setup_other_click_listener(this.name_save,this.name);this.name.setAttribute("disabled",(_11.name===null));dojo.removeClass(this.div_name_custom,"hidden");this.name_save.attr("disabled",false);if(_11.uid&&_11.name){dojo.addClass(this.div_name_custom,"hidden");this.name_save.attr("disabled",true);}var _20=_11.name;if(_20!==null){this.name.setDisplayedValue(_20);}dojo.connect(this.save_button,"onClick",dojo.hitch(this,function(){if(!this.isValid()){return;}this._save();this.onSave();}));dojo.connect(this.cancel_button,"onClick",dojo.hitch(this,function(){this.onCancel();}));dojo.connect(this.delete_button,"onClick",dojo.hitch(this,function(){var _21=nox.ext.apps.vmanui.menu_creator.creator;var d=this.policy_manager.deleteProtocol(this.protocol_uid);d.addCallback(dojo.hitch(this,function(_23){this.onDelete();}));d.addErrback(function(_24){if(_24.status==409){nox.ext.apps.vmanui.main.vmanui_error("This protocol cannot be deleted "+" because it is currently being used in an ACL rule.");}else{main_module.vmanu_error("Failed to delete protocol");}});this.onSave();}));},isValid:function(){if(this.name_save.getValue()){if(this.name.getValue().length===0){this.name.focus();return false;}}if(this.ethertype_other.getValue()){if(this.ethertype_other_text.isValid()&&this.ethertype_other_text.getValue().length>0){return true;}else{this.ethertype_other_text.focus();return false;}}if(this.ethertype_ip.getValue()&&this.iptype_other.getValue()){if(this.iptype_other_text.isValid()&&this.iptype_other_text.getValue().length>0){var _25=this.iptype_other_text.getValue();if(_25==1||_25==6||_25==17){if(_25==1){this.iptype_icmp.setValue(true);}else{if(_25==6){this.iptype_tcp.setValue(true);}else{if(_25==17){this.iptype_udp.setValue(true);}}}this.iptype_other_text.setValue("");return false;}return true;}else{this.iptype_other_text.focus();return false;}}if(this.ethertype_ip.getValue()&&this.iptype_any.getValue()){return true;}if(this.ethertype_ip.getValue()&&(this.iptype_tcp.getValue()||this.iptype_udp.getValue())){if(!(this.src_port_any.getValue()||(this.src_port_text.isValid()&&this.src_port_text.getValue().length>0))){this.src_port_text.focus();return false;}if(!(this.dst_port_any.getValue()||(this.dst_port_text.isValid()&&this.dst_port_text.getValue().length>0))){this.dst_port_text.focus();return false;}return true;}if(this.ethertype_ip.getValue()&&this.iptype_icmp.getValue()){if(!(this.icmp_type_any.getValue()||(this.icmp_type_text.isValid()&&this.icmp_type_text.getValue().length>0))){this.icmp_type_text.focus();return false;}if(!(this.icmp_code_any.getValue()||(this.icmp_code_text.isValid()&&this.icmp_code_text.getValue().length>0))){this.icmp_code_text.focus();return false;}return true;}return false;},_save:function(){var _26={"iptype":null,"dst_port":null,"src_port":null,"name":null};if(!this.is_new){_26.uid=this.protocol_uid;}if(this.ethertype_ip.getValue()){_26.ethertype=2048;}else{_26.ethertype=parseInt(this.ethertype_other_text.getValue());}if(_26.ethertype==2048){if(this.iptype_any.getValue()){_26.iptype=null;}else{if(this.iptype_tcp.getValue()){_26.iptype=6;}else{if(this.iptype_udp.getValue()){_26.iptype=17;}else{if(this.iptype_icmp.getValue()){_26.iptype=1;}else{_26.iptype=parseInt(this.iptype_other_text.getValue());}}}}if(_26.iptype==6||_26.iptype==17){if(this.src_port_only.getValue()){_26.src_port=parseInt(this.src_port_text.getValue());}if(this.dst_port_only.getValue()){_26.dst_port=parseInt(this.dst_port_text.getValue());}}if(_26.iptype==1){if(this.icmp_type_only.getValue()){_26.src_port=parseInt(this.icmp_type_text.getValue());}if(this.icmp_code_only.getValue()){_26.dst_port=parseInt(this.icmp_code_text.getValue());}}}_26.unidirectional=!(this.bidirectional.getValue());if(!this.is_new){_26.uid=this.protocol_uid;}if(this.name_save.getValue()){_26.name=this.name.getValue();}if(this.is_new){var _27=this.policy_manager.addProtocol(_26);_27.addCallback(dojo.hitch(this,function(_28){var _29=nox.ext.apps.vmanui.menu_creator.creator;_29.change_protocol_for_acl(_28,this.acl_widget);}));_27.addErrback(function(){main_module.vmanu_error("Failed to add protocol");});}else{var d=this.policy_manager.modifyProtocol(_26);d.addCallback(dojo.hitch(this,function(_2b){var _2c=this.acl_widget.role_widget.getTopLayer();_2c.redrawAclsRecursive();this.onModify(_2b);}));d.addErrback(function(){main_module.vmanu_error("Failed to modify protocol");});}},onCancel:function(){},onSave:function(){},onShow:function(){},onModify:function(_2d){},onDelete:function(){},postCreate:function(){},uninitialize:function(){this.inherited(arguments);for(var f in this){if(f=="acl_widget"){continue;}var w=this[f];if(w&&dojo.isObject(w)&&dojo.isFunction(w.destroyRecursive)){w.destroyRecursive();}}}});}