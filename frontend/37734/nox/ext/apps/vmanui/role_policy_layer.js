/* Copyright (c) 2008, 2009, 2010 Nicira, Inc. */

if(!dojo._hasResource["nox.ext.apps.vmanui.role_policy_layer"]){dojo._hasResource["nox.ext.apps.vmanui.role_policy_layer"]=true;dojo.provide("nox.ext.apps.vmanui.role_policy_layer");dojo.require("dijit._Widget");dojo.require("dojox.dtl._Templated");dojo.require("dijit.form.FilteringSelect");dojo.require("nox.ext.apps.vmanui.acl");dojo.declare("nox.ext.apps.vmanui.role_policy_layer",[dijit._Widget,dijit._Templated],{widgetsInTemplate:true,templateString:"<div class=\"${role.xen_type}-shell\">\n  <div class=\"ruleContainer\">\n    <div dojoAttachPoint=\"header\" class=\"policyHeader ${role.xen_type} policyExpand\">\n      <span class=\"expandToggle\" dojoAttachEvent=\"onclick:toggleVisibility\" dojoAttachPoint=\"visibility_link\"></span>\n      <span class=\"policyLabel\" dojoAttachPoint=\"header_label\"></span>\n      <span class=\"policyViewOthers\" dojoAttachPoint=\"view_others\"></span>\n    </div>\n    <table width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" dojoAttachPoint=\"table\" class=\"TableFirewallPolicy acl-table\">\n      <tr class=\"${classname}\">\n        <th align=\"left\" class=\"TableHeaderGradientLight\" style=\"border-left: 1px solid #BFBFBF;\">Action</th>\n        <th align=\"left\" class=\"TableHeaderGradientLight\">Protocol</th>\n        <th align=\"left\" class=\"TableHeaderGradientLight\">Direction</th>\n        <th align=\"left\" class=\"TableHeaderGradientLight\">Remote Addresses</th>\n        <th align=\"left\" class=\"TableHeaderGradientLight\">\n          <span>\n            <input dojoType=\"dijit.form.RadioButton\" name=\"descRuleToggle\" dojoAttachPoint=\"desc_toggle\" type=\"radio\" checked=\"checked\" class=\"descRadio\" dojoAttachEvent=\"onClick:onShowDesc\" />\n            Description\n          </span>\n          <span>\n            <input dojoType=\"dijit.form.RadioButton\" name=\"descRuleToggle\" dojoAttachPoint=\"rule_toggle\" type=\"radio\" class=\"ruleRadio\" dojoAttachEvent=\"onClick:onShowRule\" />\n            Rule Details\n          </span>\n        </th>\n        <th align=\"left\" nowrap=\"nowrap\" class=\"TableHeaderGradientLight acl-hit-count\">Hit Count</th>\n        <th align=\"center\" class=\"TableHeaderGradientLight gear-image-table-header-light\" dojoAttachPoint=\"modify_cell\">&nbsp;</th>\n      </tr>\n    </table>\n  </div>\n</div>\n",policy_manager:null,role_index:null,is_stats:false,is_readonly:false,_acl_child_widgets:null,_acl_related_child_widgets:null,_header_related_child_widgets:null,parent_layer:null,show_desc:null,is_visible:null,constructor:function(){this.contentPane=null;this.show_desc=true;this.is_visible=false;this._acl_child_widgets=[];this._acl_related_child_widgets=[];this._header_related_child_widgets=[];this.menuFactory=nox.ext.apps.vmanui.menu_creator.creator;this.__menuCache={acl:{},placeholder:{}};},get_role:function(){return this.policy_manager.getRole(this.role_uid);},get_role_name:function(_1){var _2=this.role.name;if(_1){_2=_2.replace(/&/g,"&amp;");_2=_2.replace(/</g,"&lt;");_2=_2.replace(/>/g,"&gt;");}return _2;},clearAclCache:function(){for(var _3 in this.__menuCache.acl){var _4=this.__menuCache.acl[_3];this.__clearDirectCache(_4);delete this.__menuCache.acl[_3];}},clearPlaceholderCache:function(){this.__clearDirectCache(this.__menuCache.placeholder);},__clearDirectCache:function(_5){for(var _6 in _5){var _7=_5[_6];_7.destroyRecursive();_7=null;delete _5[_6];}},clearCache:function(){this.clearAclCache();this.clearPlaceholderCache();},cacheMenuByAclAndType:function(_8,_9,_a){var _b=this.__menuCache.acl[_9.id];if(!_b){this.__menuCache.acl[_9.id]={};}this.__menuCache.acl[_9.id][_a]=_8;},getCachedMenu:function(_c,_d){var _e=this.__menuCache.acl[_c];if(_e&&_e[_d]){return _e[_d];}},is_vif_role:function(){return (this.get_role().uid.search("vif;")===0);},_create_placeholder_acl:function(_f){if(this.is_readonly){return;}var _10=this.get_role();if(_f=="before"){if(_10.acl_split_before!==0){return;}}else{if(_f=="after"&&!this.is_vif_role()){if(_10.acl_split_before!=_10.acl_rules.length){return;}}else{return;}}var row=dojo.create("tr");dojo.addClass(row,"acl-placeholder-row");var _12=dojo.create("td");dojo.attr(_12,"colSpan",5);if(this.is_vif_role()){_12.innerHTML="No ACLs.";}else{var _13=(_f=="before")?"mandatory":"default";_12.innerHTML="No "+_13+" ACLs.";}dojo.style(_12,"borderRight","none");row.appendChild(_12);var _14=dojo.create("td");_14.id=_f+"_"+this.role_index;dojo.addClass(_14,"acl-button");_14.innerHTML="&nbsp;";dojo.style(_14,"borderLeft","none");row.appendChild(_14);dojo.addClass(row,this.classname);dojo.connect(_14,"onclick",this,"clickPlaceholderCell");dojo.place(row,this.tbody);},_create_inner_row:function(){if(this.is_vif_role()){return;}if(this.is_bottom&&!this.is_stats){var _15=new nox.ext.apps.vmanui.acl({acl:null,role_widget:this,type:null});this.track_acl_related(_15);dojo.addClass(_15.domNode,"innermost-row");_15.startup();dojo.addClass(_15.domNode,this.classname);dojo.place(_15.domNode,this.tbody);}else{if(!this.is_bottom){if(this.inner_cell===undefined){this.inner_cell=dojo.create("td");dojo.attr(this.inner_cell,"colSpan",8);dojo.addClass(this.inner_cell,"policyInnerContainer");this.inner_div=dojo.create("div");this.inner_cell.appendChild(this.inner_div);}else{var _16=this.inner_cell.parentNode;_16.parentNode.removeChild(_16);}var row=dojo.create("tr");row.appendChild(this.inner_cell);dojo.place(row,this.tbody);}}},track_acl:function(_18){this._acl_child_widgets.push(_18);},track_acl_related:function(_19){this._acl_related_child_widgets.push(_19);},track_header_related:function(_1a){this._header_related_child_widgets.push(_1a);},clickPlaceholderCell:function(e){var _1c=e.target;var sId=_1c.id;var _1e="";if(/(before|after)_(\d+)/.test(sId)){_1e=RegExp.$1;var _1f=this.__menuCache.placeholder[_1e];if(!_1f){var _20=(_1e=="after")?"before":"after";var _1f=this.menuFactory.create_simple_acl_menu(_1c,this,this.policy_manager,_20);this.track_acl_related(_1f);this.__menuCache.placeholder[_1e]=_1f;_1f._openMyself(e);}}},clickRemote:function(_21){var _22="remote";var _23=this.getCachedMenu(_21.id,_22);if(!_23){_23=this.menuFactory.show_remote_dialog(_21,this.policy_manager);this.track_acl_related(m);this.cacheMenuByAclAndType(_23,_21,_22);_23._openMyself(e);}},clickNetworkChange:function(e){var _25=this.policy_manager.role_stack[this.role_index];if(!this.networkChangeMenu){this.networkChangeMenu=this.menuFactory.create_changevisibleuid_menu(this.view_others,_25,this.policy_manager,dojo.hitch(this,"changeVisibleUid"));this.track_header_related(this.networkChangeMenu);this.networkChangeMenu._openMyself(e);dojo.disconnect(this.connectNetworkChange);}},clickGearCell:function(e){if(!this.roleGearMenu){this.roleGearMenu=this.menuFactory.create_simple_acl_menu(this.modify_cell,this,this.policy_manager);this.track_header_related(this.roleGearMenu);this.roleGearMenu._openMyself(e);dojo.disconnect(this.connectModifyCell);}},clickCellLink:function(_27,_28,_29,_2a,e){var m=this.getCachedMenu(_28.id,_29);if(!m){m=this.menuFactory[_2a](_27,_28,this.policy_manager);this.track_acl_related(m);this.cacheMenuByAclAndType(m,_28,_29);m._openMyself(e);}},changeDescription:function(_2d,_2e){var _2f=_2d.role_widget.role;var pm=_2d.role_widget.policy_manager;var _31=_2d.acl.ui_index;_2f.acl_rules[_31].description=_2e;pm.setRole(_2f);},_draw_acls:function(){this.clearCache();var _32=this.get_role();if(this.table){dojo.query(".acl-placeholder-row",this.table).forEach(function(row){if(row.parentNode.parentNode==this.table){row.parentNode.removeChild(row);}},this);}var _34="before";this._create_placeholder_acl("before");this._acl_child_widgets=[];for(var i=0;i<_32.acl_rules.length;i++){if(i==_32.acl_split_before){this._create_inner_row();_34="after";}var acl=_32.acl_rules[i];acl.ui_index=i;var _37=new nox.ext.apps.vmanui.acl({acl:acl,role_widget:this,type:_34});_37.startup();dojo.addClass(_37.domNode,this.classname);dojo.place(_37.domNode,this.tbody,"last");this.track_acl(_37);this.track_acl_related(_37);if(this.is_stats){for(var j=0;j<_32.acl_rules.length;j++){var _39=_32.acl_rules[j];if(_39.invert_remote_addresses&&_39.remote_groups.length===0&&_39.remote_customs.length===0){var s=byId("acl-hits-uid-"+_39.uid,this.domNode);if(s){s.innerHTML="0";}}}}}if(_32.acl_rules.length==_32.acl_split_before||_32.acl_rules.length===0){this._create_inner_row();}this._create_placeholder_acl("after");this.setVisibilityCSS();},setDescriptionCSS:function(){dojo.forEach(this._acl_child_widgets,function(_3b){_3b.setDescRuleDisplay();});if(this.show_desc){dojo.query(".descRadio",this.domNode).addClass("dijitRadioChecked");dojo.query(".ruleRadio",this.domNode).removeClass("dijitRadioChecked");}else{dojo.query(".ruleRadio",this.domNode).addClass("dijitRadioChecked");dojo.query(".descRadio",this.domNode).removeClass("dijitRadioChecked");}},setVisibilityCSS:function(){var _3c=(this.is_visible)?"":"none";var cls=(this.is_visible)?"policyCollapse":"policyExpand";dojo.query("."+this.classname,this.domNode).forEach(function(_3e){dojo.style(_3e,{display:_3c});});dojo.removeClass(this.header,"policyCollapse");dojo.removeClass(this.header,"policyExpand");dojo.addClass(this.header,cls);if(this.inner_cell!==undefined){if(this.is_visible){dojo.addClass(this.inner_cell,"expandRuleContainer");}else{dojo.removeClass(this.inner_cell,"expandRuleContainer");}}},postMixInProperties:function(){var tab=nox.ext.apps.vmanui.main.current_tabs["vac"];if(tab=="policy"){this.contentPane=dijit.byId("policy");}var _40=this.getBottomLayer();while(this.role_index<this.policy_manager.role_stack.length){var _41=this.policy_manager.role_stack[this.role_index];if(dojo.isArray(_41)){if(_41.length===0){this.role_index++;continue;}var _42=dojo.map(_41,function(_43){return _43.uid;});var uid=null;if(this.contentPane){uid=this.contentPane.ui_state[_40.uid].role_to_show[this.role_index];}if(uid&&(dojo.indexOf(_42,uid)!=-1)){this.role_uid=uid;}else{this.role_uid=_41[0].uid;}}else{this.role_uid=_41.uid;}break;}this.role=this.get_role();this.is_bottom=this.role_index==this.policy_manager.role_stack.length-1;var _45;if(this.contentPane){_45=this.contentPane.ui_state[_40.uid].visibility_state[this.role_uid];}if(_45!=undefined){this.is_visible=_45;}else{this.is_visible=this.is_bottom;}this.classname=this.role_uid+"-content";},redraw_acls:function(){this.header_label.innerHTML=this._getHeaderLabel();this._acl_child_widgets=[];this._destroyChildWidgets(this._acl_related_child_widgets);this._draw_acls();},postCreate:function(){this.tbody=dojo.query("tbody",this.table)[0];this.redraw_acls();if(!this.is_bottom){this.child=new nox.ext.apps.vmanui.role_policy_layer({role_index:this.role_index+1,policy_manager:this.policy_manager,is_stats:this.is_stats,is_readonly:this.is_readonly,parent_layer:this},this.inner_div);this.child.startup();}if(this.is_stats){dojo.addClass(this.domNode,"policy-table-with-stats");}var _46=this.policy_manager.role_stack[this.role_index];var m=null;if(dojo.isArray(_46)&&_46.length>1){dojo.style(this.view_others,{"display":"inline"});this.view_others.innerHTML="Change Network";this.connectNetworkChange=dojo.connect(this.view_others,"onclick",this,"clickNetworkChange");}if(!this.is_readonly){this.connectModifyCell=dojo.connect(this.modify_cell,"onclick",this,"clickGearCell");}},_destroyChildWidgets:function(_48){dojo.forEach(_48,function(_49){try{_49.destroyRecursive();_49=null;}catch(e){}});_48=[];},redrawAclsRecursive:function(){this.redraw_acls();if(this.child){this.child.redrawAclsRecursive();}},toggleVisibility:function(){this.setVisibility(dojo.hasClass(this.header,"policyExpand"));},setVisibility:function(_4a){this.is_visible=_4a;this.setVisibilityCSS();var _4b=this.getBottomLayer();if(this.contentPane){this.contentPane.ui_state[_4b.uid].visibility_state[this.role_uid]=_4a;}},recursiveEnforceVisibility:function(){this.setVisibility(this.is_visible);if(this.child){this.child.recursiveEnforceVisibility();}},recursiveSetVisibility:function(_4c){if(this.child){this.setVisibility(_4c);this.child.recursiveSetVisibility(_4c);}else{this.setVisibility(true);}},recursiveSetShowDescription:function(_4d){this.show_desc=_4d;this.setDescriptionCSS();if(this.child){this.child.recursiveSetShowDescription(_4d);}this.onShowDescChange(_4d);},onShowDescChange:function(_4e){},onShowRule:function(){this.changeShowDesc(false);},onShowDesc:function(){this.changeShowDesc(true);},changeShowDesc:function(_4f){var _50=this.getTopLayer();_50.recursiveSetShowDescription(_4f);},getBottomLayer:function(){var _51=this.policy_manager.role_stack.length-1;return this.policy_manager.role_stack[_51];},getTopLayer:function(){if(this.parent_layer===null){return this;}else{return this.parent_layer.getTopLayer();}},onModify:function(){},changeVisibleUid:function(_52){var _53=this.getBottomLayer();if(this.contentPane){this.contentPane.ui_state[_53.uid].role_to_show[this.role_index]=_52;}this.role_uid=_52;this.role=this.get_role();this.redraw_acls();},_getHeaderLabel:function(){var _54=this.role.uid.split(";")[0];switch(_54){case "global":return "Global Policy";case "pool":return "Policy for pool '"+this.get_role_name(true)+"'";case "network":return "Policy for network '"+this.get_role_name(true)+"'";case "vm":return "Policy for VM '"+this.get_role_name(true)+"'";case "vif":return "Policy for Interface '"+this.get_role_name(true)+"'";default:return "Policy for '"+this.get_role_name(true)+"'";}},uninitialize:function(){this.inherited(arguments);this.desc_toggle.destroyRecursive();this.rule_toggle.destroyRecursive();if(this.child){this.child.destroyRecursive();}this._acl_child_widgets=[];this._destroyChildWidgets(this._acl_related_child_widgets);this._destroyChildWidgets(this._header_related_child_widgets);}});}