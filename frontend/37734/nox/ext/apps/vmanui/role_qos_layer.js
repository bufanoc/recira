/* Copyright (c) 2008, 2009, 2010 Nicira, Inc. */

if(!dojo._hasResource["nox.ext.apps.vmanui.role_qos_layer"]){dojo._hasResource["nox.ext.apps.vmanui.role_qos_layer"]=true;dojo.provide("nox.ext.apps.vmanui.role_qos_layer");dojo.require("nox.ext.apps.vmanui.role_config_layer");dojo.declare("nox.ext.apps.vmanui.role_qos_layer",[nox.ext.apps.vmanui.role_config_layer],{templateString:"\n<div style=\"\" > \n  \n  <p class=\"qosHeader {{role.xen_type}}\">\n    <span dojoAttachPoint=\"label\"></span>  \n  {% if is_bottom %}\n            </p> \n            <input dojoType=\"dijit.form.RadioButton\" name=\"qos_config\" \n            dojoAttachPoint=\"inherit\" type=\"radio\" \n            dojoAttachEvent=\"onClick:onRadioChange\"/>\n            {% if is_global  %}  \n              No global QoS policy\n            {% else %} \n              Inherit QoS policy from parent \n            {% endif %}\n            <div dojoAttachPoint=\"off_block\"> \n            <br> \n            <input dojoType=\"dijit.form.RadioButton\" name=\"qos_config\"\n            dojoAttachPoint=\"off\" type=\"radio\"  \n            dojoAttachEvent=\"onClick:onRadioChange\"/>\n            Disable inherited QoS policy\n            </div> \n            <br> \n            <input dojoType=\"dijit.form.RadioButton\" name=\"qos_config\"\n            dojoAttachPoint=\"set\" type=\"radio\" \n            dojoAttachEvent=\"onClick:onRadioChange\"/>\n            Apply a QoS limit of \n            <input dojoType=\"dijit.form.NumberSpinner\"\n            constraints=\"{min:1,places:0}\"\n            smallDelta=\"1\"\n            required=\"true\"\n            intermediateChanges=\"true\"\n            dojoAttachPoint=\"set_rate\" style=\"width:100px;\"\n            dojoAttachEvent=\"onClick:onEdit\" />  \n            <select dojoType=\"dijit.form.FilteringSelect\" dojoAttachPoint=\"set_rate_unit\" \n              style=\"width: 100px\" dojoAttachEvent=\"onClick:onEdit\" > \n              <option value=\"1000\" selected=\"true\"> Kbit / sec </option> \n              <option value=\"1000000\"> Mbit / sec </option> \n              <option value=\"1000000000\"> Gbit / sec </option> \n            </select>\n            with a burst size of  \n            <input dojoType=\"nox.ext.apps.vmanui.role_qos_layer.BurstSizeNumberSpinner\"\n            constraints=\"{min:1,places:0}\"\n            intermediateChanges=\"true\"\n            smallDelta=\"1\"\n            required=\"true\" \n            dojoAttachPoint=\"set_burst\" style=\"width:100px;\"\n            dojoAttachEvent=\"onClick:onEdit\" />  \n            <select dojoType=\"dijit.form.FilteringSelect\" dojoAttachPoint=\"set_burst_unit\" \n              style=\"width: 100px\" dojoAttachEvent=\"onClick:onEdit, onChange:onChangeBurstUnit\" > \n              <option value=\"1000\" selected=\"true\"> Kbits </option> \n              <option value=\"1000000\"> Mbits </option> \n              <option value=\"1000000000\"> Gbits </option> \n            </select> \n          \n   {% else %} \n   <span dojoAttachPoint=\"text_desc\"> </span> \n   <span class=\"policyViewOthers\" dojoAttachPoint=\"view_others\"></span> \n      \n   </p> \n            <div class=\"innerContainer\" dojoAttachPoint=\"inner_div\" ></div> \n   {% endif %} \n</div>  \n",widgetsInTemplate:true,fields:["inherit","off","set","set_rate","set_rate_unit","set_burst","set_burst_unit"],_getHeaderLabel:function(){return "QoS policy for '"+this.get_role_name(true)+"':";},isConfigSet:function(){var q=this.role.qos;return q=="set"||q=="off";},_drawNonBottom:function(){var _2=this.role.qos;var _3=this.role.qos_limit_kbps;var _4=this.role.qos_burst_kbps;this.label.innerHTML=this._getHeaderLabel();if(_2=="set"){this.text_desc.innerHTML="QoS limit of "+this._get_unit_text(_3,true)+" and max-burst "+this._get_unit_text(_4,false);}else{if(_2=="off"){this.text_desc.innerHTML="QoS enforcement disabled";}else{this.text_desc.innerHTML=this.is_global?"None":"";}}dojo.addClass(this.text_desc,"role-config-data");this.updateStrikeThrough();},_drawBottom:function(){var _5=this.role.qos;var _6=this.role.qos_limit_kbps*1000;var _7=this.role.qos_burst_kbps*1000;this.label.innerHTML=this._getHeaderLabel();if(_5=="set"){this.set.setValue(true);var _8=this._get_unit_multiplier(_6);var _9=_6/_8;this.set_rate.setValue(_9);this.set_rate_unit.setValue(_8);var _a=this._get_unit_multiplier(_7);var _b=_7/_a;this.set_burst.setValue(_b);this.set_burst_unit.setValue(_a);}else{if(_5=="off"){this.off.setValue(true);}else{this.inherit.setValue(true);}}},_postCreateSetup:function(){if(!this.is_bottom){this.child=new nox.ext.apps.vmanui.role_qos_layer({role_index:this.role_index+1,policy_manager:this.policy_manager,parent_layer:this,is_readonly:this.is_readonly});this.inner_div.appendChild(this.child.domNode);this.child.startup();this._drawNonBottom();}else{this._drawBottom();this.update_controls();dojo.forEach(this.fields,dojo.hitch(this,function(_c){if(this[_c]){this.child_widgets.push(this[_c]);}}));this.set_burst.unitsWidget=this.set_burst_unit;dojo.connect(this.set_rate,"onChange",dojo.hitch(this,"save"));dojo.connect(this.set_rate_unit,"onChange",dojo.hitch(this,"save"));dojo.connect(this.set_rate_unit,"onKeyUp",dojo.hitch(this,"save"));dojo.connect(this.set_burst,"onChange",dojo.hitch(this,"save"));dojo.connect(this.set_burst_unit,"onChange",dojo.hitch(this,"save"));dojo.connect(this.set_burst_unit,"onKeyUp",dojo.hitch(this,"save"));}},onEdit:function(){nox.ext.apps.vmanui.main.editStarted();},onChangeBurstUnit:function(_d){this.set_burst.validate();},inputIsValid:function(){if(this.inherit.getValue()||this.off.getValue()){return true;}var _e=true;dojo.forEach(this.fields,function(_f){if(_f=="inherit"||_f=="off"||_f=="set"){return;}if(!this[_f].isValid()){this[_f].focus();_e=false;}},this);return _e;},save:function(){if(!this.inputIsValid()){this.onIsValidChange(false);return;}this.onIsValidChange(true);if(this.set.getValue()){this.role.qos="set";var l=this.set_rate.getValue()*this.set_rate_unit.getValue();this.role.qos_limit_kbps=parseInt(l/1000,10);this.role.qos_burst="set";var b=this.set_burst.getValue()*this.set_burst_unit.getValue();this.role.qos_burst_kbps=parseInt(b/1000,10);}else{if(this.off.getValue()){this.role.qos="off";this.role.qos_limit_kbps=null;this.role.qos_burst="off";this.role.qos_burst_kbps=null;}else{this.role.qos="inherit";this.role.qos_limit_kbps=null;this.role.qos_burst="inherit";this.role.qos_burst_kbps=null;}}this.policy_manager.setRole(this.role);},onRadioChange:function(){var qos=this.role.qos;var _13=(!(this.set.getValue()&&qos=="set"||this.off.getValue()&&qos=="off"||this.inherit.getValue()&&qos=="inherit"));this.update_controls();if(_13){this.save();this.onEdit();}},update_controls:function(){var _14=this.set.getValue();if(!_14){this.set_rate.setValue("");this.set_rate_unit.setValue("");this.set_burst.setValue("");this.set_burst_unit.setValue("");}else{if(isNaN(this.set_rate.getValue())){this.set_rate.setValue("100");this.set_rate_unit.setValue("1000");this.set_burst.setValue("100");this.set_burst_unit.setValue("1000");}}this.set_rate.attr("disabled",!_14);this.set_rate_unit.attr("disabled",!_14);this.set_burst.attr("disabled",!_14);this.set_burst_unit.attr("disabled",!_14);if(this.parent_layer!==null){this.updateAllStrikeThrough();}if(this.is_readonly){dojo.forEach(this.fields,dojo.hitch(this,function(_15){if(this[_15]){this[_15].attr("disabled",true);}}));}},changeVisibleUid:function(_16){this.role_uid=_16;this.role=this.get_role();this._drawNonBottom();this.updateAllStrikeThrough();},_get_unit_multiplier:function(_17){var _18=1;while(_17>=(_18*1000)){_18*=1000;}return _18;},_get_unit_text:function(_19,_1a){var _1b=1;while((_19/(_1b*1000))>=1){_1b*=1000;}var _1c={1:"K",1000:"M",1000000:"G"};var p=_1c[_1b];if(p===undefined){return "?";}var _1e=_1a?p+"bit / sec":p+"bits";return parseInt(_19/_1b,10)+" "+_1e;}});dojo.require("dijit.form.NumberSpinner");dojo.declare("nox.ext.apps.vmanui.role_qos_layer.BurstSizeNumberSpinner",dijit.form.NumberSpinner,{unitsWidget:null,minimumBurstSpeed:13000,__errorType:0,minimumSpeedErrorMessage:"Burst size cannot be under 13 Kbits",isValid:function(){var _1f=this.inherited(arguments);this.errorType(0);if(_1f&&this.unitsWidget){var _20=this.unitsWidget.getValue();var _21=this.getValue()*_20;if(_21>=this.minimumBurstSpeed){_1f=true;}else{this.errorType(1);_1f=false;}}return _1f;},getErrorMessage:function(){if(this.errorType()==1){return this.minimumSpeedErrorMessage;}return this.inherited(arguments);},errorType:function(){if(arguments.length){this.__errorType=arguments[0];return this;}return this.__errorType;}});}