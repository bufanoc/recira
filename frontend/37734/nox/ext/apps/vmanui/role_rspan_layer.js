/* Copyright (c) 2008, 2009, 2010 Nicira, Inc. */

if(!dojo._hasResource["nox.ext.apps.vmanui.role_rspan_layer"]){dojo._hasResource["nox.ext.apps.vmanui.role_rspan_layer"]=true;dojo.provide("nox.ext.apps.vmanui.role_rspan_layer");dojo.require("nox.ext.apps.vmanui.role_config_layer");dojo.declare("nox.ext.apps.vmanui.role_rspan_layer",[nox.ext.apps.vmanui.role_config_layer],{templateString:"<div>\n  <p class=\"role_spanHeader {{role.xen_type}}\">\n    <span dojoAttachPoint=\"label\"></span>\n{% if not is_bottom %}\n    <span dojoAttachPoint=\"text_desc\"></span>\n    <span class=\"policyViewOthers\" dojoAttachPoint=\"view_others\"></span>\n{% endif %}\n  </p>\n\n{% if is_bottom %}\n  <input dojoType=\"dijit.form.RadioButton\" name=\"rspan_config\"\n    dojoAttachPoint=\"inherit\" type=\"radio\"\n    dojoAttachEvent=\"onClick:onRadioChange\"/>\n    {% if is_global %}\n      No global RSPAN policy\n    {% else %}\n      Inherit RSPAN policy from parent\n    {% endif %}\n  <div dojoAttachPoint=\"off_block\">\n    <br />\n    <input dojoType=\"dijit.form.RadioButton\" name=\"rspan_config\"\n      dojoAttachPoint=\"off\" type=\"radio\"\n      dojoAttachEvent=\"onClick:onRadioChange\"/>\n  Disable inherited RSPAN policy\n  </div>\n  <br>\n  <input dojoType=\"dijit.form.RadioButton\" name=\"rspan_config\"\n  dojoAttachPoint=\"set\" type=\"radio\"\n  dojoAttachEvent=\"onClick:onRadioChange\" />\n  RSPAN traffic to target VLAN\n  <input dojoType=\"dijit.form.FilteringSelect\" dojoAttachPoint=\"set_value\" required=\"true\" dojoAttachEvent=\"onClick:onEdit\" />\n  <span class=\"link vlan_link\" style=\"margin-left:15px\">Manage target VLAN list</span>\n  <span class=\"bad_vlan error_span\"></span>\n{% else %}\n  <div class=\"innerContainer\" dojoAttachPoint=\"inner_div\" ></div>\n{% endif %}\n</div>\n",widgetsInTemplate:true,fields:["inherit","off","set","set_value"],isConfigSet:function(){var r=this.role.rspan;return r=="set"||r=="off";},_getHeaderLabel:function(){return "RSPAN policy for '"+this.get_role_name(true)+"':";},_drawNonBottom:function(){var _2=this.role.rspan;var _3=this.role.rspan_vlan;this.label.innerHTML=this._getHeaderLabel();if(_2=="set"){this.text_desc.innerHTML="RSPAN to VLAN "+_3;}else{if(_2=="off"){this.text_desc.innerHTML="RSPAN disabled";}else{this.text_desc.innerHTML=this.is_global?"None":"";}}dojo.addClass(this.text_desc,"role-config-data");this.updateStrikeThrough();},postCreate:function(){if(this.set_value){this.set_value.store=this.vlanStore();}this.inherited(arguments);},_postCreateSetup:function(){var _4=this.role.rspan;var _5=this.role.rspan_vlan;if(this.set_value){this.badVlanSpan=dojo.query(".bad_vlan",this.domNode)[0];this.statusLink=dojo.query("span.vlan_link",this.domNode)[0];this.set_value.store.fetch({onComplete:dojo.hitch(this,"initRspanValueStore")});}if(!this.is_bottom){this.child=new nox.ext.apps.vmanui.role_rspan_layer({role_index:this.role_index+1,policy_manager:this.policy_manager,parent_layer:this,is_readonly:this.is_readonly});this.inner_div.appendChild(this.child.domNode);this.child.startup();this._drawNonBottom();}else{this.label.innerHTML=this._getHeaderLabel();if(_4=="set"){this.set_value.attr("value",_5);this.set_value.validate();this.badVlanSpan.innerHTML="";if(!this.set_value.isValid()||this.set_value.attr("value")!=_5){if(this.badVlanSpan){this.badVlanSpan.innerHTML="Saved value "+_5+" is no longer available. Please "+"choose a valid VLAN or another policty "+"option.";var h=dojo.connect(this.policy_manager,"onSaveSuccess",this,function(){if(this.badVlanSpan){this.badVlanSpan.innerHTML="";}dojo.disconnect(h);});}}this.set.setValue(true);}else{if(_4=="off"){this.off.setValue(true);}else{this.inherit.setValue(true);}}this.update_controls();dojo.forEach(this.fields,dojo.hitch(this,function(_7){if(this[_7]){this.child_widgets.push(this[_7]);}}));dojo.connect(this.set_value,"onChange",dojo.hitch(this,"save"));}},getBestTreeUid:function(){var _8=false;var _9=nox.ext.apps.vmanui.main.current_tree_item.tree_uid;var _a=nox.ext.apps.vmanui.vac;var nt=_a.node_types;var pt=_a.parent_types;var ct=0;while(_8==false&&ct<30){var _e=_9.split("_");var _f=_e[0];if(_f==nt.ALL_POOLS||_f==nt.POOL||_f==nt.NETWORK||_f==nt.SERVER_NETWORK){_8=true;}else{_e[0]=pt[_f];_e.pop();_9=_e.join("_");}ct++;}if(_8){return _9;}return null;},initRspanValueStore:function(_10){if(this.statusLink){if(_10.length==0){var id=this.getBestTreeUid();if(id){dojo.style(this.statusLink,{"display":"inline"});this.statusLink.onclick=function(){nox.ext.apps.vmanui.vac.show_vac_tab("status",id);};}else{this.statusLink.onclick=null;}}else{dojo.style(this.statusLink,{"display":"none"});}}},onEdit:function(){nox.ext.apps.vmanui.main.editStarted();},inputIsValid:function(){if(this.inherit.getValue()||this.off.getValue()){return true;}if(!this.set_value.isValid()){this.set_value.focus();return false;}return true;},save:function(){if(!this.inputIsValid()){this.onIsValidChange(false);return;}if(this.set.getValue()){this.role.rspan="set";this.role.rspan_vlan=this.set_value.getValue();}else{if(this.off.getValue()){this.role.rspan="off";this.role.rspan_vlan=null;}else{this.role.rspan="inherit";this.role.rspan_vlan=null;}}this.onIsValidChange(true);this.policy_manager.setRole(this.role);},onRadioChange:function(){var _12=this.role.rspan;var _13=(!(_12=="set"&&this.set.getValue()||_12=="off"&&this.off.getValue()||_12=="inherit"&&this.inherit.getValue()));if(_13){this.onEdit();this.save();this.update_controls();}},getRoleStackVlans:function(){var _14=this.getRoleStackIdMap();var _15=[];if(_14.global){_15=this.getVlans();if(_14.pool){var _16=this.getVlans(_14.pool);_15=nox.ext.apps.vmanui.util.arrayUnion(_15,_16);if(_14.network){var _17=[];if(dojo.isArray(_14.network)){var _18=[];dojo.forEach(_14.network,function(_19){_18.push(this.getVlans(_14.pool,_19));},this);_17=nox.ext.apps.vmanui.util.arrayIntersect.apply(null,_18);}else{_17=this.getVlans(_14.pool,_14.network);}_15=nox.ext.apps.vmanui.util.arrayUnion(_15,_17);}}}return _15;},vlanUrl:function(_1a,_1b){if(_1a&&_1b){return ["/ws.v1","xen_directory",_1a,"network",_1b,"vlan"].join("/");}else{if(_1a){return ["/ws.v1","xen_directory",_1a,"vlan"].join("/");}else{return "/ws.v1/xen_directory/vlan";}}},getVlans:function(_1c,_1d){var url=this.vlanUrl(_1c,_1d);var _1f=[];nox.ext.apps.vmanui.xhrGet({url:url,sync:true,handleAs:"json",preventCache:true,timeout:10000,load:function(_20,_21){_1f=nox.ext.apps.vmanui.util.keys(_20);},error:function(_22,_23){console.log(_22);}});return _1f;},getRoleStackIdMap:function(){ids={};dojo.forEach(this.policy_manager.role_stack,function(_24){if(dojo.isArray(_24)){if(_24.length&&_24[0].xen_type=="network"){ids[_24[0].xen_type]=[];dojo.forEach(_24,function(_25){var id=_25.uid.replace(_25.xen_type+";","");ids[_25.xen_type].push(id);},this);}}else{var id=_24.uid.replace(_24.xen_type+";","");ids[_24.xen_type]=id;}},this);return ids;},vlanStore:function(){this.getRoleStackVlans();var _28={identifier:"name",label:"name",items:[]};_28.items=dojo.map(this.getRoleStackVlans().sort(function(a,b){return a-b;}),function(_2b){return {name:_2b};});return new dojo.data.ItemFileReadStore({data:_28});},update_controls:function(){this.set_value.attr("disabled",!this.set.getValue());if(!this.set.getValue()){this.set_value.setValue("");}if(this.parent_layer!==null){this.updateAllStrikeThrough();}if(this.is_readonly){dojo.forEach(this.fields,dojo.hitch(this,function(_2c){if(this[_2c]){this[_2c].attr("disabled",true);}}));}},changeVisibleUid:function(_2d){this.role_uid=_2d;this.role=this.get_role();this._drawNonBottom();this.updateAllStrikeThrough();}});}