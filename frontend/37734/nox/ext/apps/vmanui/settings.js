/* Copyright (c) 2008, 2009, 2010 Nicira, Inc. */

if(!dojo._hasResource["nox.ext.apps.vmanui.settings"]){dojo._hasResource["nox.ext.apps.vmanui.settings"]=true;dojo.provide("nox.ext.apps.vmanui.settings");dojo.require("dojo.io.iframe");dojo.require("nox.ext.apps.vmanui.strftime");(function(){var _1=nox.ext.apps.vmanui;var _2=nox.ext.apps.vmanui.settings;var _3=nox.ext.apps.vmanui.util;_2.MAX_NAME_LENGTH=32;_2.menuManager=null;_2.on_settings_load=function(){_2.set_document_title();_1.main.set_section_container_display("block");_1.main.make_current_viewable();if(!_2.menuManager){_2.menuManager=new nox.ext.apps.vmanui.settingsMenus();}_2.menuManager.createMenus();dojo.subscribe("settingsContainer-selectChild",function(_4){_1.main.current_tabs["settings"]=_4.id;dojo.style(_4.id,{display:"block"});_2.set_document_title();_1.main.update_history();_1.main.update_help();});var d=new Date();dojo.byId("js_time_cell").innerHTML=d.strftime("%m/%D/%y %H:%M:%S GMT%Z");function _6(){var _7=!dijit.byId("network_access_proxy").checked;dojo.forEach(["proxy_address","proxy_port","proxy_username","proxy_password"],function(_8){dijit.byId(_8).setDisabled(_7);});};dojo.connect(dijit.byId("network_access_proxy"),"onClick",_6);dojo.connect(dijit.byId("network_access_direct"),"onClick",_6);_6();};_2.set_document_title=function(){var id=_1.main.current_tabs["settings"];var _a=dijit.byId(id);var _b=_a.title.replace(/<.*?>/g,"");nox.ext.apps.vmanui.main.set_document_subtitle(_b);};_2.refresh_settings_section=function(){dijit.byId("settings").refresh();var h=dojo.connect(dijit.byId("settings"),"onDownloadEnd",function(){_1.main.make_current_viewable();dojo.disconnect(h);});};_2.show_any_message_dialog=function(_d,_e,_f){if(_2.show_any_message_dialog.onclick_handle){dojo.disconnect(_2.show_any_message_dialog.onclick_handle);_2.show_any_message_dialog.onclick_handle=null;}if(_e){_2.show_any_message_dialog.onclick_handle=dojo.connect(dijit.byId("any_message_close_btn"),"onClick",_e);dojo.style(dijit.byId("any_message_close_btn").domNode,"display","");}else{dojo.style(dijit.byId("any_message_close_btn").domNode,"display","none");}dojo.byId("any_message_text").innerHTML=_d;var _10=_f?_f:"";dijit.byId("any_message_dialog").attr("title",_10);dijit.byId("any_message_dialog").show();};_2.hide_any_message_dialog=function(){dijit.byId("any_message_dialog").hide();};_2.show_change_cred_dialog=function(_11){dijit.byId("change_cred_name").setValue(_11);dijit.byId("change_cred_dialog").show();};_2.show_change_privileges_dialog=function(_12){nox.ext.apps.vmanui.xhrGet({url:"/ws.v1/adminuser/"+encodeURIComponent(_12),timeout:30000,handleAs:"json",error:function(r){_1.main.vmanui_error(r);},load:function(r){if(r){dijit.byId("change_privileges_name").setValue(_12);dijit.byId("change_priv").setValue(r.priv);dijit.byId("change_privileges_dialog").show();}else{throw Error("Couldn't find account '"+_12+"' to modify");}}});};_2.show_add_user_dialog=function(){dijit.byId("add_user_dialog").show();};_2.show_add_ntp_dialog=function(){dijit.byId("add_ntp_dialog").show();};_2.show_add_snapshot_dialog=function(){dijit.byId("add_snapshot_dialog").show();};_2.show_delete_snapshot_dialog=function(_15){var _16=_2.get_snapshot(_15);var _17=dojo.byId("delete_snapshot_desc");var _18=dijit.byId("delete_snapshot_id");var _19="(no description)";if(_16){_19=_3.escapeMarkup(_16.description)||_19;}_18.attr("value",_15);_17.innerHTML=_3.cond_ellipsis(_19);dijit.byId("delete_snapshot_dialog").show();};_2.show_upload_snapshot_dialog=function(){dijit.byId("upload_snapshot_dialog").show();};_2.on_password_change=function(_1a,_1b,_1c,_1d){var _1e=dijit.byId(_1a);var _1f=dijit.byId(_1b);var _20=_1e.attr("value");var _21=_1f.attr("value");var _22=_1e.isValid()&&_1f.isValid()&&_20==_21;if(_22&&_1c){_22=dijit.byId(_1c).isValid();}var _23=dijit.byId(_1d);_23.setAttribute("disabled",!_22);};_2.verify_password=function(_24,_25){if(_24!=_25){return "Passwords don't match";}else{if(!_24.length){return "Password cannot be empty string";}}if(_24.length>_2.MAX_NAME_LENGTH){return "Passwords must contain "+_2.MAX_NAME_LENGTH+" or fewer characters";}return "";};_2.verify_username=function(_26){if(_26==""){return "Empty user names not allowed";}if(/\s/.test(_26)){return "User names cannot contain whitespace";}if(_26.length>_2.MAX_NAME_LENGTH){return "User names must contain "+_2.MAX_NAME_LENGTH+" or fewer characters";}return "";};_2.submit_add_user=function(){var _27=dijit.byId("new_user");var _28=dijit.byId("priv");var _29=dijit.byId("new_user_cred1");var _2a=dijit.byId("new_user_cred2");var _2b=dijit.byId("csrf_token_s");if(!(_27.isValid()&&_28.isValid()&&_29.isValid()&&_2a.isValid())){return;}dijit.byId("add_user_dialog").hide();var _2c=nox.ext.apps.vmanui.util.escapeMarkup(_27.attr("value"));var _2d=_28.attr("value");var _2e=_29.attr("value");var _2f=_2a.attr("value");var _30=_2b.attr("value");var _31=_2.verify_password(_2e,_2f);var _32=_2.verify_username(_2c);if(_32){_2.cancel_user_add();_1.main.vmanui_error(_32);return;}if(_31){_2.cancel_user_add();_1.main.vmanui_error(_31);return;}nox.ext.apps.vmanui.rawXhrPost({url:"ws.v1/adminuser",headers:{"content-type":"application/json","X-CSRF-Token":_30},timeout:30000,postData:dojo.toJson({"name":_2c,"priv":_2d,"cred":_2e,"csrf_token":_30}),load:function(_33,_34){_2.refresh_settings_section();},error:function(_35,_36){_2.cancel_user_add();_1.main.vmanui_error("Failed to add user '"+_2c+"'");}});};_2.submit_change_cred=function(){var _37=dijit.byId("new_cred").getValue();var _38=dijit.byId("confirm_cred").getValue();var _39=dijit.byId("change_cred_name").getValue();var _3a=dijit.byId("csrf_token_s").getValue();_2.cancel_change_cred();var _3b=_2.verify_password(_37,_38);if(_3b){_1.main.vmanui_error("Invalid Password: "+_3b);return;}nox.ext.apps.vmanui.rawXhrPut({url:"ws.v1/adminuser/"+encodeURIComponent(_39)+"/password",timeout:30000,headers:{"content-type":"application/json","X-CSRF-Token":_3a},putData:dojo.toJson({"cred":_37,"csrf_token":_3a}),load:function(_3c,_3d){},error:function(_3e,_3f){_1.main.vmanui_error("Failed to change password for: '"+_39+"'");}});};_2.submit_change_privileges=function(){var _40=dijit.byId("change_privileges_name").getValue();var _41=dijit.byId("change_priv").getValue();var _42=dijit.byId("csrf_token_s").getValue();_2.cancel_change_privileges();nox.ext.apps.vmanui.rawXhrPut({url:"ws.v1/adminuser/"+encodeURIComponent(_40),timeout:30000,handleAs:"json",headers:{"content-type":"application/json","X-CSRF-Token":_42},putData:dojo.toJson({"priv":_41,"csrf_token":_42}),load:function(_43,_44){var _45=_40;_45=_45.replace(/'/,"&apos;");_45=_45.replace(/"/,"&quot;");var _46=dojo.query("tr[title=\""+_40+"\"] td.account_privileges")[0];if(_46){dojo.fadeOut({node:_46,duration:1000,onEnd:function(){_46.innerHTML=_43;dojo.fadeIn({node:_46,duration:1000}).play();}}).play();}},error:function(_47,_48){_1.main.vmanui_error("Failed to change privileges for: '"+_40+"'");}});};_2.modify_ntp_servers=function(_49,_4a){var _4b=dijit.byId("csrf_token_s").getValue();nox.ext.apps.vmanui.rawXhrPut({url:"ws.v1/ntp_daemon/"+_4a+"_server",timeout:30000,headers:{"content-type":"application/json","X-CSRF-Token":_4b},putData:dojo.toJson({"server":_49,"csrf_token":_4b}),load:function(_4c,_4d){_2.refresh_settings_section();},error:function(_4e,_4f){_1.main.vmanui_error("Failed to "+_4a+" NTP server '"+_49+"'");}});};_2.restart_ntp=function(){var _50=dijit.byId("csrf_token_s").getValue();nox.ext.apps.vmanui.rawXhrPut({url:"ws.v1/ntp_daemon/restart",headers:{"content-type":"application/json","X-CSRF-Token":_50},timeout:30000,putData:dojo.toJson({"csrf_token":_50}),load:function(_51,_52){setTimeout(function(){_2.refresh_settings_section();},3000);},error:function(_53,_54){_1.main.vmanui_error("Failed to restart NTP daemon");}});};_2.force_sync_ntp=function(){var _55=dijit.byId("csrf_token_s").getValue();nox.ext.apps.vmanui.rawXhrPost({url:"ws.v1/ntp_daemon/stop",headers:{"content-type":"application/json","X-CSRF-Token":_55},timeout:30000,putData:dojo.toJson({"csrf_token":_55}),load:function(_56,_57){setTimeout(function(){_2.refresh_settings_section();},3000);},error:function(_58,_59){_1.main.vmanui_error("Failed to restart NTP daemon");}});};_2.submit_add_ntp=function(){var _5a=dijit.byId("ntp_server").getValue();_2.cancel_ntp_add();_2.modify_ntp_servers(_5a,"add");};_2.submit_add_snapshot=function(){var _5b=dijit.byId("snapshot_desc").getValue();var _5c=dijit.byId("csrf_token_s").getValue();_2.cancel_snapshot_add();nox.ext.apps.vmanui.rawXhrPost({url:"ws.v1/nox/snapshot",timeout:30000,headers:{"content-type":"application/json","X-CSRF-Token":_5c},postData:dojo.toJson({"desc":_5b,"csrf_token":_5c}),load:function(_5d,_5e){_2.refresh_settings_section();},error:function(_5f,_60){_1.main.vmanui_error("Failed to create snapshot");}});};_2.submit_delete_snapshot=function(){var _61=dijit.byId("delete_snapshot_id");var id=encodeURIComponent(_61.attr("value"));var _63=dijit.byId("csrf_token_s").getValue();_2.cancel_snapshot_delete();nox.ext.apps.vmanui.xhrDelete({url:"/ws.v1/nox/snapshot/"+id,timeout:30000,headers:{"content-type":"application/json","X-CSRF-Token":_63},handleAs:"json",load:function(){setTimeout(_2.refresh_settings_section,500);},error:function(r){_1.main.vmanui_error("Error deleting snapshot: "+r);}});};_2.cancel_change_cred=function(){dijit.byId("new_cred").setValue("");dijit.byId("confirm_cred").setValue("");dijit.byId("change_cred_name").setValue("");dijit.byId("change_cred_dialog").hide();};_2.cancel_change_privileges=function(){dijit.byId("change_privileges_name").setValue("");dijit.byId("change_privileges_dialog").hide();};_2.cancel_user_add=function(){dijit.byId("new_user").reset();dijit.byId("new_user_cred1").reset();dijit.byId("new_user_cred2").reset();dijit.byId("priv").setValue("Admin");dijit.byId("add_user_dialog").hide();};_2.cancel_ntp_add=function(){dijit.byId("ntp_server").setValue("");dijit.byId("add_ntp_dialog").hide();};_2.cancel_snapshot_add=function(){dijit.byId("snapshot_desc").setValue("");dijit.byId("add_snapshot_dialog").hide();};_2.cancel_snapshot_delete=function(){dijit.byId("delete_snapshot_dialog").hide();};_2.cancel_snapshot_upload=function(){dijit.byId("upload_snapshot_dialog").hide();};_2.remove_user=function(_65){var _66=dijit.byId("csrf_token_s").getValue();nox.ext.apps.vmanui.xhr("DELETE",{url:"ws.v1/adminuser/"+encodeURIComponent(_65),timeout:30000,headers:{"content-type":"application/json","X-CSRF-Token":_66},load:function(_67,_68){_2.refresh_settings_section();},error:function(_69,_6a){_1.main.vmanui_error("Failed to remove user : '"+_65+"'");}});};_2.remove_ntp=function(_6b){_2.modify_ntp_servers(_6b,"remove");};_2.cancel_download_snapshot=function(id){dijit.byId("download_snapshot_dialog").hide();};_2.get_snapshot=function(id){var sId=encodeURIComponent(id);var _6f=null;dojo.xhrGet({url:"/ws.v1/nox/snapshot/"+sId,sync:true,handleAs:"json",load:function(r){_6f=r;}});return _6f;};_2.download_snapshot=function(id){var _72=_2.get_snapshot(id);var _73=_72?_3.escapeMarkup(_72.description):"unknown";if(!_73){_73="(no description)";}var sId=encodeURIComponent(id);var _75=dijit.byId("download_snapshot_dialog");dojo.query("a#download_snapshot_link",_75.domNode).forEach(function(_76){_76.href="/ws.v1/nox/snapshot/"+sId+"/export";setTimeout(function(){_76.blur();},500);});dojo.query("span#download_snapshot_description",_75.domNode).forEach(function(_77){_77.innerHTML=_3.cond_ellipsis(_73);});_75.show();};_2.show_restore_snapshot_dialog=function(id){dijit.byId("snapshot_id").setValue(id);dijit.byId("restore_snapshot_dialog").show();};_2.cancel_restore_snapshot=function(){dijit.byId("restore_snapshot_dialog").hide();dijit.byId("snapshot_id").setValue("");};_2.submit_restore_snapshot=function(){_1.main.disable_connection_testing();dijit.byId("restore_snapshot_dialog").hide();dijit.byId("restore_snapshot_progress").show();var id=dijit.byId("snapshot_id").getValue();var _7a=dijit.byId("csrf_token_s").getValue();nox.ext.apps.vmanui.rawXhrPut({url:"ws.v1/nox/snapshot/"+encodeURIComponent(id),headers:{"content-type":"application/json","X-CSRF-Token":_7a},postData:dojo.toJson({"csrf-token":_7a}),timeout:30000,load:function(_7b,_7c){_2.cancel_restore_snapshot();dijit.byId("restore_snapshot_progress").show();var _7d=function(){dijit.byId("restore_snapshot_progress").hide();_1.main.vmanui_error(_1.main.app_name_short+" failed to restart after snapshot restore",_1.main.reenable_connection_testing);};_2.restart_poll(60,500,false,_7d);},error:function(_7e,_7f){dijit.byId("restore_snapshot_progress").hide();_1.main.vmanui_error("Failed to restore to snapshot",_1.main.reenable_connection_testing);}});};_2.dump_poll_handle_response=function(_80){if(_2.dump_canceled){return;}var _81="Log Collection Failed";var msg="An error occurred and the downloadable file couldn't be prepared.";if(_80=="complete"){var _81="Log Collection Complete";msg="Process complete!  Download the archive by clicking <a href=\"/ws.v1/nox/dump/dump.tar.gz\">here</a>";}else{if(_80=="dumping"){var _81="Collecting Logs";msg="Preparing a file to be downloaded. Please wait a moment since this may take several minutes.";setTimeout(_2.dump_poll_request,1000);}}_2.show_any_message_dialog(msg,function(){_2.hide_any_message_dialog();_2.dump_canceled=true;},_81);};_2.dump_poll_request=function(){nox.ext.apps.vmanui.xhrGet({url:"/ws.v1/nox/dump/status",load:_2.dump_poll_handle_response,timeout:30000,handleAs:"json",preventCache:true,error:function(_83){_2.dump_poll_handle_response("error");}});};_2.dump_initiate=function(){var _84=dijit.byId("csrf_token_s").getValue();_2.dump_canceled=false;_2.dump_initiate.deferred=nox.ext.apps.vmanui.rawXhrPut({url:"/ws.v1/nox/dump/status",headers:{"content-type":"application/json","X-CSRF-Token":_84},putData:dojo.toJson("initiate"),handleAs:"json",timeout:1000000,load:function(_85){_2.dump_poll_handle_response(_85);},error:function(_86){_2.dump_poll_handle_response("error");}});};_2.restart_vnetmanager=function(){_1.main.disable_connection_testing();var _87=dijit.byId("csrf_token_s").getValue();nox.ext.apps.vmanui.rawXhrPut({url:"/ws.v1/nox/local_config/shutdown",headers:{"content-type":"application/json","X-CSRF-Token":_87},putData:dojo.toJson("process"),timeout:30000,handleAs:"json",load:dojo.hitch(this,function(_88){_2.show_any_message_dialog("Please wait while the "+_1.main.app_name_short+" UI restarts.",null,"Restarting "+_1.main.app_name_short);setTimeout(function(){_2.restart_poll(15,500,false,null);},2000);}),error:function(){vmanui_error("Failure while requesting a "+_1.main.app_name_short+" restart.");}});};_2.restart_poll=function(_89,_8a,_8b,_8c){if(_89===0){_2.hide_any_message_dialog();if(_8c){_8c();}else{_1.main.vmanui_error("Unable to restart "+_1.main.app_name_short,function(){window.location.reload();});}if(!_8b){_1.main.reenable_connection_testing();}return;}dojo.xhrGet({url:"/ws.v1/nox/up",timeout:3000,preventCache:true,load:function(_8d){if(_8b){_2.hide_any_message_dialog();window.location.reload();}else{setTimeout(function(){_2.restart_poll(_89-1,_8a,false,_8c);},_8a);}},error:function(_8e){if(_8e.status==401){_2.hide_any_message_dialog();window.location="/login?last_page=/";}else{setTimeout(function(){_2.restart_poll(_89-1,_8a,true,_8c);},_8a);}}});};_2._build_ssl_form=function(_8f){var _90=document.createElement("form");_90.setAttribute("id",_8f+"_form");_90.setAttribute("method","post");_90.setAttribute("enctype","multipart/form-data");var _91=document.createElement("input");_91.setAttribute("type","file");_91.setAttribute("name",_8f);_90.appendChild(_91);return _90;};_2.submit_update_cert=function(_92){var _93;var _94=true;if(_92=="ovs"){_93="ovscert_form";var _95=dojo.byId(_93);var _96=_95.ssl_certificate.value;var _97=_95.ssl_privatekey.value;var _98=_95.ssl_ca_certificate.value;if(_96.length==0||_97.length==0||_98.length==0){_1.main.vmanui_error("Please specify a certificate file, a private key file and a CA certificate file.");_94=false;}}else{_93="httpscert_form";var _95=dojo.byId(_93);var _96=_95.ssl_certificate.value;var _97=_95.ssl_privatekey.value;if(_96.length===0||_97.length===0){_1.main.vmanui_error("Please specify both a certificate and private key file.");_94=false;}}if(!_94){return;}var _99=function(){_2.cancel_update_cert(_92);var _9a=_92.toUpperCase();_1.main.vmanui_error("Error updating "+_9a+" certificate/key file",function(){_2.cancel_update_cert(_92);});};var url,_9c;if(_92=="ovs"){url="/ws.v1/ovscert";}else{url="/ws.v1/httpscert";}var _9d=dijit.byId("csrf_token_s").getValue();url=url+"?csrf_token="+_9d;dojo.io.iframe.send({url:url,method:"post",handleAs:"html",form:_95,load:function(_9e,_9f){_2.cancel_update_cert(_92);if(_92=="https"){dijit.byId("view_https_cert_dialog_contentpane").refresh();title="Restart Required";msg="Please restart your browser to access the "+_1.main.app_name_short+" UI using the the new certificate.";if(_9e.body.innerHTML.search("success")==-1){title="Update Failed";msg="Unable to update the HTTPS certificate.";}_2.show_any_message_dialog(msg,function(){_2.hide_any_message_dialog();},title);}else{dijit.byId("view_ovs_cert_dialog_contentpane").refresh();title="Restart Required";msg="OVS certificate and key have been updated, "+"please restart the "+_1.main.app_name_short+".";if(_9e.body.innerHTML.search("success")==-1){title="Update Failed";msg="Unable to update the OVS certificate.";}_2.show_any_message_dialog(msg,function(){_2.hide_any_message_dialog();},title);}return _9e;},error:function(_a0,_a1){_99();return _a0;}});};_2.cancel_update_cert=function(_a2){if(_a2=="ovs"){dijit.byId("update_ovs_cert_dialog").hide();dojo.byId("ovscert_form").ssl_certificate.value="";dojo.byId("ovscert_form").ssl_privatekey.value="";dojo.byId("ovscert_form").ssl_ca_certificate.value="";}else{dijit.byId("update_cert_dialog").hide();dojo.byId("httpscert_form").ssl_certificate.value="";dojo.byId("httpscert_form").ssl_privatekey.value="";}};_2.show_add_syslog_dialog=function(){dijit.byId("syslog_server").setValue("");dijit.byId("syslog_add_dialog").show();};_2.submit_add_syslog=function(){var _a3=dijit.byId("syslog_server").getValue();var _a4=dijit.byId("syslog_str").getValue();if(_a4.length===0){_2.update_syslog_settings(_a3);}else{var _a5=_2.is_syslog_string_unique(_a3,_a4);if(_a5){var _a6=_a3+","+_a4;_2.update_syslog_settings(_a6);}else{_1.main.vmanui_error("\""+_a3+"\" is already configured for syslog.");}}};_2.is_syslog_string_unique=function(_a7,_a8){var _a9=_a8.split(",");if(dojo.indexOf(_a9,_a7)==-1){return true;}return false;};_2.remove_syslog=function(_aa){var _ab=dijit.byId("syslog_str").getValue().split(",");var _ac=dojo.filter(_ab,function(_ad){return _ad.length>0&&_ad!=_aa;});_2.update_syslog_settings(_ac.join(","));};_2.update_syslog_settings=function(_ae){var _af=dijit.byId("csrf_token_s").getValue();var _b0={"destination.1.name":"Syslog","destination.1.type":"Syslog","destination.1.facility":"LOCAL7","destination.1.priority":"INFO","destination.1.host":_ae,"rule.1.destination":"Syslog","csrf_token":_af};nox.ext.apps.vmanui.rawXhrPut({url:"/ws.v1/config/notifier_config",headers:{"content-type":"application/json","X-CSRF-Token":_af},putData:dojo.toJson(_b0),timeout:1000000,load:dojo.hitch(this,function(){_2.refresh_settings_section();}),error:function(_b1){_1.main.vmanui_error("Unable to update Syslog settings.");}});};_2.show_update_settings_dialog=function(){dijit.byId("update_settings_dialog").show();};_2.submit_update_settings=function(){var _b2=dijit.byId("csrf_token_s").getValue();var _b3={"csrf_token":_b2};_b3["network-access"]=dijit.byId("network_access_proxy").checked?"proxy":"direct";_b3["auto-update"]=dijit.byId("auto_update").checked?1:0;dojo.forEach(["proxy_address","proxy_port","proxy_username","proxy_password"],function(_b4){_b3[_b4]=dijit.byId(_b4).getValue();});nox.ext.apps.vmanui.rawXhrPut({url:"/ws.v1/nox/update_settings",headers:{"content-type":"application/json","X-CSRF-Token":_b2},timeout:1000000,putData:dojo.toJson(_b3),load:dojo.hitch(this,function(){_2.refresh_settings_section();}),error:function(_b5){_1.main.vmanui_error("Unable to modify update settings.");}});};_2.check_for_updates=function(){var d=nox.ext.apps.vmanui.xhrGet({url:"/ws.v1/nox/check_for_updates",timeout:15000,preventCache:true,load:function(_b7){_2.refresh_settings_section();},error:function(_b8){_2.show_any_message_dialog("Error while checking updates.",function(){_2.hide_any_message_dialog();},"Update Error");}});_2.show_any_message_dialog("Checking for updates...",function(){_2.hide_any_message_dialog();d.cancel();},"Updates");};_2.cancel_update_from_file=function(){dojo.byId("update_file_form").update_file.value="";dijit.byId("update_from_file_dialog").hide();};_2.redirect_to_emergency_webserver=function(){window.location="http://"+window.location.hostname;};_2.update_timeout_sec=20;_2.submit_upload_snapshot=function(){var _b9=dojo.byId("upload_snapshot_file").value;var _ba=dijit.byId("csrf_token_s").getValue();if(!_b9){_1.main.vmanui_error("Please specify a file to upload");return;}var d=dojo.io.iframe.send({url:"/ws.v1/nox/snapshot?csrf_token="+_ba,method:"POST",handleAs:"json",timeout:15000,form:"upload_snapshot_form",contentType:"multipart/form-data",handle:function(r,_bd){if(r.error){_1.main.vmanui_error(r.message);}else{_2.refresh_settings_section();}return r;}});_2.cancel_snapshot_upload();};_2.submit_update_from_file=function(){var _be=dojo.byId("update_file_form").update_file.value;if(_be.length===0){_1.main.vmanui_error("Please specify a file to upload");return;}dijit.byId("upload_sw_dialog").show();var _bf=dijit.byId("csrf_token_s").getValue();dojo.io.iframe.send({url:"/ws.v1/nox/update_from_file?csrf_token="+_bf,method:"post",handleAs:"html",form:"update_file_form",contentType:"multipart/form-data",load:function(_c0,_c1){dijit.byId("upload_sw_dialog").hide();_1.main.disable_connection_testing();_2.show_any_message_dialog("Please wait while "+_1.main.app_name_short+" is upgraded and restarted.",null,"Upload Succeeded");var cb=dojo.hitch(dojo.global,_2.restart_poll,_2.update_timeout_sec,1000,false,_2.redirect_to_emergency_webserver);setTimeout(cb,2000);return _c0;},error:function(_c3,_c4){dijit.byId("upload_sw_dialog").hide();_1.main.vmanui_error("Error uploading update package.");}});_2.cancel_update_from_file();};_2.submit_update_from_network=function(){var _c5=dijit.byId("update_version").getValue();dijit.byId("confirm_update_from_network_dialog").hide();var _c6=dijit.byId("csrf_token_s").getValue();nox.ext.apps.vmanui.rawXhrPut({url:"/ws.v1/nox/update_from_net",headers:{"content-type":"application/json","X-CSRF-Token":_c6},putData:dojo.toJson(_c5),handleAs:"json",timeout:1000000,load:function(_c7){_2.download_poll_handle_response(_c7);},error:function(_c8){_2.download_poll_handle_response("error");}});};_2.download_poll_handle_response=function(_c9){var _ca="Update Error";var msg="An error occurred while downloading the update";var _cc=function(){_2.hide_any_message_dialog();};if(_c9=="downloading"){_ca="Downloading Update";msg="Downloading update file...";setTimeout(_2.download_poll_request,1000);_cc=null;}else{if(_c9=="complete"){_ca="Download Complete";msg="Please wait while "+_1.main.app_name_short+" is upgraded and restarted.";var cb=dojo.hitch(dojo.global,_2.restart_poll,_2.update_timeout_sec,1000,false,_2.redirect_to_emergency_webserver);setTimeout(cb,2000);_cc=null;}}_2.show_any_message_dialog(msg,_cc,_ca);};_2.download_poll_request=function(){nox.ext.apps.vmanui.xhrGet({url:"/ws.v1/nox/update_from_net",preventCache:true,timeout:30000,handleAs:"json",load:_2.download_poll_handle_response,error:function(_ce){_2.download_poll_handle_response("error");}});};_2.controller_iface_name="eth0";_2.get_controller_interface_obj=function(){return nox.ext.apps.vmanui.xhrGet({url:"/ws.v1/nox/local_config/interface/configured",preventCache:true,handleAs:"json"});};_2.save_controller_interface_obj=function(_cf){var _d0=dijit.byId("csrf_token_s").getValue();nox.ext.apps.vmanui.rawXhrPut({url:"/ws.v1/nox/local_config/interface/configured/"+_2.controller_iface_name,headers:{"content-type":"application/json","X-CSRF-Token":_d0},timeout:3000,putData:dojo.toJson(_cf),load:function(_d1){var _d2=window.location.hostname;if(_d2!="localhost"&&_d2!="127.0.0.1"){_2.show_any_message_dialog("Please use the browser's URL bar to navigate to the new "+_1.main.app_name_short+" URL",null,"Configuration Updated");}else{_2.show_any_message_dialog("Please wait while the interface is reconfigured",null,"Updating Configuration");setTimeout(function(){_1.main.refresh_current(false,false);_2.hide_any_message_dialog();},5000);}},error:function(err){_1.main.vmanui_error("Failed to save interface settings.");}});};_2.save_controller_hostname=function(_d4,_d5){var _d6=dijit.byId("csrf_token_s").getValue();var d=nox.ext.apps.vmanui.rawXhrPut({url:"/ws.v1/nox/local_config/hostname",headers:{"content-type":"application/json","X-CSRF-Token":_d6},timeout:30000,putData:dojo.toJson({"hostname":_d4,"domain":_d5,"csrf_token":_d6})});d.addCallback(function(){nox.ext.apps.vmanui.main.refresh_current(false,false);});};_2.get_controller_hostname=function(){var dh=nox.ext.apps.vmanui.xhrGet({url:"/ws.v1/nox/local_config/hostname",handleAs:"json",preventCache:true});var dd=nox.ext.apps.vmanui.xhrGet({url:"/ws.v1/nox/local_config/domain",handleAs:"json",preventCache:true});return new dojo.DeferredList([dh,dd]);};_2.show_controller_hostname_edit_dialog=function(){var d=_2.get_controller_hostname();d.addCallback(function(r){var _dc=new nox.ext.apps.vmanui.dialog.controller_hostname_edit({hostname:r[0][1],domain:r[1][1]});dojo.connect(_dc,"onSave",_2.save_controller_hostname);_dc.show();});};_2.show_controller_interface_edit_dialog=function(){var d=_2.get_controller_interface_obj();d.addCallback(function(_de){var _df=null;dojo.forEach(_de,function(_e0){if(_e0.name!=_2.controller_iface_name){return;}_df=new nox.ext.apps.vmanui.dialog.controller_addr_edit({addr_obj:_e0});dojo.connect(_df,"onSave",_2.save_controller_interface_obj);_df.show();});if(!_df){_1.main.vmanui_error("No configuration data found for interface '"+_2.controller_iface_name+"'.");}});d.addErrback(function(){_1.main.console_log("error fetching controller interface settings: ",arguments);_1.main.vmanui_error("Unable to load Controller interface settings.");});};})();dojo.declare("nox.ext.apps.vmanui.settingsMenus",null,{constructor:function(){this.settingsMenus={};this.menusFactory=nox.ext.apps.vmanui.menu_creator.creator;},createMenus:function(){this.createNTPServerMenus();this.createSnapshotLocalMenus();this.createAdminMenus();this.createSyslogMenus();},trackMenu:function(_e1,sId,_e3){if(this.settingsMenus[_e3]==undefined){this.settingsMenus[_e3]={};}var _e4=this.settingsMenus[_e3];if(_e4[sId]){this.destroyMenu(sId);}_e4[sId]=_e1;},destroyMenusOfType:function(_e5){var _e6=this.settingsMenus[_e5];if(_e6){for(var sId in _e6){this.destroyMenu(sId,_e5);}}},destroyMenu:function(sId,_e9){var _ea=this.settingsMenus[_e9];if(_ea&&_ea[sId]){_ea[sId].destroy();delete _ea[sId];}},getMenu:function(sId){for(var _ec in this.settingsMenus){var _ed=this.settingsMenus[_ec];if(_ed[sId]){return _ed[sId];}}},createMenu:function(_ee,_ef,_f0,_f1,_f2,_f3){if(_f3==undefined){_f3=[_f0];}var _f4=dojo.hitch(this,function(){this.destroyMenu(_ee);var _f5=this.menusFactory;var _f6=_f5[_f1].apply(_f5,_f3);dojo.removeClass(_f0,"settings_menu_button");if(_f6){this.trackMenu(_f6,_ee,_ef);dojo.addClass(_f0,"settings_menu_button");}return _f6;});if(_f2){dojo.removeClass(_f0,"settings_menu_button");dojo.addClass(_f0,"settings_menu_button");dojo.connect(_f0,"onclick",function(e){var _f8=_f4();_f8._openMyself(e);});}else{_f4();}},createMenuFromRow:function(_f9,_fa,_fb,_fc,_fd,_fe){var _ff=[];var _100=dojo.query(_fb,_f9)[0];var sId;if(dojo.isFunction(_fa)){sId=_fa.call(null,_f9);_ff=[_100,sId];}else{sId=_f9.id.replace(_fa,"");_ff=[_100,sId];}if(sId){this.createMenu(sId,_fc,_100,_fd,_fe,_ff);}},checkCapabilities:function(qCap){var _103=true,_104=[];if(qCap!=undefined&&qCap!=null){if(dojo.isString(qCap)){_104=[qCap];}else{if(dojo.isArray(qCap)){_104=qCap;}}}if(_104.length){dojo.forEach(_104,function(sCap){if(!nox.ext.apps.vmanui.User.hasCapability(sCap)){_103=false;}});}return _103;},createMenusFromRows:function(_106,_107,_108,_109,_10a,_10b,_10c){this.destroyMenusOfType(_106);if(this.checkCapabilities(_10b)){dojo.query(_107).forEach(function(oRow){this.createMenuFromRow(oRow,_108,_109,_106,_10a,_10c);},this);}},createNTPServerMenus:function(){this.createMenusFromRows("ntp_server_local",".SettingsNTP table#NTPServers tr.ntp_server_row","ntp_server_row_","td.menu div.menu","create_ntp_server_menu","edit-ntp-servers");},createSnapshotLocalMenus:function(){this.createMenusFromRows("snapshot_local",".SettingsSnapshots table#Snapshots tr.snapshot_row","snapshot_row_","td.menu div.menu","create_snapshot_menu",null,true);},createAdminMenus:function(){this.createMenusFromRows("admin_account_local",".SettingsAccounts table#Accounts tr.account_row",function(oRow){return oRow.title;},"td.menu div.menu","create_admin_account_menu");},createSyslogMenus:function(){this.createMenusFromRows("syslog_local",".SettingsSyslog table#Syslog tr.syslog_row","syslog_row_","td.menu div.menu","create_syslog_menu","edit-notifier-config");}});}