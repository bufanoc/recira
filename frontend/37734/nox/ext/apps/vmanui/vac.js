/* Copyright (c) 2008, 2009, 2010 Nicira, Inc. */

if(!dojo._hasResource["nox.ext.apps.vmanui.vac"]){dojo._hasResource["nox.ext.apps.vmanui.vac"]=true;dojo.provide("nox.ext.apps.vmanui.vac");(function(){var _1=nox.ext.apps.vmanui;var _2=nox.ext.apps.vmanui.vac;_2.on_vac_load=function(){_1.main.set_section_container_display("block");dijit.byId(_1.main.current_tabs["vac"]).refresh();dijit.byId("vacTabContainer").selectChild(dijit.byId(_1.main.current_tabs["vac"]));_2.load_nav_tree();_2.initialize_shared_dialogs();dojo.query(".dijitTabContent").forEach(function(_3){var _4=_3.onclick;_3.onclick=function(e){if(!_1.main.check_warn_on_nav()){dojo.stopEvent(e);}else{if(_4){_4(e);}}};});dojo.subscribe("vacTabContainer-selectChild",function(_6){_1.main.current_tabs["vac"]=_6.id;dojo.style(_6.id,{display:"block"});_1.main.update_history();_1.main.refresh_current(true,true);});dojo.connect(dijit.byId("visibility"),"onLoad",_2.__loadVisibility);dojo.connect(dijit.byId("policy"),"onLoad",_2.__loadPolicy);dojo.connect(dijit.byId("port"),"onLoad",_2.__loadPort);dojo.connect(dijit.byId("status"),"onLoad",_1.vac_status.status_init);dojo.connect(dijit.byId("status"),"onUnload",_1.vac_status.status_unload);_2.channel_disconnect=function(){if(_1.main.channel_is_disconnected){return;}_1.main.channel_is_disconnected=true;if(dijit.byId("tree")){dijit.byId("tree").destroy();_2.treemodel.destroy();}_2.clear_rest_index();_1.main.run_connectivity_test();var h=dojo.connect(_1.main,"onConnectSuccess",function(){_1.main.channel_is_disconnected=false;dojo.disconnect(h);_2.load_nav_tree();});};dojo.connect(dojox.cometd.RestChannels.defaultInstance,"disconnected",_2.channel_disconnect);};_2.__loadVisibility=function(){return _1.vac_visibility.visibility_init(false,true);};_2.__loadPort=function(){dojo.style(dojo.byId("port"),{display:"block"});};_2.__loadPolicy=function(){dojo.style(dojo.byId("policy"),{display:"block"});};_2.node_types={ALL_POOLS:1,POOL:2,NETWORKS:3,NETWORK:4,NETWORK_VM:5,NETWORK_VIF:6,SERVERS:7,SERVER:8,SERVER_NETWORKS:9,SERVER_NETWORK:10,SERVER_NETWORK_VM:11,SERVER_NETWORK_VIF:12,SERVER_VM:13,SERVER_VIF:14,VMS:15,VM:16,VM_VIF:17,ADMIN_NETWORKS:18,ADMIN_NET_GROUP:19,ADMIN_NET:20,ADMIN_GROUPS:21,ADMIN_GROUP:22,ADMIN_VM:23,ADMIN_VIF:24,ADMIN_CHILD_NET_GROUP:25,ADMIN_CHILD_NET:26,ADMIN_CHILD_GROUP:27,ADMIN_CHILD_VM:28,ADMIN_CHILD_VIF:29};var nt=_2.node_types;_2.parent_types={};var pt=_2.parent_types;pt[nt.ALL_POOLS]=null;pt[nt.POOL]=nt.ALL_POOLS;pt[nt.NETWORKS]=nt.POOL;pt[nt.NETWORK]=nt.NETWORKS;pt[nt.NETWORK_VM]=nt.NETWORK;pt[nt.NETWORK_VIF]=nt.NETWORK_VM;pt[nt.SERVERS]=nt.POOL;pt[nt.SERVER]=nt.SERVERS;pt[nt.SERVER_NETWORKS]=nt.SERVER;pt[nt.SERVER_NETWORK]=nt.SERVER_NETWORKS;pt[nt.SERVER_NETWORK_VM]=nt.SERVER_NETWORK;pt[nt.SERVER_NETWORK_VIF]=nt.SERVER_NETWORK_VM;pt[nt.SERVER_VM]=nt.SERVER;pt[nt.SERVER_VIF]=nt.SERVER_VM;pt[nt.VMS]=nt.POOL;pt[nt.VM]=nt.VMS;pt[nt.VM_VIF]=nt.VM;pt[nt.ADMIN_NETWORKS]=null;pt[nt.ADMIN_NET_GROUP]=nt.ADMIN_NETWORKS;pt[nt.ADMIN_NET]=nt.ADMIN_NET_GROUP;pt[nt.ADMIN_GROUPS]=null;pt[nt.ADMIN_GROUP]=nt.ADMIN_GROUPS;pt[nt.ADMIN_VM]=nt.ADMIN_GROUP;pt[nt.ADMIN_VIF]=nt.ADMIN_VM;pt[nt.ADMIN_CHILD_NET_GROUP]=nt.ADMIN_NET_GROUP;pt[nt.ADMIN_CHILD_NET]=nt.ADMIN_CHILD_NET_GROUP;pt[nt.ADMIN_CHILD_GROUP]=nt.ADMIN_GROUP;pt[nt.ADMIN_CHILD_VM]=nt.ADMIN_CHILD_GROUP;pt[nt.ADMIN_CHILD_VIF]=nt.ADMIN_CHILD_VM;_2.get_vac_path_for_item=function(_a,_b){var _c,_d;if(_b.node_type==_2.node_types.ADMIN_NET){_c=_2.treestore.getValue(_b,"group_uid");_d=_2.node_types.ADMIN_NET_GROUP;}else{if(_b.node_type==_2.node_types.SERVER_NETWORKS){_c=_2.treestore.getValue(_b,"server_uid");_d=_2.treestore.getValue(_b,"node_type");}else{_c=_2.treestore.getValue(_b,"uid");_d=_2.treestore.getValue(_b,"node_type");}}var _e=_2.treestore.getValue(_b,"pool_uid");var _f=_2.treestore.getValue(_b,"tree_uid");return "/vmanui/"+_a+"?&node_type="+_d+"&pool_uid="+_e+"&uid="+_c+"&tree_uid="+_f;};_2.clear_rest_index=function(){var ch=dojox.cometd.RestChannels.defaultInstance,s=ch.subscriptions,_12="/ws.v1/tree/node/",a=[],i;for(i in dojox.rpc.Rest._index){if(i.substring(0,_12.length)==_12){a.push(i);}}for(i in a){delete dojox.rpc.Rest._index[a[i]];delete s[a[i]];}};_2.__get_item_status=function(_15){if(_15.active==9){return "Alert";}else{if(_15.active){return (_15.managed)?"On":"Alert";}}return "Off";};_2.__get_item_pool_status=function(_16){if(_16.active===0){return (_16.managed)?"On":"Alert";}else{if(_16.active==9){return "Alert";}}return "Off";};_2.__getIconClass=function(_17){var t=_2.node_types;switch(_17.node_type){case t.ALL_POOLS:return "MultiplePoolsTreeIcon";case t.POOL:return "PoolTreeIcon"+_2.__get_item_pool_status(_17);case t.NETWORKS:case t.SERVER_NETWORKS:return "MultipleNetworksTreeIcon";case t.NETWORK:case t.SERVER_NETWORK:return "NetworkTreeIcon"+_2.__get_item_status(_17);case t.VMS:case t.ADMIN_GROUP:return "MultipleVMsTreeIcon";case t.VM:case t.NETWORK_VM:case t.SERVER_VM:case t.SERVER_NETWORK_VM:case t.ADMIN_VM:return "VMTreeIcon"+_2.__get_item_status(_17);case t.NETWORK_VIF:case t.SERVER_VIF:case t.VM_VIF:case t.ADMIN_VIF:case t.SERVER_NETWORK_VIF:return "VIFTreeIcon"+_2.__get_item_status(_17);case t.SERVERS:return "MultiplePhysicalServersTreeIcon";case t.SERVER:return "PhysicalServerTreeIcon"+_2.__get_item_status(_17);case t.ADMIN_NETWORKS:return "MultipleNetworkGroupsTreeIcon";case t.ADMIN_NET_GROUP:return "NetworkGroupTreeIcon";case t.ADMIN_NET:return "NetworkMemberTreeIcon";case t.ADMIN_GROUPS:return "MultipleHostGroupsTreeIcon";default:return "";}};_2.__doubleClickTreeDomNode=function(evt){var _1a=dijit.getEnclosingWidget(evt.target);if(_1a&&_1a.isExpandable){if(_1a.isExpanded){_2.tree._collapseNode(_1a);}else{_2.tree._expandNode(_1a);}}};_2.__clickTreeNode=function(_1b,_1c,_1d){if(!_1d&&!_1.main.check_warn_on_nav()){return;}dojo.query(".currentTreeNode").removeClass("currentTreeNode");dojo.addClass(_1c.rowNode,"currentTreeNode");_1.main.current_tree_item=_1b;_2.select_current_item();var _1e=_1d?function(){_2.tree.focusNode(_1c);}:null;_1.main.refresh_current(true,!_1d,_1e,10);};_2.get_all_pool_nodes=function(_1f){if(!_1f){return [];}var _20=function(_21){var _22=_21.children;var _23=[];dojo.forEach(_22,function(kid){var uid=kid["$ref"];_23.push(_1.xhrGet({url:"/ws.v1/tree/node/"+uid,preventCache:true,timeout:30000,handleAs:"json"}));});var dl=new dojo.DeferredList(_23);dl.addCallback(_1f);};var _27=_1.xhrGet({url:"/ws.v1/tree/node/"+_2.node_types.ALL_POOLS,preventCache:true,timeout:30000,handleAs:"json",load:_20,error:function(_28){}});};_2.load_nav_tree=function(){var _29=dojo.byId("treewrapper");if(_29===null){return;}if(dijit.byId("tree")){dijit.byId("tree").destroy();_2.treemodel.destroy();}_2.clear_rest_index();var _2a=dijit.byId("searchBox").searchString.getValue();if(_2a.length>0){if(_2a.indexOf("*")===-1&&_2a.indexOf("?")===-1){_2a="*"+_2a+"*";}query={search:_2a};}else{query={};}var _2b={target:"/ws.v1/tree/node/",idAttribute:"tree_uid"};_2.treestore=new dojox.data.JsonRestStore(_2b);dojo.connect(_2.treestore,"onSet",function(_2c){try{if((_1.main.current_tabs["vac"]=="status")&&!_1.main.is_paused){_2.try_tree_update_refresh();}}catch(e){_1.main.console_log("error with tree auto refresh",e);}});var _2d={store:_2.treestore,rootId:"troot",childrenAttr:"children",labelAttr:"name",query:query,identifierAttr:"tree_uid"};_2.treemodel=new dijit.tree.ForestStoreModel(_2d);_2.treemodel._onNewItem=function(_2e,_2f){try{if(_2e!==null&&_2e.top!==undefined){this._requeryTop();}dijit.tree.TreeStoreModel.prototype._onNewItem.apply(this,arguments);}catch(e){_1.main.console_log("new tree item error",e);}};var _30={id:"tree",model:_2.treemodel,showRoot:false};_2.tree=new dijit.Tree(_30,document.createElement("div"));_2.tree.getIconClass=_2.__getIconClass;dojo.connect(_2.tree,"onClick",_2.__clickTreeNode);dojo.connect(_2.tree.domNode,"ondblclick",_2.__doubleClickTreeDomNode);dojo.place(_2.tree.domNode,_29,"only");var _31=_1.main.bookmark_tree_uid;var _32=_1.main.current_tree_item;if(_31!==undefined&&_31!==null){_2.expandTreeToNode(_31);_1.main.bookmark_tree_uid=null;}else{if(_32!==undefined&&_32!==null){_2.expandTreeToNode(_32.tree_uid);}else{_2.expandTreeToNode(""+_2.node_types.ALL_POOLS);}}var _33=dijit.byId("emptymenu");_33.bindDomNode(_2.tree.domNode);dojo.connect(_33,"_openMyself",_2.__openEmptyMenu);};_2.__openEmptyMenu=function(evt){var _35=dijit.getEnclosingWidget(evt.target).item;if(!_35){return;}var _36=null;var _37=null;switch(_35.node_type){case nt.ALL_POOLS:_36="all_pools_menu";_37="edit-datasource";break;case nt.POOL:if(_35.active==10){_36="pool_menu_no_refresh";}else{_36="pool_menu";}_37="edit-datasource";break;case nt.ADMIN_NETWORKS:_36="all_net_groups_menu";_37="edit-groups";break;case nt.ADMIN_NET_GROUP:_36="net_group_menu";_37="edit-groups";break;case nt.ADMIN_GROUPS:_36="all_host_groups_menu";_37="edit-groups";break;case nt.ADMIN_GROUP:_36="host_group_menu";_37="edit-groups";break;case nt.ADMIN_VM:_36="host_member_menu";_37="edit-groups";break;case nt.ADMIN_NET:_36="nwaddr_member_menu";_37="edit-groups";break;}if(_36===null){return;}if(nox.ext.apps.vmanui.User.hasCapability(_37)){var m=dijit.byId(_36);if(m){m.cur_item=_35;m._openMyself(evt);}}};_2.show_vac_tab=function(_39,_3a){if(_2.treestore){_2.expandTreeToNode(_3a);}else{_1.main.bookmark_tree_uid=_3a;}_1.main.current_tabs.vac=_39;_1.main.show_section("vac");_1.main.update_history();};_2._get_parent_tree_uid=function(_3b){var arr=_3b.split("_");pnode_type=_2.parent_types[arr[0]];if(pnode_type===null){return null;}arr[0]=pnode_type;arr.pop();return arr.join("_");};_2.expandTreeToNode=function(_3d){var _3e=_2.tree;if(!_3e){console.log("tree has value in expandTreeToNode()",_3e,arguments.callee.caller);}var _3f=_2.treemodel;var rn=_3e.rootNode;if(!rn.isExpandable){_1.main.console_log("Root node is not expandable!");return;}var _41=[_3d];var _42=_3d;while(true){_42=_2._get_parent_tree_uid(_42);if(_42===null){break;}_41.unshift(_42);}_41.unshift(_3f.getIdentity(rn.item));var _43=null;function _44(_45,_46){var _47=_3f.getIdentity(_45);if(_47!=_41[0]){return;}_41.shift();var _48=_3e._itemNodeMap[_41[0]];if(_48!==undefined){if(_41.length==1){dojo.disconnect(_43);_2.selectTreeNode(_48);return;}else{if(_48.isExpandable){_3e._expandNode(_48);return;}else{dojo.disconnect(_43);_2.selectTreeNode(_48);return;}}}_1.main.console_log("Parent loaded but child not: "+_47+" "+_41[0]);dojo.disconnect(_43);_2.selectTreeNode(_46);};_43=dojo.connect(_3e,"onOpen",_44);_3e._expandNode(rn);};_2.selectTreeNode=function(_49){var _4a=_2.tree;if(!_4a){console.log("tree has value in selectTreeNode()",_4a,arguments.callee.caller);}_4a.onClick(_49.item,_49,true);};dijit.tree.TreeStoreModel.prototype.mayHaveChildren=function(_4b){return dojo.some(this.childrenAttrs,function(_4c){return _4b[_4c]&&_4b[_4c].length;},this);};_2.select_current_item=function(){var id=_2.treestore.getValue(_1.main.current_tree_item,"tree_uid");_2.select_tree_node(id);};_2.select_tree_node=function(_4e){var _4f=_2.tree._itemNodeMap[_4e];if(_4f){_2.tree._onNodeFocus(_4f);}};_2.initialize_shared_dialogs=function(){_2._init_allgroup_dialog();};_2.clear_allgroup_dialog=function(){dijit.byId("addGroupDialogName").setValue("");dijit.byId("addGroupDialogDescription").setValue("");dijit.byId("addGroupDialogType").setValue("");dijit.byId("addGroupDialogUID").setValue("");};_2._init_allgroup_dialog=function(){dojo.connect(dijit.byId("addGroupDialogName"),"onKeyUp",function(){var _50=dijit.byId("addGroupDialogName").isValid();dijit.byId("add_group").attr("disabled",!_50);});dojo.connect(dijit.byId("add_group"),"onClick",function(){var _51=dijit.byId("addGroupDialogName");if(!_51.isValid()){return;}var _52=_51.getValue();var _53=dijit.byId("addGroupDialogDescription").getValue();var _54=dijit.byId("addGroupDialogType").getValue();var uid=dijit.byId("addGroupDialogUID").getValue();frag.status.groups.addGroupDialog.closeDialog();var _56=uid.length===0;var d=_56?_1.vac_status.create_empty_group(_54,_52,_53):_1.vac_status.modify_group_name(uid,_54,_52,_53);d.addCallback(function(_58){_2.clear_allgroup_dialog();if(_56){setTimeout(function(){var _59=(_54=="nwaddr")?nt.ADMIN_NET_GROUP:nt.ADMIN_GROUP;var _5a=_59+"_"+_58.uid;_1.vac.show_vac_tab("status",_5a);},1000);}else{_1.main.refresh_current(false);}});escaped_name=_1.util.escapeMarkup(_52);d.addErrback(function(){_2.clear_allgroup_dialog();_1.main.vmanui_error("Failed to add new group '"+escaped_name+"'");});});};_2.show_addgroup_dialog=function(_5b){dijit.byId("addGroupDialogType").setValue(_5b);frag.status.groups.addGroupDialog.openDialog();var _5c=(_5b=="host")?" VM ":"Address";frag.status.groups.addGroupDialog.attr("title","Create "+_5c+" Group");dijit.byId("add_group").attr("label","Create Group");};_2.show_modifygroup_dialog=function(uid,_5e){_1.vac_status.get_group(uid,_5e).addCallback(function(g){frag.status.groups.addGroupDialog.openDialog();var _60=(_5e=="host")?" VM ":"Address";frag.status.groups.addGroupDialog.attr("title","Modify "+_60+" Group");dijit.byId("addGroupDialogType").setValue(_5e);dijit.byId("addGroupDialogUID").setValue(uid);dijit.byId("addGroupDialogName").setValue(g.name);dijit.byId("addGroupDialogDescription").setValue(g.description);dijit.byId("add_group").attr("disabled",false);dijit.byId("add_group").attr("label","Modify Group");});};_2.last_tree_refresh_ms=0;_2.min_ms_between_tree_refresh=10000;_2.waiting_on_delayed_refresh=false;_2.do_status_refresh=function(){if((!_1.main.is_paused)&&_1.main.current_section=="vac"&&_1.main.current_tabs.vac=="status"){var _61=(new Date()).getTime();_1.main.refresh_current(false,false);_2.last_tree_refresh_ms=_61;}};_2.try_tree_update_refresh=function(){var _62=(new Date()).getTime();var _63=_62-_2.last_tree_refresh_ms;if(_63>_2.min_ms_between_tree_refresh){_2.do_status_refresh();}else{if(!_2.waiting_on_delayed_refresh){_2.waiting_on_delayed_refresh=true;setTimeout(function(){_2.do_status_refresh();_2.waiting_on_delayed_refresh=false;},_2.min_ms_between_tree_refresh-100);}}};})();}