/* Copyright (c) 2008, 2009, 2010 Nicira, Inc. */

if(!dojo._hasResource["nox.ext.apps.vmanui.vac_status"]){dojo._hasResource["nox.ext.apps.vmanui.vac_status"]=true;dojo.provide("nox.ext.apps.vmanui.vac_status");dojo.require("nox.ext.apps.vmanui.policy_manager");(function(){var _1=nox.ext.apps.vmanui;var _2=nox.ext.apps.vmanui.vac_status;_2.status_init=function(){nox.ext.apps.vmanui.main.set_document_subtitle("Status");dojo.style(dojo.byId("status"),{display:"block"});dojo.query("tr",this.domNode).forEach(function(_3,i){dojo.addClass(_3,i%2?"oddRow":"evenRow");});var t=_1.vac.node_types;var _6=_2._get_current_node_type();if(_6===null){return;}_2.dijits_to_destroy=[];_2.vlan_attempts=0;_2.vlan_attempt_pid=null;_2.vlan_pool_id=null;_2.vlan_request=null;clearTimeout(_2.vlan_attempt_pid);switch(_6){case t.ALL_POOLS:_2._init_allpools();break;case t.POOL:_2._init_pool();break;case t.ADMIN_NET_GROUP:_2._init_adminnetwork();break;case t.SERVER_NETWORK:case t.NETWORK:_2._init_network();break;case t.NETWORK_VIF:case t.SERVER_NETWORK_VIF:case t.SERVER_VIF:case t.VM_VIF:case t.ADMIN_VIF:dojo.query("tr","iface_stats").forEach(function(_7,i){dojo.removeClass(_7,"evenRow");dojo.removeClass(_7,"oddRow");});break;}};_2._get_current_node_type=function(){var _9=dijit.byId("status").attr("href");var _a=_9.split("&");for(var i=0;i<_a.length;i++){if(_a[i].indexOf("node_type=")!=-1){return parseInt(_a[i].split("=")[1],10);}}return null;};_2._init_allpools=function(){dojo.query(".acl-button",dojo.byId("status")).forEach(function(td){var _d=_1.menu_creator.creator.create_pool_modify_menu(td);_2.dijits_to_destroy.push(_d);});var _e="/ws.v1/xen_directory/vlan";_2._init_vlans(_e,null,null,"allpools_vlans");};_2._init_network=function(){var _f=_1.main.current_tree_item.uid;var _10=_1.main.current_tree_item.pool_uid;var _11=["/ws.v1","xen_directory",_10,"network",_f,"vlan"];var url=_11.join("/");_2._init_vlans(url,_10,_f,"network_instance_vlans");};_2._init_pool=function(){_2.init_fail_mode();if(dojo.query("body.cap-set-netflow-config").length===0){dijit.byId("vnet_netflow").attr("disabled",true);dijit.byId("other_netflow").attr("disabled",true);dijit.byId("other_netflow_text").attr("disabled",true);}else{dojo.forEach(["vnet_netflow","other_netflow"],function(id){dojo.connect(dijit.byId(id),"onChange",function(){_1.main.editStarted();var _14=dijit.byId("other_netflow");var _15=dijit.byId("other_netflow_text");var _16=true;if(_14.getValue()&&!_15.isValid()){_15.focus();_16=false;}dijit.byId("netflow_save_btn").attr("disabled",!_16);dijit.byId("netflow_reset_btn").attr("disabled",false);_15.attr("disabled",!_14.getValue());if(!_14.getValue()){_15.setValue("");}});});dojo.connect(dijit.byId("other_netflow_text"),"onKeyUp",function(){_1.main.editStarted();var _17=dijit.byId("other_netflow_text").isValid();dijit.byId("netflow_save_btn").attr("disabled",!_17);dijit.byId("netflow_reset_btn").attr("disabled",false);});dojo.connect(dijit.byId("netflow_save_btn"),"onClick",function(){var uid=dijit.byId("uid").getValue();var _19=dijit.byId("vnet_netflow").getValue();var _1a=dijit.byId("csrf_token_v").getValue();var _1b="";if(dijit.byId("other_netflow").getValue()){_1b=dijit.byId("other_netflow_text").getValue();}nox.ext.apps.vmanui.rawXhrPut({url:"ws.v1/netflow/"+encodeURIComponent(uid),headers:{"content-type":"application/json","X-CSRF-Token":_1a},putData:dojo.toJson({"use_vmanager":_19,"other_servers":_1b,"csrf_token":_1a}),load:function(_1c,_1d){dijit.byId("netflow_save_btn").attr("disabled",true);dijit.byId("netflow_reset_btn").attr("disabled",true);_1.main.editFinished();},error:function(_1e,_1f){_1.main.vmanui_error("Failed to save NetFlow changes.");},timeout:30000});});}_2.vlan_pool_id=_1.main.current_tree_item.datasource_id;var _20=_1.main.current_tree_item.uid;var url="/ws.v1/xen_directory/"+_20+"/vlan";_2._init_vlans(url,_20,null,"pool_instance_vlans");dojo.connect(dijit.byId("netflow_reset_btn"),"onClick",function(){_1.main.refresh_current();_1.main.editFinished();});};_2._init_vlans=function(url,_23,_24,_25){_2.vlan_request=nox.ext.apps.vmanui.xhrGet({url:url,preventCache:true,handleAs:"json",timeout:3000000,load:function(_26,_27){_2.vlan_attempts=0;clearTimeout(_2.vlan_attempt_pid);_2.create_vlan_editor(_26,_23,_24,_25);},error:function(_28,_29){if(_2.vlan_attempts<3){_2.vlan_attempt_pid=setTimeout(function(){_2._init_vlans(url,_23,_24,_25);},1000);}else{var msg="Failed to fetch vlans for pool "+_23+", network "+_24+": "+_28;_1.main.vmanui_error(msg);}_2.vlan_attempts++;}});};_2.create_vlan_editor=function(_2b,_2c,_2d,_2e){var _2f=new nox.ext.apps.vmanui.VlanListEditor({"pool_id":_2c,"network_id":_2d,"vlan_counts":_2b},_2e);_2.dijits_to_destroy.push(_2f);var _30=nox.ext.apps.vmanui.util.keys(_2b).sort(function(a,b){return a-b;});dojo.forEach(_30,function(_33){_2f.newItem(_33,true);});_2f.setBaseline();};_2._init_adminnetwork=function(){dojo.connect(dijit.byId("save_nwaddr_group"),"onClick",function(){var _34=dijit.byId("address_box").getValue().split(",");var _35=[];var re=new RegExp("^"+nox.ext.apps.vmanui.regex.ipv4_net_or_address+"$");for(var i=0;i<_34.length;i++){var s=dojo.trim(_34[i]);if(s.length===0){continue;}if(!re.test(s)){_1.main.vmanui_error("Invalid address/network: '"+s+"'");return;}_35.push({"address":s});}var uid=dijit.byId("group_uid").getValue();var d=nox.ext.apps.vmanui.vac_status.get_group(uid,"nwaddr");d.addCallback(function(_3b){_3b.members=_35;return nox.ext.apps.vmanui.vac_status.put_group(uid,"nwaddr",_3b);});d.addCallback(function(){nox.ext.apps.vmanui.main.refresh_current();nox.ext.apps.vmanui.main.editFinished();});});};_2.status_unload=function(){var t=_1.vac.node_types;var _3d=_2._get_current_node_type();if(_3d===null){return;}switch(_3d){}dojo.forEach(_2.dijits_to_destroy,function(d,i){if(d.destroyRecursive){d.destroyRecursive();d=null;}});_2.dijits_to_destroy=[];};_2.show_add_to_addr_group_dialog=function(_40){dijit.byId("add_net_member_dialog_group_uid").setValue(_40);dijit.byId("add_net_member_dialog").show();};_2.show_add_to_host_group_dialog=function(_41){var d=nox.ext.apps.vmanui.vac_status.prepare_host_group_add_store(_41);d.addCallback(function(fs){nox.ext.apps.vmanui.main.onDialogOpen();dijit.byId("add_member_dialog_group_uid").setValue(_41);dijit.byId("add_member_dialog").show();var h1=dojo.connect(dijit.byId("add_to_admin_group"),"onClick",function(){dojo.disconnect(h1);if(!fs.isValid()){return;}var uid=dijit.byId("add_member_dialog_group_uid").getValue();var _46=fs.getValue();dijit.byId("add_member_dialog").hide();_1.main.onDialogClose();var d=_1.vac_status.get_group(uid,"host");d.addCallback(function(_48){_48.members.push({"uid":_46});return _1.vac_status.put_group(uid,"host",_48);});d.addCallback(function(){setTimeout(function(){_1.main.refresh_current(false);},400);});});var h2=dojo.attach(dijit.byId("add_memeber_dialog"),"hide",function(){dojo.disconnect(h1);dojo.disconnect(h2);fs.destroyRecursive();});});};_2.prepare_host_group_add_store=function(uid){var _4b=new dojo.data.ItemFileWriteStore({url:"/ws.v1/xen_directory/vm?jsonstore=true",urlPreventCache:"true"});var fs=new dijit.form.FilteringSelect({store:_4b,searchAttr:"name",query:{show:true}});dijit.byId("add_to_admin_group").attr("disabled",true);dojo.connect(fs,"onChange",function(){dijit.byId("add_to_admin_group").attr("disabled",!fs.isValid());});dojo.connect(fs,"onKeyUp",function(){dijit.byId("add_to_admin_group").attr("disabled",!fs.isValid());});var d2=new dojo.Deferred();var d=nox.ext.apps.vmanui.vac_status.get_group(uid,"host");d.addCallback(function(_4f){_4b.fetch({query:{},onItem:function(_50){var _51=true;dojo.forEach(_4f.members,function(m){if(_4b.getValue(_50,"uid")==m.uid){_51=false;}});_4b.setValue(_50,"show",_51);},onComplete:function(){d2.callback(fs);}});});var _53=dojo.byId("vm_group_add_select");dojo.empty(_53);dojo.place(fs.domNode,_53);return d2;};_2.makeHostGroupRemoveLink=function(idx,_55){if(_55===null){return;}return ("<span class=\"capabilities-block cap-edit-groups\"><a href=\"javascript:frag.status.alladmingroups.removeConfirmDialog.openDialog('"+adminGroupDataStore.getValue(_55,"realName")+"',"+adminGroupDataStore.getValue(_55,"name")+")\">Remove</a></span>");};_2.remove_addr_member=function(_56){var _57=dijit.byId("group_uid").getValue();_2.remove_group_member("nwaddr",_57,_56);};_2.remove_host_member=function(_58){var _59=dijit.byId("group_uid").getValue();_2.remove_group_member("host",_59,_58);};_2.remove_group_member=function(_5a,_5b,_5c){var d=_2.get_group(_5b,_5a);d.addCallback(function(_5e){var _5f=[];for(var i=0;i<_5e.members.length;i++){if(_5c!=_5e.members[i].uid){_5f.push(_5e.members[i]);}}_5e.members=_5f;var d2=_2.put_group(_5b,_5a,_5e);d2.addCallback(function(){setTimeout(function(){nox.ext.apps.vmanui.main.refresh_current(false);},400);});});};_2.get_group=function(uid,_63){var url="/ws.v1/group/"+_63+"/"+encodeURIComponent(uid);return nox.ext.apps.vmanui.xhrGet({url:url,preventCache:true,handleAs:"json",timeout:3000000,error:function(_65,_66){_1.main.vmanui_error("Failed to fetch group");}});};_2.put_group=function(uid,_68,_69){var url="/ws.v1/group/"+_68+"/"+encodeURIComponent(uid);var _6b=dijit.byId("csrf_token_v").getValue();var _6c=dojo.clone(_69);_6c["csrf_token"]=_6b;return nox.ext.apps.vmanui.rawXhrPut({url:url,headers:{"content-type":"application/json","X-CSRF-Token":_6b},putData:dojo.toJson(_6c),timeout:3000000,error:function(_6d,_6e){_1.main.vmanui_error("Failed to modify group");}});};_2.modify_group_name=function(uid,_70,_71,_72){var d=_2.get_group(uid,_70);d.addCallback(function(g){g.name=_71;g.description=_72;return _2.put_group(uid,_70,g);});return d;};_2.create_empty_group=function(_75,_76,_77){var _78={"name":_76,"description":_77,"members":[]};return _1.vac_status.create_group(_75,_78);};_2.create_group=function(_79,_7a){var url="/ws.v1/group/"+_79;var _7c=dijit.byId("csrf_token_v").getValue();var _7d=dojo.clone(_7a);_7d["csrf_token"]=_7c;return nox.ext.apps.vmanui.rawXhrPost({url:url,headers:{"content-type":"application/json","X-CSRF-Token":_7c},postData:dojo.toJson(_7d),timeout:3000000,handleAs:"json",error:function(_7e,_7f){_1.main.vmanui_error("Failed to create group");}});};_2.delete_group=function(uid,_81){var url="/ws.v1/group/"+_81+"/"+encodeURIComponent(uid);var _83=dijit.byId("csrf_token_v").getValue();return nox.ext.apps.vmanui.xhrDelete({url:url,headers:{"content-type":"application/json","X-CSRF-Token":_83},timeout:3000000,error:function(_84,_85){if(_84.status==409){var _86=(_81=="nwaddr")?"address group":"VM group";_1.main.vmanui_error("This "+_86+" cannot be deleted "+" because it is currently being used in an ACL rule.");}else{_1.main.vmanui_error("Failed to remove group");}}});};_2.__lastAddedPoolProperties=null;_2.__lastAddedPoolPassword=null;_2.get_pool_property=function(_87,_88){var _89;dojo.forEach(_87.properties,function(_8a){if(_8a[0]==_88){_89=_8a[1];}});return _89;};_2.set_pool_property=function(_8b,_8c,_8d){var _8e=false;dojo.forEach(_8b.properties,function(_8f){if(_8f[0]==_8c){_8f[1]=_8d;_8e=true;}});if(!_8e){_8b.properties.push([_8c,_8d]);}};_2.retry_add_pool_with_steal=function(){if(_2.__lastAddedPoolProperties==null){return;}var _90=dojo.clone(_2.__lastAddedPoolProperties);_2.set_pool_property(_90,"steal_pool","true");_2.set_pool_property(_90,"password",_2.__lastAddedPoolPassword);_2.modify_pool(_90);};_2.add_pool=function(sIp,_92,_93,_94){var _95=_94?"true":"false";var _96=dijit.byId("csrf_token_v").getValue();_2.__lastAddedPoolPassword=_93;return nox.ext.apps.vmanui.rawXhrPost({url:"/ws.v1/datasource",headers:{"content-type":"application/json","X-CSRF-Token":_96},handleAs:"json",postData:dojo.toJson({type:"Xen",name:"",search_order:0,properties:[["master_address_1",sIp],["username",_92],["password",_93],["steal_pool",_95]],csrf_token:_96}),error:function(_97,_98){nox.ext.apps.vmanui.main.vmanui_error("Failed to add pool '"+ip+"'");},timeout:30000});};_2.modify_pool=function(_99){_2.__lastAddedPoolPassword=_2.get_pool_property(_99,"password");var _9a=dijit.byId("csrf_token_v").getValue();var _9b=dojo.clone(_99);_9b["csrf_token"]=_9a;return nox.ext.apps.vmanui.rawXhrPut({url:"/ws.v1/datasource/"+encodeURIComponent(_99.uid),headers:{"content-type":"application/json","X-CSRF-Token":_9a},handleAs:"json",timeout:30000,putData:dojo.toJson(_9b),error:function(_9c,_9d){var _9e=oPool.name||_2.get_pool_property(oPool,"master_address_1")||"";var _9f=_9e?" '"+_9e+"'":"";nox.ext.apps.vmanui.main.vmanui_error("Failed to modify pool"+_9f);}});};_2.remove_pool=function(uid){if(uid==_2.vlan_pool_id){_2.vlan_request.cancel();}var _a1=_1.main.current_tree_item;if((_a1.node_type==_1.vac.node_types.POOL)&&(_a1.datasource_id==uid)){_1.vac.show_vac_tab("status",_1.vac.node_types.ALL_POOLS.toString());}var _a2=dijit.byId("csrf_token_v").getValue();return nox.ext.apps.vmanui.xhrDelete({url:"/ws.v1/datasource/"+encodeURIComponent(uid),headers:{"content-type":"application/json","X-CSRF-Token":_a2},timeout:30000,error:function(_a3,_a4){nox.ext.apps.vmanui.main.vmanui_error("Failed to remove pool");}});};_2.confirm_remove_pool=function(_a5,_a6){var d=nox.ext.apps.vmanui.xhrGet({url:"/ws.v1/xen/pool_by_datasource/"+_a5,handleAs:"json",preventCache:true,load:function(_a8,_a9){var _aa=_a8.uid;var _ab=_a8.active;nox.ext.apps.vmanui.vac_status.find_fail_mode(_aa,function(_ac){frag.status.allpools.removeConfirmDialog.openDialog(_a6,_a5,(_ab>0&&_ac=="fail_safe"));});},error:function(_ad,_ae){nox.ext.apps.vmanui.main.vmanui_error("Failed to find pool");},timeout:30000});};_2.refresh_pool=function(uid){var d=nox.ext.apps.vmanui.xhrGet({url:"/ws.v1/datasource/"+uid,handleAs:"json",preventCache:true,timeout:30000,load:function(r){var _b2=r;_b2.refresh_status=true;_b2.properties=dojo.filter(_b2.properties,function(_b3){return _b3[0]=="master_address_1";});var d=_2.modify_pool(_b2);d.addCallback(nox.ext.apps.vmanui.vac_status.show_connect_status_dialog);}});};_2.start_modify_pool=function(uid,_b6){var d=nox.ext.apps.vmanui.xhrGet({url:"/ws.v1/datasource/"+uid,handleAs:"json",preventCache:true,load:function(_b8,_b9){var _ba=_b8;if(_b6){_2.set_pool_property(_b8,"steal_pool","true");}var dd=_2.get_pool_tree_item(uid);dd.addCallback(function(_bc){_ba.xapi_status=_bc.active;_2.show_pool_edit(_ba,null);});dd.addErrback(function(_bd){console.log(_bd);_2.show_pool_edit(_ba,null);});},error:function(_be,_bf){nox.ext.apps.vmanui.main.vmanui_error("Failed to find pool");},timeout:30000});};_2.show_pool_edit=function(_c0,_c1){var _c2=new nox.ext.apps.vmanui.dialog.pool_edit({pool_obj:_c0,error_str:_c1});_c2.show();};_2.get_pool_tree_item=function(_c3){return nox.ext.apps.vmanui.xhrGet({url:"/ws.v1/xen/pool_by_datasource/"+_c3,preventCache:true,handleAs:"json"});};_2.show_connect_status_dialog=function(_c4){_2.__lastAddedPoolProperties=_c4;var _c5=new nox.ext.apps.vmanui.dialog.pool_connect_status({pool_obj:_c4});_c5.show();};_2.fail_mode=null;_2.start_fail_mode_edit=function(){_1.main.editStarted();dijit.byId("fail_mode_submit_button").setAttribute("disabled",false);dijit.byId("fail_mode_cancel_button").setAttribute("disabled",false);};_2.get_fail_mode=function(){if(!_2.fail_mode){_2.init_fail_mode();}return _2.fail_mode;};_2.find_fail_mode=function(uid,_c7){if(!_c7){return;}if(uid=="all"){_1.vac.get_all_pool_nodes(function(_c8){var _c9=[];dojo.forEach(_c8,function(_ca){var _cb=_ca[1].uid;_c9.push(_1.xhrGet({url:"/ws.v1/xen_directory/"+_cb,preventCache:true,handleAs:"json"}));});var dl=new dojo.DeferredList(_c9);dl.addCallback(function(_cd){var _ce="fail_open";dojo.forEach(_cd,function(_cf){if(_cf[1].fail_mode){_ce="fail_safe";}});_c7(_ce);});});}else{_1.xhrGet({url:"/ws.v1/xen_directory/"+uid,preventCache:true,handleAs:"json",load:function(_d0){var _d1=_d0.fail_mode?"fail_safe":"fail_open";_c7(_d1);},error:function(_d2){_c7("fail_open");}});}};_2.init_fail_mode=function(){var _d3=nox.ext.apps.vmanui.User;if(_d3&&_d3.role()=="readonly"){dijit.byId("vac_status_fail_open_mode").disabled=true;dijit.byId("vac_status_fail_safe_mode").disabled=true;dojo.addClass(dojo.byId("fail_mode_buttons"),"hidden");}var _d4=_1.settings.get_controller_interface_obj();_d4.addCallback(function(_d5){dojo.forEach(_d5,function(_d6){if(_d6.dhcp){dijit.byId("vac_status_fail_open_mode").disabled=true;dijit.byId("vac_status_fail_safe_mode").disabled=true;dojo.removeClass("fail_mode_message","hidden");}});});var _d7=_1.main.current_tree_item.uid;var d=nox.ext.apps.vmanui.xhrGet({url:"/ws.v1/xen_directory/"+_d7,preventCache:true,handleAs:"json"});d.addCallback(function(_d9){var _da=(_d9.fail_mode==1)?"fail_safe":"fail_open";_2.fail_mode=_da;if(_da=="fail_safe"){dijit.byId("vac_status_fail_safe_mode").setValue(true);}else{dijit.byId("vac_status_fail_open_mode").setValue(true);}});};_2.set_fail_mode=function(_db){var _dc=_1.main.current_tree_item.uid;var _dd=dijit.byId("csrf_token_v").getValue();return nox.ext.apps.vmanui.rawXhrPut({url:"/ws.v1/xen_directory/"+_dc,headers:{"content-type":"application/json","X-CSRF-Token":_dd},handleAs:"json",putData:dojo.toJson({"fail_mode":(_db=="fail_safe")?1:0,"csrf_token":_dd}),load:function(_de){_2.fail_mode=_db;_1.main.editFinished();},error:function(_df,_e0){_1.main.vmanui_error("Could not save fail mode changes.",function(){_1.main.editFinished();_2.fail_mode_reset();});},timeout:30000});};_2.fail_mode_submit=function(){var _e1=(dijit.byId("vac_status_fail_open_mode").checked)?"fail_open":"fail_safe";_2.set_fail_mode(_e1);dijit.byId("fail_mode_submit_button").setAttribute("disabled",true);dijit.byId("fail_mode_cancel_button").setAttribute("disabled",true);};_2.fail_mode_reset=function(){dijit.byId("fail_mode_submit_button").setAttribute("disabled",true);dijit.byId("fail_mode_cancel_button").setAttribute("disabled",true);var _e2=_2.get_fail_mode();if(_e2=="fail_safe"){dijit.byId("vac_status_fail_safe_mode").setValue(true);}else{dijit.byId("vac_status_fail_open_mode").setValue(true);}_1.main.editFinished();};})();}