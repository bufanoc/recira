/* Copyright (c) 2008, 2009, 2010 Nicira, Inc. */

if(!dojo._hasResource["nox.ext.apps.vmanui.vac_visibility"]){dojo._hasResource["nox.ext.apps.vmanui.vac_visibility"]=true;dojo.provide("nox.ext.apps.vmanui.vac_visibility");dojo.require("nox.ext.apps.vmanui.main");dojo.require("nox.ext.apps.vmanui.vac");dojo.require("nox.ext.apps.vmanui.plotUtil");dojo.require("nox.ext.apps.vmanui.protoUtil");dojo.require("nox.ext.apps.vmanui.VisibilityTable");dojo.require("nox.ext.apps.vmanui.flowStatsManager");dojo.require("dojox.charting.Chart2D");dojo.require("dojox.charting.widget.Legend");(function(){var _1=nox.ext.apps.vmanui;var _2=_1.vac_visibility;var _3=_1.vac.node_types;_2.lastUpdateTs=0;_2.tableUpdating=false;_2.visibilityInputsPreset=false;_2.visibilityInputIds=["vis_counttype","vis_reverse","vis_count","vis_bintype","vis_direction","vis_timeInterval"];_2.chart=null;_2.visibility_init=function(_4,_5){nox.ext.apps.vmanui.main.set_document_subtitle("Flow Statistics");_2.poolsToWarn=[];var _6=false;this.check_pool_netflow();this.visibility_preset_inputs();if(!dijit.byId("visibility").isLoaded){dijit.byId("visibility").refresh();return false;}if(_4===undefined){_4=false;}if(_5===undefined){_5=false;}dojo.style(dojo.byId("visibility"),{display:"block"});if(dojo.byId("VisibilitySpan")===null){alert("thought this was dead");dijit.byId("visibility").refresh();return false;}if(_4||_5){_6=true;}else{if(_2.tableUpdating){return false;}var ts=(new Date()).getTime();interval=dijit.byId("vis_timeInterval").getValue()*0.01*1000;interval=Math.min(interval,600000);interval=interval-5000;if(ts-_2.lastUpdateTs<interval){return false;}}var _8=true;dojo.forEach(_2.visibilityInputIds,function(_9){var _a=dijit.byId(_9);var _b=_a.isValid();_8=_8&&_b;if(_b){dojo.cookie(_9,_a.attr("value"),{expires:30});}});if(!_8){return false;}_2.lastUpdateTs=(new Date()).getTime();var _c="/vmanui/visibility?table=1";var _d=_1.main.current_tree_item;if(_d){var _e=_1.vac.treestore.getValue(_d,"tree_uid");_c+="&tree_uid="+_e;}_2.start_chart(_6);return false;};_2.visibility_preset_inputs=function(){if(!_2.visibilityInputsPreset){var _f=false;dojo.forEach(_2.visibilityInputIds,function(sId){var _11=dojo.cookie(sId);if(_11!=undefined){var _12=dijit.byId(sId);if(_12){_12.attr("value",_11);}else{_f=true;}}});if(!_f){_2.visibilityInputsPreset=true;}}};_2.check_pool_netflow=function(){var _13=_1.main.current_tree_item;if(!_13){return;}var _14=_13.node_type;var _15=[];if(_14==_3.ALL_POOLS||_14==_3.ADMIN_GROUP||_14==_3.ADMIN_NET_GROUP){nox.ext.apps.vmanui.xhrGet({url:"/ws.v1/xen_directory",handleAs:"json",sync:true,timeout:30000,load:function(r){_15=r;}});}else{if(_14==_3.POOL){_15=[_13.uid];}else{var _17=_2.get_parent_pool_id_for_item(_13);if(_17){_15=[_17];}}}var _18=[];dojo.forEach(_15,function(_19){if(!_2.pool_flows_to_vman(_19)){_18.push(_19.toString());}});_2.poolsToWarn=_18;};_2.pool_flows_to_vman=function(_1a){var _1b=false;if(_1a){nox.ext.apps.vmanui.xhrGet({url:"/ws.v1/netflow/"+encodeURIComponent(_1a),handleAs:"json",timeout:30000,preventCache:true,sync:true,load:function(r){_1b=r.use_vmanager;},error:function(r){_1b=false;}});}return _1b;};_2.get_parent_pool_id_for_item=function(_1e){var bOK=false;var ct=0;var pt=_1.vac.parent_types;var _22=_1e.tree_uid;var _23=null;while(bOK==false&&ct<30){var _24=_22.split("_");var _25=_24[0];if(_25==_3.POOL){_23=_24[1];bOK=true;}else{_24[0]=pt[_25];_24.pop();_22=_24.join("_");}ct++;}if(bOK&&_23){return _23;}};_2.table_loading=function(sId){_2.set_table_opacity(sId,0.5);};_2.table_loaded=function(sId){_2.set_table_opacity(sId,1);};_2.set_table_opacity=function(sId,_29){var _2a=dojo.byId(sId);if(_2a){dojo._setOpacity(_2a,_29);}};_2.start_chart=function(_2b){var _2c=dijit.byId("visibility");if(_2c.pauseRefresh){return;}_2.tableUpdating=true;var _2d="VisibilityTableDiv";_2.table_loading(_2d);var _2e={};var _2f=_1.main.current_tree_item;_2e.tz=(new Date()).getTimezoneOffset()*-1;_2e.tree_uid=_1.vac.treestore.getValue(_2f,"tree_uid");_2e.direction=encodeURI(dijit.byId("vis_direction").getValue());_2e.bintype=encodeURI(dijit.byId("vis_bintype").getValue());_2e.counttype=encodeURI(dijit.byId("vis_counttype").getValue());_2e.count=encodeURI(dijit.byId("vis_count").getValue());_2e.reverse=encodeURI(dijit.byId("vis_reverse").getValue());try{var _30=null;dojo.xhrGet({url:"ws.v1/tree/node/"+_2e.tree_uid,handleAs:"json",sync:true,load:function(r){_30=r;}});if(_30){nt=_30.node_type;_2e.default_node_type=nt;}}catch(e){console.log("xhr error: ",e);_2e.default_node_type=null;}var _32=new Date();var _33=dijit.byId("vis_timeInterval").getValue();var _34=_32.getTime()-_33*1000;var _35=_32.getTime();_2e.start_epoch=parseInt(_34/1000);_2e.end_epoch=parseInt(_35/1000);var _36={plotTableContainerId:_2d,plotChartContainerId:"visplot",chartTab:"visibility",interval:_33};if(dojo.isIE){_1.main.pause_clicked(false);}if(_2b){if(nox.ext.apps.vmanui.vac_visibility.chart){nox.ext.apps.vmanui.vac_visibility.chart.destroy();nox.ext.apps.vmanui.vac_visibility.chart=null;}}var _37=new nox.ext.apps.vmanui.flowStatsManager(_2e,_36,nox.ext.apps.vmanui.vac_visibility.chart,nox.ext.apps.vmanui.vac_visibility.poolsToWarn);var d=_37.draw();d.addCallback(nox.ext.apps.vmanui.vac_visibility.finish_chart);d.addCallback(function(){_37=null;});};_2.finish_chart=function(_39){if(nox.ext.apps.vmanui.vac_visibility.visibility_table){nox.ext.apps.vmanui.vac_visibility.visibility_table.destroyRecursive();}nox.ext.apps.vmanui.vac_visibility.visibility_table=_39.table;if(!nox.ext.apps.vmanui.vac_visibility.chart&&_39.chart){nox.ext.apps.vmanui.vac_visibility.chart=_39.chart;}nox.ext.apps.vmanui.vac_visibility.tableUpdating=false;nox.ext.apps.vmanui.vac_visibility.table_loaded("VisibilityTableDiv");if(dojo.isIE){nox.ext.apps.vmanui.main.play_clicked(false);}_39=null;};})();}